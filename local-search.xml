<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ä½¿ç”¨Rollup,TypeScript,SCSSé…ç½®Reactç»„ä»¶åº“</title>
    <link href="/2023/01/03/%E4%BD%BF%E7%94%A8Rollup-TypeScript-SCSS%E9%85%8D%E7%BD%AEReact%E7%BB%84%E4%BB%B6%E5%BA%93/"/>
    <url>/2023/01/03/%E4%BD%BF%E7%94%A8Rollup-TypeScript-SCSS%E9%85%8D%E7%BD%AEReact%E7%BB%84%E4%BB%B6%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬ç¯‡ä¸ºç¿»è¯‘çš„æ–‡ç« ï¼Œç”±äºç¬”è€…èƒ½åŠ›æœ‰é™ï¼Œå€˜è‹¥é˜…è¯»ä½“éªŒä¸å¥½ï¼Œå¯ç‚¹å‡»åŸæ–‡åœ°å€æŸ¥çœ‹ï¼ŒåŸæ–‡åœ°å€ï¼š<a href="https://www.codefeetime.com/post/rollup-config-for-react-component-library-with-typescript-scss/">Rollup Config for React Component Library With TypeScript + SCSS</a></p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å°è¯•è¦†ç›–åœ¨æ„å»º<code>React</code>ç»„ä»¶åº“æ—¶ä½¿ç”¨<a href="https://rollupjs.org/guide/en/"><code>Rollup</code></a>é…ç½®å‘æŒ¥ä½œç”¨çš„å…³é”®é¢†åŸŸï¼ˆç‰¹åˆ«æ˜¯<code>TypeScript</code>å’Œ<code>SCSS</code>ï¼‰ã€‚</p><p>åŒæ—¶ï¼Œæˆ‘å°†ä¼šä¸ºä½¿ç”¨åˆ°çš„<a href="https://github.com/rollup/plugins"><code>Rollup</code>æ’ä»¶</a>å†™ä¸€äº›è¯´æ˜ï¼Œæ¥è¯´æ˜æ’ä»¶çš„ä½œç”¨ã€‚</p><p>æˆ‘ç»å¯¹ä¸æ˜¯<code>Rollup</code>çš„å¤§å¸ˆï¼Œä¹Ÿä¸æ˜¯æ„å»º<code>React</code>ç»„ä»¶åº“çš„æƒå¨æŒ‡å—ã€‚æˆ‘ä»…ä»…åªæ˜¯åˆ†äº«äº†ç”¨äºæ„å»ºæˆ‘è‡ªå·±çš„<code>React</code>ç»„ä»¶åº“ï¼ˆ<a href="https://github.com/DriLLFreAK100/codefee-kit">Codefee-Kit</a>ï¼‰æ—¶çš„<code>Rollup</code>é…ç½®ï¼Œè¿™åªæ˜¯æˆ‘è‡ªå·±çš„ä¸€ä¸ªç¬”è®°ï¼Œæˆ–è®¸èƒ½å¸®åˆ°ä¸€äº›äººã€‚</p><p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œç»„ä»¶åº“æ‰˜ç®¡åœ¨<a href="https://github.com/DriLLFreAK100/codefee-kit">Github</a>ä¸Š</p><h2 id="åŠ¨æœº"><a href="#åŠ¨æœº" class="headerlink" title="åŠ¨æœº"></a>åŠ¨æœº</h2><p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä½¿ç”¨<code>webpack</code>å»æ„å»ºåº“ã€‚å½“æ—¶ï¼Œæˆ‘åœ¨è·å¾—ç¬¬ä¸€ä¸ªå·¥ä½œç‰ˆæœ¬æ—¶é‡åˆ°äº†å¾ˆå¤šéº»çƒ¦ã€‚æˆ‘ä»ç„¶è®°å¾—æœ‰ä¸ªå±æ€§å«â€libraryâ€ï¼Œä¸ºäº†è®©<code>webpack</code>å¯¹åº“æ”¶é›†ä¿¡æ¯ï¼Œä½ éœ€è¦æ˜¾ç¤ºè®¾ç½®ã€‚æˆ‘å¾ˆå‚»ï¼Œåœ¨æˆ‘æ˜ç™½æ•´ä¸ªäº‹æƒ…ä¹‹å‰æˆ‘åœ¨è°·æ­Œä¸Šæœç´¢äº†å¾ˆå¤šä¿¡æ¯ã€‚åœ¨æ•´ä¸ªè¸©å‘è¿‡ç¨‹ä¸­æŠ•å…¥äº†å¤§é‡æ—¶é—´ã€‚æˆ‘å½“ç„¶ä¸å–œæ¬¢é‚£é‡Œçš„é…ç½®æ–‡ä»¶çš„å¤æ‚æ€§ã€‚å—¯ï¼Œæ˜¯è°ï¼Ÿå“ˆå“ˆå“ˆ</p><p>å°½ç®¡å¦‚æ­¤ï¼Œå½“æ—¶çš„å·¥ä½œç‰ˆæœ¬å¹¶æ²¡æœ‰å¾—åˆ°å¾ˆå¥½çš„ä¼˜åŒ–ã€‚æˆ‘çš„æ„æ€æ˜¯ï¼Œæ²¡æœ‰é…ç½®ä»»ä½•ä»£ç åˆ†å‰²ï¼Œæ„å»ºçš„è¾“å‡ºæ€»æ˜¯ä¸€ä¸ªè¶Šæ¥è¶Šå¤§çš„<code>index.js</code>æ–‡ä»¶</p><p>æœ€è¿‘ï¼Œæˆ‘ç»ˆäºåˆæœ‰äº†ä¸€äº›ç©ºé—²æ—¶é—´ï¼å› æ­¤ï¼Œæˆ‘å†³å®šé‡æ–°å®¡è§†è¿™ä¸ªè¯é¢˜ã€‚åœ¨<code>Webpack</code>ä¸­å¯¹å¦‚ä½•è¿›è¡Œä»£ç æ‹†åˆ†è¿›è¡Œäº†ä¸€äº›æ·±æŒ–ï¼Œæˆ‘åªæ˜¯è§‰å¾—å®ƒå¤ªéº»çƒ¦äº†ã€‚</p><p>æœ€åï¼Œæˆ‘å†³å®šå½»åº•åœæ­¢ï¼Œç„¶åè·³åˆ°å¦ä¸€ä¸ªæµè¡Œçš„æ„å»ºåº“çš„é€‰æ‹©â€”â€”<code>Rollup</code>ï¼è€Œä¸”ï¼Œå®ƒçš„é…ç½®ç®€å•å¾—å¤šï¼Œè€Œä¸”èŠ‚çœäº†æˆ‘å¾ˆå¤šæ—¶é—´ï¼å¤©å•Šï¼Œæˆ‘ä¸ºä»€ä¹ˆä¸æ—©ç‚¹è·³è¿‡å»ï¼Ÿï¼å»æˆ‘çš„ï¼</p><p>æœ‰ä¸€å¥è¯æ˜¯è¿™æ ·è¯´çš„ï¼Œâ€Rollup for libraries, Webpack for appsâ€ã€‚äº‹å®è¯æ˜ï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œå®ƒä»ç„¶éå¸¸é‡è¦ï¼</p><blockquote><p>â€œRollup for libraries, Webpack for appsâ€ <a href="https://medium.com/@PepsRyuu/why-i-use-rollup-and-not-webpack-e3ab163f4fd3">https:&#x2F;&#x2F;medium.com&#x2F;@PepsRyuu&#x2F;why-i-use-rollup-and-not-webpack-e3ab163f4fd3</a></p></blockquote><h2 id="ä¸»é¢˜èŒƒå›´"><a href="#ä¸»é¢˜èŒƒå›´" class="headerlink" title="ä¸»é¢˜èŒƒå›´"></a>ä¸»é¢˜èŒƒå›´</h2><p>è¯·è·³è½¬åˆ°ä½ æ„Ÿå…´è¶£çš„éƒ¨åˆ†</p><ol><li><a href="#rollup-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">Rollup é…ç½®æ–‡ä»¶</a></li><li><a href="#rollup-%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2">Rollup ä»£ç åˆ†å‰²</a></li><li><a href="#rollup-%E6%8F%92%E4%BB%B6%E8%AF%B4%E6%98%8E">Rollup æ’ä»¶è¯´æ˜</a></li></ol><h3 id="Rollup-é…ç½®æ–‡ä»¶"><a href="#Rollup-é…ç½®æ–‡ä»¶" class="headerlink" title="Rollup é…ç½®æ–‡ä»¶"></a>Rollup é…ç½®æ–‡ä»¶</h3><p>è¿™æ˜¯é€‚ç”¨äºæˆ‘çš„é…ç½®æ–‡ä»¶ã€‚é‚£é‡Œæœ‰ç›¸å½“å¤šçš„æ´»åŠ¨éƒ¨ä»¶ï¼Œä½†æˆ‘å°½å¯èƒ½åœ°æŠŠå®ƒæ¸…ç†å¹²å‡€ï¼Œè¿™æ ·å°±ä¸ä¼šå¤ªä¼¤çœ¼ç›äº†å“ˆå“ˆã€‚ã€‚ã€‚ğŸ˜›</p><p><strong>rollup.config.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> resolve <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@rollup/plugin-node-resolve&#x27;</span>;<br><span class="hljs-keyword">import</span> commonjs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@rollup/plugin-commonjs&#x27;</span>;<br><span class="hljs-keyword">import</span> typescript <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@rollup/plugin-typescript&#x27;</span>;<br><br><span class="hljs-keyword">import</span> postcss <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;rollup-plugin-postcss&quot;</span>;<br><span class="hljs-keyword">import</span> visualizer <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;rollup-plugin-visualizer&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; terser &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;rollup-plugin-terser&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; getFiles &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./scripts/buildUtils&#x27;</span>;<br><br><span class="hljs-keyword">const</span> extensions = [<span class="hljs-string">&#x27;.js&#x27;</span>, <span class="hljs-string">&#x27;.ts&#x27;</span>, <span class="hljs-string">&#x27;.jsx&#x27;</span>, <span class="hljs-string">&#x27;.tsx&#x27;</span>];<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-attr">input</span>: [<br>    <span class="hljs-string">&#x27;./src/index.ts&#x27;</span>,<br>    ...<span class="hljs-title function_">getFiles</span>(<span class="hljs-string">&#x27;./src/common&#x27;</span>, extensions),<br>    ...<span class="hljs-title function_">getFiles</span>(<span class="hljs-string">&#x27;./src/components&#x27;</span>, extensions),<br>    ...<span class="hljs-title function_">getFiles</span>(<span class="hljs-string">&#x27;./src/hooks&#x27;</span>, extensions),<br>    ...<span class="hljs-title function_">getFiles</span>(<span class="hljs-string">&#x27;./src/utils&#x27;</span>, extensions),<br>  ],<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">dir</span>: <span class="hljs-string">&#x27;dist&#x27;</span>,<br>    <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;esm&#x27;</span>,<br>    <span class="hljs-attr">preserveModules</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">preserveModulesRoot</span>: <span class="hljs-string">&#x27;src&#x27;</span>,<br>    <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,<br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-title function_">resolve</span>(),<br>    <span class="hljs-title function_">commonjs</span>(),<br>    <span class="hljs-title function_">typescript</span>(&#123;<br>      <span class="hljs-attr">tsconfig</span>: <span class="hljs-string">&#x27;./tsconfig.build.json&#x27;</span>,<br>      <span class="hljs-attr">declaration</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">declarationDir</span>: <span class="hljs-string">&#x27;dist&#x27;</span>,<br>    &#125;),<br>    <span class="hljs-title function_">postcss</span>(),<br>    <span class="hljs-title function_">terser</span>(),<br>    <span class="hljs-title function_">visualizer</span>(&#123;<br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;bundle-analysis.html&#x27;</span>,<br>      <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>,<br>    &#125;),<br>  ],<br>  <span class="hljs-attr">external</span>: [<span class="hljs-string">&#x27;react&#x27;</span>, <span class="hljs-string">&#x27;react-dom&#x27;</span>],<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œä¸ºäº†è®©<code>Rollup</code>å·¥ä½œï¼Œä½ ä»…ä»…åªéœ€è¦å¯¼å‡ºä¸€ä¸ª<code>JSON</code>å¯¹è±¡ã€‚å½“ç„¶ï¼Œå¦‚æœä½ æœ‰å¤šä¸ªé…ç½®éœ€è¦é…ç½®ï¼Œä½ ä¹Ÿèƒ½å¯¼å‡ºä¸€ä¸ªæ•°ç»„ã€‚ä¾‹å¦‚æ„å»ºä¸åŒçš„ç›®æ ‡æ–‡ä»¶æ—¶ï¼Œåƒ<code>umd</code>,<code>cjs</code>ç­‰</p><p>æˆ‘åœ¨è¿™é‡Œé…ç½®äº†4ä¸ªå±æ€§ï¼š</p><ul><li><code>input</code> - æ‰“åŒ…æ–‡ä»¶çš„å…¥å£ã€‚å¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²æ•°ç»„</li><li><code>output</code> - æ‰“åŒ…æ–‡ä»¶çš„è¾“å‡ºé…ç½®ï¼Œä¾‹å¦‚é…ç½®æ‰“åŒ…è¾“å‡ºçš„æ–‡ä»¶å¤¹ï¼Œé…ç½®<code>sourcemap</code>ç”Ÿæˆç­‰</li><li><code>plugins</code> - å¤–éƒ¨åŒ…è°ƒç”¨ï¼Œå¸®åŠ©æ“ä½œã€æ›´æ”¹æ„å»ºè¡Œä¸ºï¼Œä¾‹å¦‚<code>TypeScript, SCSS</code>ç­‰</li><li><code>external</code> - ä¸éœ€è¦æ‰“åŒ…è¿›æ„å»ºåŒ…ä¸­çš„åŒ…ï¼Œé€šå¸¸æ˜¯æŒ‡<code>peerDependencies</code>ä¸­è®¾ç½®çš„åŒ…ï¼Œåœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œï¼Œå°±æ˜¯<code>react</code>å’Œ<code>react-dom</code>ä¸¤ä¸ªåŒ…</li></ul><h4 id="TypeScript-é…ç½®"><a href="#TypeScript-é…ç½®" class="headerlink" title="TypeScript é…ç½®"></a>TypeScript é…ç½®</h4><p>ä»¥ä¸‹æ˜¯æˆ‘çš„<code>tsconfig</code>æ–‡ä»¶ã€‚æˆ‘æœ‰2ä¸ªï¼Œä¸€ä¸ªæ˜¯<code>Rollup</code>ç”¨äºæ„å»ºï¼Œå¦ä¸€ä¸ªç±»ä¼¼äºåŸºæœ¬é…ç½®ï¼Œä¸»è¦æ˜¯ç”¨äºå¼€å‘</p><p>èƒŒåçš„åŸå› æ˜¯ï¼Œæˆ‘æƒ³æ’é™¤æˆ‘çš„<a href="https://storybook.js.org/">Storybook stories files</a>è¢«<code>TypeScript</code>è½¬è¯‘ã€‚å®ƒåªç”¨äºå¼€å‘æ—¶ï¼Œæˆ‘éœ€è¦<code>tsconfig</code>ã€‚å› æ­¤ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¸¦æœ‰<code>excludes</code>çš„å•ç‹¬çš„é…ç½®æ–‡ä»¶</p><p><strong>tsconfig.build.json</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;extends&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./tsconfig.json&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;exclude&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;node_modules&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;build&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;dist&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;scripts&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;acceptance-tests&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;webpack&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;jest&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;src/stories/**&quot;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>tsconfig.json</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;esnext&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;target&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;es5&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;lib&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-string">&quot;es6&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;dom&quot;</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;sourceMap&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;jsx&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;react&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;moduleResolution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;rootDir&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;src&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;noImplicitReturns&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;noImplicitThis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;noImplicitAny&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;strictNullChecks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;esModuleInterop&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;baseUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;src/&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;common&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;src/common/*&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;components&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;src/components/*&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;hooks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;src/hooks/*&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;utils&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;src/utils/*&quot;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;exclude&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;node_modules&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;build&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;dist&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;scripts&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;acceptance-tests&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;webpack&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;jest&quot;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;types&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;typePatches&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="Rollup-ä»£ç åˆ†å‰²"><a href="#Rollup-ä»£ç åˆ†å‰²" class="headerlink" title="Rollup ä»£ç åˆ†å‰²"></a>Rollup ä»£ç åˆ†å‰²</h3><p>åœ¨ä¸Šé¢çš„é…ç½®ä¸­ï¼Œæˆ‘å®é™…ä¸Šä½¿ç”¨äº†Rollupçš„<a href="https://rollupjs.org/guide/en/#code-splitting">ä»£ç åˆ†å‰² (code-splitting) </a>åŠŸèƒ½ã€‚</p><p>å¦‚æœæ‚¨æ³¨æ„åˆ°ï¼Œæˆ‘å¯¼å‡ºçš„<code>JSON</code>å¯¹è±¡ä¸­çš„<code>input</code>å±æ€§å®é™…ä¸Šæ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œè€Œä¸æ˜¯å•ä¸ªå­—ç¬¦ä¸²ã€‚è¿™å®é™…ä¸Šå‘Šè¯‰<code>Rollup</code>å°†è¿™äº›å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸€ä¸ªä½œä¸ºæ„å»ºçš„å•ç‹¬å…¥å£ç‚¹ã€‚æ‰€ä»¥ï¼Œè¿™å°±æ˜¯ä»£ç åˆ†å‰²æ„å»ºã€‚</p><p>æ•°ç»„ä¸­çš„æ‰€æœ‰è¿™äº›å­—ç¬¦ä¸²å®é™…ä¸Šæ˜¯æˆ‘åœ¨<code>src</code>æ–‡ä»¶å¤¹ä¸­æ‹¥æœ‰çš„å•ä¸ª<code>.ts</code>å’Œ<code>.tsx</code>æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ã€‚<code>getFiles</code>æ–¹æ³•æ˜¯æˆ‘ç¼–å†™çš„ä¸€ä¸ªå®ç”¨æ–¹æ³•ï¼Œå®ƒå¸®åŠ©æˆ‘æ·±å…¥æ£€ç´¢æ‰€æœ‰æ‰©å±•åä¸º<code>.jsã€.jsxã€.ts</code>å’Œ<code>.tsx</code>çš„æ–‡ä»¶ã€‚</p><p>ä¸‹é¢æ˜¯<a href="https://github.com/DriLLFreAK100/codefee-kit/blob/main/scripts/buildUtils.js"><code>getFiles</code></a>æ–¹æ³•çš„ä»£ç :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getFiles</span> = (<span class="hljs-params">entry, extensions = [], excludeExtensions = []</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> fileNames = [];<br>  <span class="hljs-keyword">const</span> dirs = fs.<span class="hljs-title function_">readdirSync</span>(entry);<br><br>  dirs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">dir</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> path = <span class="hljs-string">`<span class="hljs-subst">$&#123;entry&#125;</span>/<span class="hljs-subst">$&#123;dir&#125;</span>`</span>;<br><br>    <span class="hljs-keyword">if</span> (fs.<span class="hljs-title function_">lstatSync</span>(path).<span class="hljs-title function_">isDirectory</span>()) &#123;<br>      fileNames = [<br>        ...fileNames,<br>        ...<span class="hljs-title function_">getFiles</span>(path, extensions, excludeExtensions),<br>      ];<br><br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!excludeExtensions.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">exclude</span>) =&gt;</span> dir.<span class="hljs-title function_">endsWith</span>(exclude))<br>      &amp;&amp; extensions.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">ext</span>) =&gt;</span> dir.<span class="hljs-title function_">endsWith</span>(ext))<br>    ) &#123;<br>      fileNames.<span class="hljs-title function_">push</span>(path);<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> fileNames;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="Rollup-æ’ä»¶è¯´æ˜"><a href="#Rollup-æ’ä»¶è¯´æ˜" class="headerlink" title="Rollup æ’ä»¶è¯´æ˜"></a>Rollup æ’ä»¶è¯´æ˜</h3><p>ä»¥ä¸‹æ˜¯æˆ‘åœ¨ä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ’ä»¶ï¼Œä»¥åŠä½¿ç”¨å®ƒä»¬åæˆ‘çš„ä¸€äº›è§£é‡Šå’Œç†è§£ã€‚</p><p><a href="https://www.npmjs.com/package/@rollup/plugin-node-resolve">@rollup&#x2F;plugin-node-resolve</a> </p><p>å¯¹äº<code>Rollup</code>ï¼Œåœ¨<code>node_modules</code>ä¸­æŸ¥æ‰¾å’Œæ†ç»‘ç¬¬ä¸‰æ–¹ä¾èµ–é¡¹ã€‚è¿™é‡Œæ‰€æŒ‡çš„ä¾èµ–å…³ç³»æ˜¯<code>package.json</code>æ–‡ä»¶ä¸­åˆ—å‡ºçš„ä¾èµ–å…³ç³»(<code>dependencies</code>)ã€‚</p><p><a href="https://www.npmjs.com/package/@rollup/plugin-commonjs">@rollup&#x2F;plugin-commonjs</a> </p><p>å¯¹äº<code>Rollup</code>ï¼Œå°†<code>CommonJS</code>æ¨¡å—è½¬æ¢ä¸º<code>ES6</code>ï¼Œä»¥ä¾¿å°†å…¶åŒ…å«åœ¨<code>Rollup</code>æ†ç»‘åŒ…ä¸­ã€‚å®ƒé€šå¸¸ä¸<code>@rollup/plugin-node-resolve</code> ä¸€èµ·ä½¿ç”¨ï¼Œä»¥æ†ç»‘<code>CommonJS</code>ä¾èµ–é¡¹ã€‚</p><p><a href="https://www.npmjs.com/package/@rollup/plugin-typescript">@rollup&#x2F;plugin-typescript</a> </p><p>å¸®åŠ©ä»¥æ›´ç®€å•çš„æ–¹å¼ä¸<code>TypeScript</code>é›†æˆã€‚åŒ…æ‹¬å°†<code>TypeScript</code>è½¬æ¢ä¸º<code>JavaScript</code>ç­‰å†…å®¹ã€‚</p><p><a href="https://www.npmjs.com/package/rollup-plugin-postcss">rollup-plugin-postcss</a></p><p>ä¸<code>PostCSS</code>é›†æˆã€‚å¯¹äºæˆ‘çš„ç”¨ä¾‹ï¼Œå®ƒæœ‰åŠ©äºå°†<code>CSS</code>å’Œ<code>SCSS</code>æ–‡ä»¶åˆ†åˆ«æ„å»ºä¸º<code>*.CSS.js</code>å’Œ<code>*.SCSS.js</code>æ–‡ä»¶ã€‚ç„¶åï¼Œå½“å¯¼å…¥ç›¸åº”çš„ç»„ä»¶æ—¶ï¼Œè¿™äº›æ–‡ä»¶ä¼šç›¸åº”åœ°æ³¨å…¥<code>HTML head</code>æ ‡ç­¾ï¼ˆä¾èµ–äº<a href="https://www.npmjs.com/package/style-inject">style-inject</a>ï¼‰</p><blockquote><p>åœ¨æˆ‘ç›®å‰çš„å¼€å‘ä¸­ï¼Œæˆ‘å·²ç»æ”¹ç”¨æ ·å¼åŒ–ç»„ä»¶ï¼Œè€Œå€¾å‘äºåœ¨<code>JS</code>æ¨¡å¼ä¸­å°è¯•<code>CSS</code>ã€‚</p></blockquote><p><a href="https://www.npmjs.com/package/rollup-plugin-visualizer">rollup-plugin-visualizer</a></p><p>æ­¤æ’ä»¶ç”¨äºå¸®åŠ©æˆ‘ä»¬åˆ†ææ†ç»‘è¾“å‡ºã€‚å®ƒå°†ä¸ºæˆ‘ä»¬çš„æ£€æŸ¥ç”Ÿæˆä¸€ä¸ªå¾ˆé…·çš„å¯è§†åŒ–ã€‚åœ¨è¿›è¡Œæ†ç»‘åŒ…å¤§å°ä¼˜åŒ–æ—¶ï¼Œå®ƒç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥è®©æˆ‘ä»¬å¯è§†åŒ–æ†ç»‘åŒ…æ–‡ä»¶çš„å„ä¸ªå¤§å°ã€‚</p><p><a href="https://www.npmjs.com/package/rollup-plugin-terser">rollup-plugin-terser</a></p><p>å®ƒåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªæ’ä»¶ï¼Œç”¨äºé›†æˆ<a href="https://www.npmjs.com/package/terser">terser</a>çš„ç”¨æ³•ã€‚å®ƒæœ‰åŠ©äºç¼©å°å’Œå‹ç¼©æˆ‘ä»¬çš„è¾“å‡º<code>JavaScript</code>æ–‡ä»¶ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨ä½¿ç”¨<code>Rollup</code>å’Œ<code>Webpack</code>æ„å»ºä½¿ç”¨<code>TypeScript</code>å’Œ<code>SCSS</code>çš„<code>React</code>ç»„ä»¶åº“ä¹‹åã€‚ã€‚ã€‚æˆ‘ä¸å¾—ä¸è¯´ï¼Œåªæ˜¯ä¸ºäº†è¿™ä¸ªç›®çš„è€Œç–¯ç‹‚åœ°ä½¿ç”¨<code>Rollup</code>ã€‚ä¸<code>Webpack</code>ç›¸æ¯”ï¼Œå®ƒæ›´æ˜“äºé…ç½®ã€‚</p><p>å•æ˜¯é…ç½®çš„å¤æ‚æ€§å°±è¶³ä»¥è®©æˆ‘è·³è¿‡å»ã€‚æˆ‘å¸Œæœ›æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ç‚¹è½»æ¾æ¨ç†ï¼Œè€Œä¸æ˜¯ä¸€äº›å†—é•¿å¤æ‚çš„ä¸œè¥¿ï¼Œæˆ‘å¯èƒ½ä¼šåœ¨å‡ å‘¨å†…å¿˜è®°æ­£åœ¨åšä»€ä¹ˆï¼</p><p>ç„¶è€Œï¼Œæˆ‘å¯èƒ½ä¸ä¸€å®šå¯¹åº”ç”¨ç¨‹åºå¼€å‘æœ‰åŒæ ·çš„æ„Ÿè§‰ï¼Œå› ä¸º<code>Webpack</code>å…·æœ‰çœŸæ­£å¼ºå¤§çš„çƒ­æ¨¡å—æ›¿æ¢åŠŸèƒ½ã€‚è¿™ç»å¯¹æ˜¯ä¸€ä¸ªæ•‘å‘½ç¨»è‰ï¼Œä¹Ÿæ˜¯åº”ç”¨ç¨‹åºå¼€å‘çš„å¿…å¤‡å·¥å…·ã€‚</p><p>æ„å»ºå·¥å…·çš„å‰æ™¯æ­£åœ¨å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœç¬¬äºŒå¤©å‡ºç°å¦ä¸€ä¸ªäº‹å®ä¸Šçš„<code>bundler</code>ï¼Œå¹¶åœ¨ç¤¾åŒºä¸­æ€èµ·é£æš´ï¼Œè¿™å¯èƒ½å¹¶ä¸å¥‡æ€ªï¼ä½†è‡³å°‘ç°åœ¨ï¼Œ<code>Rollup</code>æ˜¯æˆ‘çš„æ–°æƒ…äººğŸ˜›</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://github.com/rollup/plugins">https://github.com/rollup/plugins</a></li><li><a href="https://rollupjs.org/guide/en/">https://rollupjs.org/guide/en/</a></li><li><a href="https://marcobotto.com/blog/compiling-and-bundling-typescript-libraries-with-webpack/">https://marcobotto.com/blog/compiling-and-bundling-typescript-libraries-with-webpack/</a></li><li><a href="https://github.com/HarveyD/react-component-library">https://github.com/HarveyD/react-component-library</a></li><li><a href="https://github.com/rollup/rollup-plugin-commonjs">https://github.com/rollup/rollup-plugin-commonjs</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>typescript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>typescript</tag>
      
      <tag>rollup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨puppeteerè·å–ç½‘é¡µä¿¡æ¯</title>
    <link href="/2022/11/19/%E4%BD%BF%E7%94%A8puppeteer%E8%8E%B7%E5%8F%96%E7%BD%91%E9%A1%B5%E4%BF%A1%E6%81%AF/"/>
    <url>/2022/11/19/%E4%BD%BF%E7%94%A8puppeteer%E8%8E%B7%E5%8F%96%E7%BD%91%E9%A1%B5%E4%BF%A1%E6%81%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>Puppeteer</code>çš„ä¸­æ–‡ç›´è¯‘æ˜¯<code>æ“çºµæœ¨å¶çš„äºº</code>ï¼Œæ˜¯ä¸€ä¸ªæä¾›é¡¶å±‚<code>API</code>æ¥æ§åˆ¶åŸºäº<code>DevTools Protocol</code>çš„<code>Chrome/Chromium</code>çš„<code>Node</code>åº“ã€‚é»˜è®¤ï¼Œå®ƒæ˜¯è¿è¡Œåœ¨<code>Chrome/Chromium</code>çš„<code>headless</code>æ¨¡å¼ä¸‹ï¼Œä½†æ˜¯ä¹Ÿèƒ½æ”¹å˜å®ƒçš„é…ç½®ï¼Œä½¿å…¶è¿è¡Œåœ¨<code>full(non-headless)</code>æ¨¡å¼ä¸‹ã€‚</p><p>æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼Œ<code>Puppeteer</code>å°±æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨<code>Node</code>ç¯å¢ƒçš„æµè§ˆå™¨</p><p><code>Puppeteer</code>ä¸ºæˆ‘ä»¬æä¾›äº†ä¸°å¯Œçš„èƒ½åŠ›ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š</p><ul><li>ä¸ºé¡µé¢ç”Ÿæˆæˆªå›¾æˆ–è€…<code>PDF</code>æ–‡ä»¶</li><li>çˆ¬å–<code>SPA(Single-Page Application)</code>æˆ–è€…<code>SSR(Sever-Side Rendering)</code></li><li>è‡ªåŠ¨è¡¨å•æäº¤ï¼Œ<code>UI</code>æµ‹è¯•ï¼Œé”®ç›˜è¾“å…¥ç­‰</li><li>ä½¿ç”¨æœ€æ–°çš„<code>JavaScript</code>å’Œæµè§ˆå™¨ç‰¹æ€§åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–çš„æµ‹è¯•ç¯å¢ƒ</li><li>æ•è·ç½‘é¡µçš„<code>timeline trace</code>ï¼Œå¸®åŠ©è¯Šæ–­æ€§èƒ½é—®é¢˜</li><li>æµ‹è¯•<code>Chrome</code>æ’ä»¶</li></ul><p>è€Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä»‹ç»ä¸Šé¢åˆ—å‡ºçš„ç¬¬äºŒç‚¹ï¼ŒæŠ“å–é¡µé¢æ•°æ®</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul><li>é¦–å…ˆæ–°å»ºä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹å«<code>puppeteer-crawl-page-example</code>å¹¶åˆå§‹åŒ–é¡¹ç›®</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> puppeteer-crawl-page-example<br><span class="hljs-built_in">cd</span> puppeteer-crawl-page-example &amp;&amp; yarn init -y<br></code></pre></td></tr></table></figure><ul><li>æ·»åŠ <code>typescript</code>ï¼ˆå½“ç„¶å¦‚æœä½ æ›´å–œæ¬¢ç›´æ¥ä½¿ç”¨<code>javascript</code>ç¼–å†™é¡¹ç›®ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡å…³äº<code>typescript</code>çš„é…ç½®ä»‹ç»å³å¯ï¼‰</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yarn add typescript ts-node nodemon --dev<br></code></pre></td></tr></table></figure><blockquote><p><code>ts-node</code>æ˜¯ä¸ºäº†åŠ¨æ€ç¼–è¯‘<code>ts</code>æ–‡ä»¶ä¸º<code>js</code>æ–‡ä»¶ï¼Œ<code>nodemon</code>åˆ™æ˜¯ä¸ºäº†ç›‘å¬ç¼–è¯‘åçš„<code>js</code>æ–‡ä»¶æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œä»è€Œå†³å®šæ˜¯å¦é‡å¯é¡¹ç›®</p></blockquote><ul><li><p>åœ¨<code>package.json</code>ä¸­æ·»åŠ è¿è¡Œå‘½ä»¤ï¼Œå…¶ä¸­<code>index.ts</code>æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œæ˜¯æˆ‘ä»¬ç¼–å†™ä»£ç çš„åœ°æ–¹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-comment">// çœç•¥éƒ¨åˆ†ä»£ç </span><br>  <span class="hljs-attr">&quot;script&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;start&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nodemon --watch . --exec \&quot;ts-node\&quot; index.ts&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>å®‰è£…<code>Puppeteer</code>ï¼Œå½“æˆ‘ä»¬å®‰è£…çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªåŠ¨å®‰è£…ä¸€ä¸ªæœ€æ–°ç‰ˆçš„<code>Chromium</code>ï¼Œä»¥ä¿è¯<code>Puppeteer</code>èƒ½æ­£å¸¸çš„å·¥ä½œï¼Œæ‰€ä»¥å¯¹äºæ— æ³•å®‰è£…çš„ï¼Œå¯èƒ½éœ€è¦å€ŸåŠ©ç§‘å­¦ä¸Šç½‘å·¥å…·ï¼Œå½“ç„¶ä¹Ÿæœ‰å…¶ä»–è§£å†³æ–¹å¼å°±è‡ªè¡Œç™¾åº¦å•¦</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yarn add puppeteer<br></code></pre></td></tr></table></figure><ul><li>å®‰è£…æˆåŠŸåï¼Œåœ¨<code>index.ts</code>æ–‡ä»¶ä¸­ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆå¯åŠ¨<code>(launch)</code>ä¸€ä¸ªæµè§ˆå™¨å®ä¾‹<code>(Browser)</code>ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨<code>Puppeteer</code>çš„<code>launch()</code>æ–¹æ³•åˆ›å»ºä¸€ä¸ª<code>Browser</code>å¯¹è±¡</li></ul><blockquote><p><code>Puppeteer</code>çš„<code>API</code>éƒ½æ˜¯<code>Promise</code>ç±»å‹</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript">(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// å¯åŠ¨ä¸€ä¸ªæµè§ˆå™¨, launchæ¥æ”¶ä¸€ä¸ªoptionsç”¨äºé…ç½®ä¿¡æ¯</span><br>  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> puppeteer.<span class="hljs-title function_">launch</span>(&#123;<br>    <span class="hljs-comment">// æ˜¯å¦åœ¨headlessæ¨¡å¼ä¸‹è¿è¡Œæµè§ˆå™¨</span><br>    <span class="hljs-attr">headless</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-comment">// æ˜¯å¦æ‰“å¼€Devtool,å¦‚æœè®¾ç½®ä¸ºtrueï¼Œheadlesså°†å¼ºåˆ¶ä¸ºfalse</span><br>    <span class="hljs-attr">devtools</span>: <span class="hljs-literal">true</span>,<br>  &#125;);<br><br>  <span class="hljs-comment">// åœ¨browserä¸Šä¸‹æ–‡ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªPageå¯¹è±¡</span><br>  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newPage</span>();<br><br>  <span class="hljs-comment">// å…³é—­Chromiumå’Œæ‰€æœ‰çš„Page</span><br>  <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">close</span>();<br>&#125;());<br></code></pre></td></tr></table></figure><ul><li>å¯åŠ¨é¡¹ç›®<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yarn run start<br></code></pre></td></tr></table></figure>å½“çœ‹åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼Œåˆ™è¯´æ˜é¡¹ç›®å¯åŠ¨æˆåŠŸï¼Œå¹¶ä¸”ä½ ä¼šçœ‹åˆ°æ‰“å¼€äº†æµè§ˆå™¨ï¼Œå¹¶ä¸”é©¬ä¸Šå…³é—­äº†<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ nodemon --watch . --exec <span class="hljs-string">&quot;ts-node&quot;</span> index.ts<br>[nodemon] <span class="hljs-number">2.0</span>.<span class="hljs-number">20</span><br>[nodemon] to restart at any time, enter `rs`<br>[nodemon] watching path(s): *.*<br>[nodemon] watching extensions: ts,json<br>[nodemon] starting `ts-node index.ts`<br>[nodemon] clean <span class="hljs-keyword">exit</span> - waiting <span class="hljs-keyword">for</span> changes before restart<br></code></pre></td></tr></table></figure></li></ul><h2 id="å°è¯•ç‰›åˆ€"><a href="#å°è¯•ç‰›åˆ€" class="headerlink" title="å°è¯•ç‰›åˆ€"></a>å°è¯•ç‰›åˆ€</h2><p>æˆ‘ä»¬å…ˆæ¥å†™ä¸ªç®€å•çš„æˆªå›¾åŠŸèƒ½ï¼Œä¸»è¦æ˜¯ä½¿ç”¨<code>Page</code>å®ä¾‹ä¸Šçš„<code>screenshot()</code>æ–¹æ³•</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// åŠ è½½é¡µé¢</span><br><span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">&#x27;https://blog.csdn.net/qq_45484646?type=blog&#x27;</span>, &#123;<br>  <span class="hljs-comment">// è¶…æ—¶æ—¶é—´ï¼Œ0ä¸ºç¦ç”¨è¶…æ—¶</span><br>  <span class="hljs-comment">// timeout: 0,</span><br>&#125;)<br><br><span class="hljs-comment">// å¯¹å½“å‰é¡µé¢è¿›è¡Œæˆªå›¾</span><br><span class="hljs-keyword">await</span> page.<span class="hljs-title function_">screenshot</span>(&#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;png&#x27;</span>,<br>  <span class="hljs-comment">// ä¿å­˜æ–‡ä»¶çš„è·¯å¾„</span><br>  <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;screenshot.png&#x27;</span>,<br>  <span class="hljs-comment">// æˆªå–æ•´ä¸ªå¯æ»šåŠ¨é¡µé¢çš„å±å¹•æˆªå›¾</span><br>  <span class="hljs-comment">// fullPage: true</span><br>&#125;);<br><br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æŸåï¼Œä½ ä¼šçœ‹åˆ°åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹å¤šäº†ä¸ª<code>screenshot.png</code>æ–‡ä»¶ï¼Œç‚¹å¼€ä½ ä¼šå‘ç°å’Œæˆ‘ä»¬åœ¨æ­£å¸¸çš„æµè§ˆå™¨ä¸­è¾“å…¥çš„é“¾æ¥åŠ è½½å‡ºæ¥çš„é¡µé¢æ˜¯ä¸€æ¨¡ä¸€æ ·ï¼Œæ˜¯ä¸æ˜¯æ„Ÿå—åˆ°äº†<code>Puppeteer</code>çš„å¼ºå¤§ğŸš€</p><h2 id="å¤§æ˜¾ç¥é€š"><a href="#å¤§æ˜¾ç¥é€š" class="headerlink" title="å¤§æ˜¾ç¥é€š"></a>å¤§æ˜¾ç¥é€š</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Puppeteer</code>æ¥æŠ“å–é¡µé¢ä¿¡æ¯ï¼Œä½†åœ¨æŠ“å–é¡µé¢ä¹‹å‰æˆ‘ä»¬éœ€è¦çŸ¥é“è¦æŠ“å–çš„å†…å®¹çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯¥æ€ä¹ˆè®¿é—®è¿™äº›å…ƒç´ ã€‚<br><img src="/2022/11/19/%E4%BD%BF%E7%94%A8puppeteer%E8%8E%B7%E5%8F%96%E7%BD%91%E9%A1%B5%E4%BF%A1%E6%81%AF/79131668853921_.pic.jpg" alt="é¡µé¢å…ƒç´ åˆ†æ"></p><p>æˆ‘ä»¬éœ€è¦è·å–æ•´ä¸ªæ–‡ç« åˆ—è¡¨(ä¹Ÿå°±æ˜¯<code>&lt;div class=&quot;mainContent&quot;&gt;&lt;/div&gt;</code>ä¸­çš„<code>article</code>æ ‡ç­¾ä¸­çš„å†…å®¹)ï¼Œå¹¶è·å–æ¯ä¸ªæ–‡ç« çš„<code>title, description</code>å’Œé˜…è¯»æ•°ã€‚</p><p>æ•´ä¸ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// åŠ è½½é¡µé¢</span><br><span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">&#x27;https://blog.csdn.net/qq_45484646?type=blog&#x27;</span>, &#123;<br>  <span class="hljs-comment">// è¶…æ—¶æ—¶é—´ï¼Œ0ä¸ºç¦ç”¨è¶…æ—¶</span><br>  <span class="hljs-comment">// timeout: 0,</span><br>&#125;);<br><br><span class="hljs-comment">// ç›¸å½“äºæµè§ˆå™¨ä¸­çš„document.querySelectorAllï¼Œä½†æ˜¯è¿”å›çš„æ˜¯ ElementHandle ç±»å‹</span><br><span class="hljs-keyword">const</span> articles = <span class="hljs-keyword">await</span> page.$$(<span class="hljs-string">&#x27;.mainContent article a&#x27;</span>);<br><span class="hljs-comment">// ç”¨äºä¿å­˜ä¸€ç»„Promiseï¼Œæ–¹ä¾¿Promise.allç›´æ¥å¤„ç†</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">collects</span>: <span class="hljs-built_in">any</span>[] = [];<br><br><span class="hljs-comment">// è·å–æ–‡ç« ä¿¡æ¯</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> article <span class="hljs-keyword">of</span> articles) &#123;    <br>  <span class="hljs-comment">// evaluate()ï¼Œå¯¹Pageä¸Šä¸‹æ–‡è¿›è¡Œè®¡ç®—ï¼Œå¹¶è¿”å›ä¸€ä¸ªå€¼</span><br>  collects.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-function"><span class="hljs-params">article</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// è¿™é‡Œçš„ä»£ç æ˜¯æ”¾åˆ°Page ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ˜¯ä¸èƒ½è®¿é—®å¤–éƒ¨çš„ä½œç”¨åŸŸï¼ˆä¹Ÿå°±æ˜¯Nodeç¯å¢ƒï¼‰</span><br><br>    <span class="hljs-comment">// è·å–æ–‡ç« æ ‡é¢˜èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">const</span> title = article.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;h4&#x27;</span>);<br>    <span class="hljs-comment">// è·å–æ–‡ç« æè¿°èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">const</span> description = article.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.blog-list-content&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLDivElement</span>;<br>    <span class="hljs-comment">// è·å–æ–‡ç« é˜…è¯»æ•°èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">const</span> readNum = article.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.blog-list-footer .view-num&#x27;</span>);<br><br>    <span class="hljs-comment">// æå–æˆ‘ä»¬éœ€è¦çš„æ–‡ç« ä¿¡æ¯</span><br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">title</span>: title?.<span class="hljs-property">innerText</span>, <br>      <span class="hljs-attr">description</span>: description?.<span class="hljs-property">innerText</span>, <br>      <span class="hljs-attr">readNum</span>: readNum?.<span class="hljs-property">childNodes</span>[<span class="hljs-number">0</span>].<span class="hljs-property">textContent</span>,<br>    &#125;;<br>  &#125;, article));<br>&#125;<br><br><span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰æ•°æ®æˆåŠŸè¿”å›</span><br><span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(collects);<br><br><span class="hljs-comment">// è¾“å‡ºè·å–çš„æ•°æ®åˆ°æ§åˆ¶å°</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;[Data]\t&#x27;</span>, data);<br><br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºäº†æˆ‘ä»¬æƒ³è¦çš„ç»“æœ</p><p><img src="/2022/11/19/%E4%BD%BF%E7%94%A8puppeteer%E8%8E%B7%E5%8F%96%E7%BD%91%E9%A1%B5%E4%BF%A1%E6%81%AF/WeChat473375ab8df6ba9c3a2bb6419437eef2.png"></p><p>ğŸ‰æ­å–œï¼Œåˆ°æ­¤ä¸ºæ­¢æœ¬ç¯‡æ•™ç¨‹å°±å·²ç»“æŸ</p><blockquote><p>è·å–å®Œæ•´ä»£ç  <a href="https://github.com/yxlazy/puppeteer-crawl-page-example">https://github.com/yxlazy/puppeteer-crawl-page-example</a></p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç°åœ¨æˆ‘ä»¬æ¥åšä¸ªç®€å•çš„æ€»ç»“ï¼Œé¦–å…ˆæˆ‘ä»¬ç®€å•ä»‹ç»äº†<code>Puppeteer</code>æ˜¯ä»€ä¹ˆï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨<code>Node</code>ç¯å¢ƒä¸‹çš„æµè§ˆå™¨ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸°å¯Œçš„èƒ½åŠ›ï¼Œä¾‹å¦‚ä¸ºé¡µé¢æˆªå›¾ç­‰ï¼Œç„¶ååœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡ä»‹ç»å¦‚ä½•æŠ“å–é¡µé¢çš„æ•°æ®ä»è€Œç®€å•çš„æ„Ÿå—äº†<code>Puppeteer</code>å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://pptr.dev/">https://pptr.dev/</a></p>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>puppeteer</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é—®ï¼šå¦‚ä½•è·å–æ–‡æœ¬å†…å®¹å¹¶æ˜¾ç¤ºåœ¨å‰ç«¯é¡µé¢ğŸ¤”</title>
    <link href="/2022/11/04/%E9%97%AE%EF%BC%9A%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%96%87%E6%9C%AC%E5%86%85%E5%AE%B9%E5%B9%B6%E6%98%BE%E7%A4%BA%E5%9C%A8%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%F0%9F%A4%94/"/>
    <url>/2022/11/04/%E9%97%AE%EF%BC%9A%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%96%87%E6%9C%AC%E5%86%85%E5%AE%B9%E5%B9%B6%E6%98%BE%E7%A4%BA%E5%9C%A8%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%F0%9F%A4%94/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»Šå¤©åœ¨æ°´å‹ç¾¤é‡Œçœ‹åˆ°æœ‰ä¸ªå‰ç«¯å°ä¼™ä¼´åœ¨ç¾¤é‡Œå‘äº†ä¸ªé—®é¢˜ï¼Œâ€œåç«¯ç»™æˆ‘è¿”äº†<code>.txt</code>æ–‡æœ¬çš„åœ°å€ï¼Œæˆ‘æ€ä¹ˆé€šè¿‡è¿™ä¸ªåœ°å€è·å–æ–‡æœ¬å†…å®¹æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šå‘€â€ï¼Œæ¥ç€åé¢çš„ç¾¤å‹çš„å›ç­”è¯­å‡ºæƒŠäººï¼Œâ€œå·¥èµ„ç»™æˆ‘ï¼Œæˆ‘æ¥å¸®ä½ â€ã€‚â€œè›¤ï¼Œæœ‰è¿™ä¹ˆç®€å•å—â€ï¼Œæˆ‘å¿ƒå¤´é¡¿æ—¶å†’å‡ºè¿™ä¸ªç–‘é—®ã€‚è¿™ä¸å·§äº†å—ï¼Œæˆ‘æ­£åœ¨çœ‹<code>ArrayBuffer</code>çš„çŸ¥è¯†ï¼Œçœ‹åˆ°è¯´<code>FileReader API</code>æœ‰ä¸ªæ–¹æ³•â€”<code>readAsArrayBuffer</code>ï¼Œèƒ½è¿”å›ä¸€ä¸ª<code>ArrayBuffer</code>å¯¹è±¡ï¼Œç„¶åå°±å†™äº†ä¸ªç¤ºä¾‹å»è¯»å–ä¸Šä¼ çš„æ–‡ä»¶â€¦â€¦ ç»“æœè¿˜çœŸæœ‰é‚£ä¹ˆç®€å•ã€‚</p><p>å¥½å§ï¼Œå‰é¢çš„å†…å®¹å’Œä¸»é¢˜åŸºæœ¬æ²¡å•¥å¤ªå¤§å…³ç³»ï¼Œä¸‹é¢è¿›å…¥æˆ‘ä»¬çš„æ­£é¤ç¯èŠ‚</p><h2 id="FileReader"><a href="#FileReader" class="headerlink" title="FileReader"></a>FileReader</h2><p><code>FileReader</code>å¯¹è±¡å…è®¸<code>Web</code>åº”ç”¨ç¨‹åºå¼‚æ­¥è¯»å–å­˜å‚¨åœ¨ç”¨æˆ·è®¡ç®—æœºä¸Šçš„æ–‡ä»¶ï¼ˆæˆ–åŸå§‹æ•°æ®ç¼“å†²åŒºï¼‰çš„å†…å®¹ï¼Œä½¿ç”¨<code>File</code>æˆ–<code>Blob</code>å¯¹è±¡æŒ‡å®šè¦è¯»å–çš„æ–‡ä»¶æˆ–æ•°æ®ã€‚</p><p>å…¶ä¸­<code>File</code>å¯¹è±¡æ¥è‡ªç”¨æˆ·åœ¨ä¸€ä¸ª<code>input</code>å…ƒç´ ä¸Šé€‰æ‹©æ–‡ä»¶åè¿”å›çš„<code>FileList</code>å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªæ‹–æ”¾æ“ä½œç”Ÿæˆçš„<code>DataTransfer</code>å¯¹è±¡ï¼Œè¿˜å¯ä»¥æ˜¯æ¥è‡ªåœ¨ä¸€ä¸ª<code>HTMLCanvasElement</code>ä¸Šæ‰§è¡Œ<code>mozGetAsFile()</code>æ–¹æ³•åè¿”å›ç»“æœã€‚</p><blockquote><p>ä»¥ä¸Šå†…å®¹æ¥è‡ª <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader">MDN FileReader</a> ğŸ˜€</p></blockquote><p><code>FileReader</code>ä¸ºæˆ‘ä»¬æä¾›äº†å‡ ä¸ªæ–¹æ³•ï¼Œç”¨äºè¯»å–æ•°æ®ï¼š</p><ul><li><code>readAsArrayBuffer(blob)</code>: ç”¨äºå°†æŒ‡å®šçš„<code>Blob</code>æˆ–<code>File</code>å†…å®¹è¯»å–æˆ<code>ArrayBuffer</code>æ•°æ®å¯¹è±¡</li><li><code>readAsText(blob[, encoding])</code>: ç”¨äºå°†æŒ‡å®šçš„<code>Blob</code>æˆ–<code>File</code>è¯»å–æˆå­—ç¬¦ä¸²å†…å®¹</li><li><code>readAsDataURL(blob)</code>: ç”¨äºå°†æŒ‡å®šçš„<code>Blob</code>æˆ–<code>File</code>è¯»å–æˆåŒ…å«<code>data: URL</code>æ ¼å¼çš„<code>base64</code>å­—ç¬¦ä¸²å†…å®¹</li></ul><p>ä¸€æ—¦è¯»å–å®Œæˆï¼Œå°†ä¼šè§¦å‘ä¸€ä¸ª<code>load</code>äº‹ä»¶ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡<code>reader.result</code>çš„æ–¹å¼è·å–åˆ°è¯»å–çš„å†…å®¹</p><h2 id="è¯»å–æ–‡ä»¶"><a href="#è¯»å–æ–‡ä»¶" class="headerlink" title="è¯»å–æ–‡ä»¶"></a>è¯»å–æ–‡ä»¶</h2><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†<code>FileReader</code>èƒ½è¯»å–<code>File</code>å’Œ<code>Blob</code>å¯¹è±¡æŒ‡å®šçš„æ•°æ®ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª<code>FileReader</code>å®ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>()<br></code></pre></td></tr></table></figure><p>è¯»å–ä¸Šä¼ çš„æ–‡ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;input[type=&quot;file&quot;]&#x27;</span>);<br><br><span class="hljs-comment">// ç›‘å¬é€‰æ‹©æ–‡ä»¶</span><br>fileInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">// è·å–é€‰ä¸­çš„æ–‡ä»¶ï¼Œè¿™é‡Œæ˜¯å•é€‰</span><br>  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]<br><br>  <span class="hljs-comment">// è¯»å–æ–‡ä»¶</span><br>  reader.<span class="hljs-title function_">readAsText</span>(file)<br><br>  <span class="hljs-comment">// ç›‘å¬è¯»å–å®Œæˆ</span><br>  reader.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// è·å–è¯»å–çš„æ–‡ä»¶å†…å®¹</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reader.<span class="hljs-property">result</span>)<br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±å®Œæˆäº†æˆ‘ä»¬åœ¨æœ¬åœ°é€‰æ‹©çš„æ–‡ä»¶çš„è¯»å–æ“ä½œ</p><p>å›åˆ°å‰é¢ï¼Œæˆ‘ä»¬é‡åˆ°çš„é—®é¢˜æ˜¯â€œåç«¯ç»™æˆ‘è¿”äº†<code>.txt</code>æ–‡æœ¬çš„åœ°å€ï¼Œæˆ‘æ€ä¹ˆé€šè¿‡è¿™ä¸ªåœ°å€è·å–æ–‡æœ¬å†…å®¹æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šå‘€â€ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‘èµ·ä¸€ä¸ªè¯·æ±‚æ¥è·å–è¿™ä¸ªæ–‡ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://localhost/test.txt&#x27;</span>)<br><span class="hljs-comment">// å“åº”æ•°æ®è½¬æ¢æˆblobå¯¹è±¡</span><br>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">blob</span>())<br>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">blob</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">// è¯»å–blob</span><br>  reader.<span class="hljs-title function_">readAsText</span>(blob)<br><br>  <span class="hljs-comment">// ç›‘å¬è¯»å–å®Œæˆ</span><br>  reader.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// è·å–è¯»å–çš„æ–‡ä»¶å†…å®¹</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reader.<span class="hljs-property">result</span>)<br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure><p>å‰©ä¸‹çš„æ˜¾ç¤ºåˆ°å‰ç«¯é¡µé¢ï¼Œå°±çœ‹å…·ä½“é€»è¾‘å®ç°äº†</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>FileReader</code> å¯¹è±¡ä¸ºæˆ‘ä»¬æä¾›äº†è¯»å–æ–‡ä»¶çš„èƒ½åŠ›ï¼Œåªè¦å°†éœ€è¦è¯»å–çš„æ–‡ä»¶è½¬æ¢æˆ<code>Blob</code>å¯¹è±¡ï¼Œæˆ‘ä»¬å°±èƒ½è·å–æ–‡ä»¶çš„å†…å®¹ï¼Œç„¶åå‰©ä¸‹çš„ï¼Œå°±æ˜¯å¯¹æ–‡ä»¶è¯»å–çš„å†…å®¹è¿›è¡Œç›¸åº”çš„è§£ç æ“ä½œ</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader">https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader</a></p>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react-tiny-virtual-listæºç è§£æ</title>
    <link href="/2022/10/25/react-tiny-virtual-list%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2022/10/25/react-tiny-virtual-list%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æ‰€è°“è™šæ‹Ÿåˆ—è¡¨ï¼Œå°±æ˜¯åªæ¸²æŸ“ç”¨æˆ·èƒ½å®é™…çœ‹åˆ°çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„è§†å£ï¼Œå¯¹äºè¶…è¿‡è§†å£çš„éƒ¨åˆ†å°±ä¸æ¸²æŸ“ï¼Œä»è€Œé¿å…æ¸²æŸ“å…ƒç´ è¿‡å¤šé€ æˆé¡µé¢å¡é¡¿ï¼Œå¤§æ¦‚æ•ˆæœå¦‚ä¸‹</p><img src="https://upload-images.jianshu.io/upload_images/20672535-fe03aee58f31b71d.png?imageMogr2/auto-orient/strip|imageView2/2/w/720/format/webp"><blockquote><p>å›¾ç‰‡æ¥è‡ªè¿™é‡Œ<a href="https://www.jianshu.com/p/39404c94dbd0">https://www.jianshu.com/p/39404c94dbd0</a></p></blockquote><h2 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h2><p><code>react-tiny-virtual-list</code>æ”¯æŒå‚ç›´å’Œæ°´å¹³æ–¹å‘ä¸Šæ»šåŠ¨ï¼Œé€šè¿‡ç»„ä»¶æä¾›çš„<code>recomputeSizes()</code>æ–¹æ³•ï¼Œå¯æ”¯æŒåŠ è½½åŠ¨æ€é«˜åº¦çš„å…ƒç´ </p><h3 id="éƒ¨åˆ†å‚æ•°åˆ†æ"><a href="#éƒ¨åˆ†å‚æ•°åˆ†æ" class="headerlink" title="éƒ¨åˆ†å‚æ•°åˆ†æ"></a>éƒ¨åˆ†å‚æ•°åˆ†æ</h3><p><code>width</code>å’Œ<code>height</code> æ ¹æ®æ»šåŠ¨çš„æ–¹å‘è®¾ç½®åˆ—è¡¨çš„å®½åº¦æˆ–è€…é«˜åº¦<br><code>itemCount</code> æŒ‡å®šæ¸²æŸ“åˆ—è¡¨çš„æ€»æ•°<br><code>itemSize</code>æ”¯æŒçº¯æ•°å€¼ï¼Œæˆ–è€…æŒ‡å®šæ¯ä¸€é¡¹å…ƒç´ é«˜åº¦çš„æ•°æ®ï¼Œæˆ–è€…ä¸€ä¸ªè¿”å›é«˜åº¦çš„å‡½æ•°<br><code>renderItem</code> æ¸²æŸ“å…ƒç´ ï¼Œå…¶å‚æ•°åŒ…å«äº†å½“å‰å…ƒç´ çš„<code>index</code>å’Œ<code>style</code><br><code>overscanCount</code> è¦åœ¨å¯è§é¡¹ä¸Šæ–¹&#x2F;ä¸‹æ–¹æ¸²æŸ“çš„é¢å¤–ç¼“å†²åŒºé¡¹æ•°ã€‚è°ƒæ•´æ­¤é¡¹å¯ä»¥å¸®åŠ©å‡å°‘æŸäº›æµè§ˆå™¨&#x2F;è®¾å¤‡ä¸Šçš„æ»šåŠ¨é—ªçƒã€‚<br><code>estimatedItemSize</code> ä¼°ç®—çš„å…ƒç´ é«˜åº¦ï¼Œç”¨æ¥æ”¯æŒåŠ¨æ€é«˜åº¦</p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ç»„ä»¶çš„<code>render()</code>æ–¹æ³•çš„å®ç°</p>  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">STYLE_WRAPPER</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span> = &#123;<br>  <span class="hljs-attr">overflow</span>: <span class="hljs-string">&#x27;auto&#x27;</span>,<br>  <span class="hljs-attr">willChange</span>: <span class="hljs-string">&#x27;transform&#x27;</span>,<br>  <span class="hljs-title class_">WebkitOverflowScrolling</span>: <span class="hljs-string">&#x27;touch&#x27;</span>,<br>&#125;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">STYLE_INNER</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span> = &#123;<br>  <span class="hljs-attr">position</span>: <span class="hljs-string">&#x27;relative&#x27;</span>,<br>  <span class="hljs-attr">width</span>: <span class="hljs-string">&#x27;100%&#x27;</span>,<br>  <span class="hljs-attr">minHeight</span>: <span class="hljs-string">&#x27;100%&#x27;</span>,<br>&#125;;<br><span class="hljs-comment">// ...</span><br><span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123;<br>    estimatedItemSize,<br>    height,<br>    overscanCount = <span class="hljs-number">3</span>,<br>    renderItem,<br>    itemCount,<br>    itemSize,<br>    onItemsRendered,<br>    onScroll,<br>    scrollToIndex,<br>    scrollToAlignment,<br>    stickyIndices,<br>    style,<br>    width,<br>    ...props<br>  &#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;<br>  <span class="hljs-comment">// å½“å‰è·ç¦»indexä¸º0çš„åç§»ï¼Œå…¶è®¡ç®—å€¼ä¸ºï¼ŒitemSize * å·²ç»æ»šåŠ¨çš„å…ƒç´ ä¸ªæ•°</span><br>  <span class="hljs-keyword">const</span> &#123;offset&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>  <span class="hljs-comment">// å½“å‰è¦æ¸²æŸ“çš„å…ƒç´ start index å’Œstop index</span><br>  <span class="hljs-comment">// sizeAndPositionManager æ˜¯ SizeAndPositionManager çš„å®ä¾‹ï¼Œç”¨æ¥è®¡ç®—æ¸²æŸ“åˆ°é¡µé¢çš„å…ƒç´ çš„å·¥å…·</span><br>  <span class="hljs-keyword">const</span> &#123;start, stop&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sizeAndPositionManager</span>.<span class="hljs-title function_">getVisibleRange</span>(&#123;<br>    <span class="hljs-attr">containerSize</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>[sizeProp[scrollDirection]] || <span class="hljs-number">0</span>,<br>    offset,<br>    overscanCount,<br>  &#125;);<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">items</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>[] = [];<br>  <span class="hljs-comment">// æœ€å¤–å±‚å®¹å™¨çš„æ ·å¼</span><br>  <span class="hljs-keyword">const</span> wrapperStyle = &#123;...<span class="hljs-variable constant_">STYLE_WRAPPER</span>, ...style, height, width&#125;;<br>  <span class="hljs-comment">// æ¯ä¸ªå…ƒç´ çš„æ ·å¼</span><br>  <span class="hljs-keyword">const</span> innerStyle = &#123;<br>    ...<span class="hljs-variable constant_">STYLE_INNER</span>,<br>    [sizeProp[scrollDirection]]: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sizeAndPositionManager</span>.<span class="hljs-title function_">getTotalSize</span>(),<br>  &#125;;<br><br>  <span class="hljs-comment">// è®¾ç½®å…ƒç´ çš„positionä¸ºsticky</span><br>  <span class="hljs-keyword">if</span> (stickyIndices != <span class="hljs-literal">null</span> &amp;&amp; stickyIndices.<span class="hljs-property">length</span> !== <span class="hljs-number">0</span>) &#123;<br>    stickyIndices.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) =&gt;</span><br>      items.<span class="hljs-title function_">push</span>(<br>        <span class="hljs-title function_">renderItem</span>(&#123;<br>          index,<br>          <span class="hljs-attr">style</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getStyle</span>(index, <span class="hljs-literal">true</span>),<br>        &#125;),<br>      ),<br>    );<br><br>    <span class="hljs-keyword">if</span> (scrollDirection === <span class="hljs-variable constant_">DIRECTION</span>.<span class="hljs-property">HORIZONTAL</span>) &#123;<br>      innerStyle.<span class="hljs-property">display</span> = <span class="hljs-string">&#x27;flex&#x27;</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// è¦æ¸²æŸ“çš„å…ƒç´ ï¼Œä¼ é€’indexå’Œstyle</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> start !== <span class="hljs-string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="hljs-keyword">typeof</span> stop !== <span class="hljs-string">&#x27;undefined&#x27;</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = start; index &lt;= stop; index++) &#123;<br>      <span class="hljs-keyword">if</span> (stickyIndices != <span class="hljs-literal">null</span> &amp;&amp; stickyIndices.<span class="hljs-title function_">includes</span>(index)) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br><br>      items.<span class="hljs-title function_">push</span>(<br>        <span class="hljs-title function_">renderItem</span>(&#123;<br>          index,<br>          <span class="hljs-attr">style</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getStyle</span>(index, <span class="hljs-literal">false</span>),<br>        &#125;),<br>      );<br>    &#125;<br>    <span class="hljs-comment">// è¿™æ˜¯ä¸ªå›è°ƒå‡½æ•°</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onItemsRendered === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>      <span class="hljs-title function_">onItemsRendered</span>(&#123;<br>        <span class="hljs-attr">startIndex</span>: start,<br>        <span class="hljs-attr">stopIndex</span>: stop,<br>      &#125;);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;this.getRef&#125;</span> &#123;<span class="hljs-attr">...props</span>&#125; <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;wrapperStyle&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;innerStyle&#125;</span>&gt;</span>&#123;items&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ€ä¸»è¦çš„æ“ä½œæ˜¯è·å–å½“å‰è¦æ¸²æŸ“çš„å…ƒç´ ï¼Œè€Œè¿™ä¸ªæ“ä½œæ˜¯é€šè¿‡<code>this.sizeAndPositionManager.getVisibleRange()</code>å‡½æ•°è®¡ç®—å‡ºæ¥çš„ï¼Œè€Œ<code>this.sizeAndPositionManager</code>æ˜¯åœ¨ç»„ä»¶åˆå§‹åŒ–æ—¶ç”±<code>SizeAndPositionManager</code>åˆ›å»ºçš„å®ä¾‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ...</span><br>sizeAndPositionManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SizeAndPositionManager</span>(&#123;<br>  <span class="hljs-comment">// åˆ—è¡¨æ€»ä¸ªæ•°</span><br>  <span class="hljs-attr">itemCount</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">itemCount</span>,<br>  <span class="hljs-comment">// è°ƒç”¨ä¼šè¿”å›åˆ—è¡¨çš„å…ƒç´ å¤§å°</span><br>  <span class="hljs-attr">itemSizeGetter</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">itemSizeGetter</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">itemSize</span>),<br>  <span class="hljs-comment">// åˆ—è¡¨å…ƒç´ çš„ä¼°ç®—å¤§å°</span><br>  <span class="hljs-attr">estimatedItemSize</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getEstimatedItemSize</span>(),<br>&#125;);<br><span class="hljs-comment">// ...</span><br>itemSizeGetter = <span class="hljs-function">(<span class="hljs-params">itemSize: Props[<span class="hljs-string">&#x27;itemSize&#x27;</span>]</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°è·å–å…ƒç´ å¤§å°ï¼Œå…¶å®è·å–çš„æ˜¯itemSizeå¹¶ä¸æ˜¯estimatedItemSize</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">index</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSize</span>(index, itemSize);<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>SizeAndPositionManager</code>æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºå¤„ç†åˆ—è¡¨å…ƒç´ çš„ä¿¡æ¯,å…¶æ„é€ å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–ä¸€äº›å˜é‡ï¼Œå…¶ä¸­<code>this.itemSizeAndPositionData</code>ç”¨äºç¼“å­˜<code>item</code>çš„<code>size</code>å’Œ<code>offset</code>ï¼Œ<code>this.lastMeasuredIndex</code>ç”¨äºä¿å­˜æœ€åä¸€ä¸ªè®¡ç®—å…ƒç´ æ—¶çš„<code>index</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SizeAndPositionManager</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">itemSizeGetter</span>: <span class="hljs-title class_">ItemSizeGetter</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">itemCount</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">estimatedItemSize</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">lastMeasuredIndex</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">itemSizeAndPositionData</span>: <span class="hljs-title class_">SizeAndPositionData</span>;<br><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">&#123;itemCount, itemSizeGetter, estimatedItemSize&#125;: Options</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemSizeGetter</span> = itemSizeGetter;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemCount</span> = itemCount;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">estimatedItemSize</span> = estimatedItemSize;<br><br>    <span class="hljs-comment">// Cache of size and position data for items, mapped by item index.</span><br>    <span class="hljs-comment">// æ ¹æ®indexï¼Œç¼“å­˜itemçš„å¤§å°å’Œä½ç½®</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemSizeAndPositionData</span> = &#123;&#125;;<br>    <span class="hljs-comment">// Measurements for items up to this index can be trusted; items afterward should be estimated.</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastMeasuredIndex</span> = -<span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>getVisibleRange()</code>æ˜¯ç”¨æ¥è·å–å½“å‰æ¸²æŸ“å…ƒç´ çš„<code>start index</code>å’Œ<code>stop index</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title function_">getVisibleRange</span>(&#123;<br>  <span class="hljs-comment">// å®¹å™¨å¤§å°</span><br>  containerSize,<br>  <span class="hljs-comment">// å½“å‰åç§»</span><br>  offset,<br>  <span class="hljs-comment">// é¢å¤–å¤šåŠ è½½æ•°æ®çš„ä¸ªæ•°</span><br>  overscanCount,<br>&#125;: &#123;<br>  <span class="hljs-attr">containerSize</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">overscanCount</span>: <span class="hljs-built_in">number</span>;<br>&#125;): &#123;start?: <span class="hljs-built_in">number</span>; stop?: <span class="hljs-built_in">number</span>&#125; &#123;<br>  <span class="hljs-comment">// è®¡ç®—å…ƒç´ æ€»çš„é«˜åº¦</span><br>  <span class="hljs-keyword">const</span> totalSize = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTotalSize</span>();<br><br>  <span class="hljs-keyword">if</span> (totalSize === <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123;&#125;;<br>  &#125;<br>  <span class="hljs-comment">// æœ€å¤§åç§»</span><br>  <span class="hljs-keyword">const</span> maxOffset = offset + containerSize;<br>  <span class="hljs-comment">// æŸ¥æ‰¾ä¸offsetè·ç¦»æœ€è¿‘çš„å…ƒç´ çš„indexï¼Œä½œä¸ºè§†å£æ˜¾ç¤ºçš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br>  <span class="hljs-keyword">let</span> start = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findNearestItem</span>(offset);<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> start === <span class="hljs-string">&#x27;undefined&#x27;</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Invalid offset <span class="hljs-subst">$&#123;offset&#125;</span> specified`</span>);<br>  &#125;<br>  <span class="hljs-comment">// è·å–å½“å‰startå¤„ å…ƒç´ çš„ä¿¡æ¯</span><br>  <span class="hljs-keyword">const</span> datum = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSizeAndPositionForIndex</span>(start);<br>  offset = datum.<span class="hljs-property">offset</span> + datum.<span class="hljs-property">size</span>;<br><br>  <span class="hljs-keyword">let</span> stop = start;<br>  <span class="hljs-comment">// è®¡ç®—è§†å£æ˜¾ç¤ºçš„æœ€åä¸€ä¸ªå…ƒç´ çš„index</span><br>  <span class="hljs-comment">// è®¡ç®—ä¸‹ä¸€ä¸ªå…ƒç´ çš„offsetï¼Œç­‰äºå½“å‰å…ƒç´ çš„size + å½“å‰å…ƒç´ çš„offset</span><br>  <span class="hljs-keyword">while</span> (offset &lt; maxOffset &amp;&amp; stop &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemCount</span> - <span class="hljs-number">1</span>) &#123;<br>    stop++;<br>    offset += <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSizeAndPositionForIndex</span>(stop).<span class="hljs-property">size</span>;<br>  &#125;<br>  <span class="hljs-comment">// åŠ è½½é¢å¤–çš„æ•°æ®ï¼Œå‡å°‘æ»šåŠ¨é—ªçƒ</span><br>  <span class="hljs-keyword">if</span> (overscanCount) &#123;<br>    start = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, start - overscanCount);<br>    stop = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(stop + overscanCount, <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemCount</span> - <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> &#123;<br>    start,<br>    stop,<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»„ä»¶åœ¨<code>componentDidMount</code>ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä¸ºå®¹å™¨ç»„ä»¶æŒ‚è½½äº†æ»šåŠ¨äº‹ä»¶ï¼Œç”¨äºå¤„ç†æ»šåŠ¨ã€‚å½“æ»šåŠ¨è§¦å‘æ—¶ï¼Œå»æ›´æ–°<code>offset</code>çŠ¶æ€ï¼Œä»è€Œè§¦å‘æ–°çš„è®¡ç®—åé‡æ–°æ¸²æŸ“å…ƒç´ </p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123;scrollOffset, scrollToIndex&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleScroll</span>, &#123;<br>    <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>,<br>  &#125;);<br><br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">private</span> handleScroll = <span class="hljs-function">(<span class="hljs-params">event: UIEvent</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123;onScroll&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;<br>  <span class="hljs-comment">// è·å–åç§»</span><br>  <span class="hljs-keyword">const</span> offset = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNodeOffset</span>();<br>  <span class="hljs-keyword">if</span> (<br>    offset &lt; <span class="hljs-number">0</span> ||<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">offset</span> === offset ||<br>    event.<span class="hljs-property">target</span> !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span><br>  ) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-comment">// æ›´æ–°offsetï¼Œè§¦å‘rerender</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123;<br>    offset,<br>    <span class="hljs-attr">scrollChangeReason</span>: <span class="hljs-variable constant_">SCROLL_CHANGE_REASON</span>.<span class="hljs-property">OBSERVED</span>,<br>  &#125;);<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onScroll === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>    <span class="hljs-title function_">onScroll</span>(offset, event);<br>  &#125;<br>&#125;;<br><span class="hljs-comment">// å®¹å™¨å…ƒç´ çš„æ»šåŠ¨è·ç¦»(scrollTop/scrollLeft)ï¼Œå°±æ˜¯å½“å‰çš„offset</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">getNodeOffset</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123;scrollDirection = <span class="hljs-variable constant_">DIRECTION</span>.<span class="hljs-property">VERTICAL</span>&#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>[scrollProp[scrollDirection]];<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡å¯¹æºç çš„åˆ†æï¼Œå¯ä»¥çœ‹å‡ºï¼Œæ ¹æ®<code>start</code>å’Œ<code>stop</code>å°±å¯ä»¥è®¡ç®—å‡ºå½“å‰éœ€è¦æ¸²æŸ“çš„å…ƒç´ ï¼Œè¦å¾—åˆ°<code>start</code>å€¼ï¼Œå°±éœ€è¦è®¡ç®—å…ƒç´ çš„åç§»é‡<code>(offset)</code>ï¼Œè‹¥è¦å¾—åˆ°<code>stop</code>ï¼Œéœ€è¦å°†<code>start</code>ä¹‹å‰çš„åç§»é‡<code>(offset)</code>å†åŠ ä¸Šå®¹å™¨çš„é«˜åº¦æˆ–å®½åº¦ã€‚åœ¨æ»šåŠ¨æ—¶ï¼Œéœ€è¦ç›‘å¬å®¹å™¨çš„<code>scroll</code>äº‹ä»¶ï¼Œå®¹å™¨çš„<code>scrollTop/scrollLeft</code>å°±æ˜¯å½“å‰è¦å±•ç¤ºåœ¨å®¹å™¨ä¸­çš„å…ƒç´ çš„åç§»é‡<code>(offset)</code>ï¼Œç„¶åå†ç”¨å‰é¢çš„è®¡ç®—æ–¹å¼ï¼Œå°±å¯ä»¥å¾—åˆ°æ–°çš„<code>start</code>å’Œ<code>stop</code></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.jianshu.com/p/39404c94dbd0">https://www.jianshu.com/p/39404c94dbd0</a></p><p><a href="https://github.com/dwqs/blog/issues/71">https://github.com/dwqs/blog/issues/71</a></p><p><a href="https://github.com/clauderic/react-tiny-virtual-list">https://github.com/clauderic/react-tiny-virtual-list</a></p>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨nodejsåˆ›å»ºwebsocket</title>
    <link href="/2022/10/13/%E4%BD%BF%E7%94%A8nodejs%E5%88%9B%E5%BB%BAwebsocket/"/>
    <url>/2022/10/13/%E4%BD%BF%E7%94%A8nodejs%E5%88%9B%E5%BB%BAwebsocket/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡ä¸»é¢˜æ˜¯é˜…è¯»<code>nodejs-websocket</code>åº“çš„æºç ï¼Œè¿›è€Œææ‡‚<code>websocket</code>çš„å®ç°æ–¹å¼ï¼Œå¹¶é€šè¿‡è‡ªå·±æ‰‹å†™æ­å»ºä¸€ä¸ªç®€å•çš„<code>websocket</code>æœåŠ¡</p><p><code>Web Scoket</code>æ˜¯ä¸€ä¸ªåŸºäº<code>TCP</code>åè®®çš„å…¨åŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œå½“å»ºç«‹é“¾æ¥åï¼Œå…¶æœåŠ¡ç«¯å¯ä»¥ç›´æ¥å‘èµ·å¯¹å®¢æˆ·ç«¯çš„é€šä¿¡</p><h2 id="å·¥ä½œæ–¹å¼"><a href="#å·¥ä½œæ–¹å¼" class="headerlink" title="å·¥ä½œæ–¹å¼"></a>å·¥ä½œæ–¹å¼</h2><p>è¦å»ºç«‹ä¸€ä¸ª<code>Web Socket</code>é“¾æ¥ï¼Œé¦–å…ˆéœ€è¦é€šè¿‡<code>HTTP</code>è¿›è¡Œæ¡æ‰‹ï¼Œåœ¨æ¡æ‰‹æˆåŠŸåï¼Œåˆ‡æ¢åè®®æ–¹å¼ï¼ˆ<code>HTTP</code>åˆ‡æ¢æˆ <code>Web Socket</code>åè®®ï¼‰ï¼Œé“¾æ¥å»ºç«‹æˆåŠŸï¼Œå°±å¯ä»¥å¼€å§‹é€šä¿¡äº†ã€‚</p><p>åœ¨æ¡æ‰‹æ—¶ï¼Œå®¢æˆ·ç«¯éœ€è¦åœ¨è¯·æ±‚æŠ¥æ–‡ä¸­æ³¨æ˜è‡ªå·±éœ€è¦åˆ‡æ¢åè®®ä¸º<code>Web Socket</code>åè®®ï¼ˆåœ¨<code>Web Socket</code>ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³æ³¨è¯·æ±‚æŠ¥æ–‡ï¼Œå› ä¸ºå½“æˆ‘ä»¬é€šè¿‡ <code>new WebSocket(ws://example.com/test)</code>ï¼Œåˆ›å»ºå®ä¾‹æ—¶ï¼Œæµè§ˆå™¨ä¼šåœ¨å†…éƒ¨ä¸ºæˆ‘ä»¬å¤„ç†è¯·æ±‚çš„æŠ¥æ–‡ï¼‰</p><blockquote><p>åŒæºç­–ç•¥ä¸é€‚ç”¨äº<code>Web Socket</code></p></blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/test</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>Upgrade<br><span class="hljs-attribute">Upgrade</span><span class="hljs-punctuation">: </span>websocket<br><span class="hljs-attribute">Sec-WebSocket-Version</span><span class="hljs-punctuation">: </span>13<br><span class="hljs-attribute">Sec-WebSocket-Key</span><span class="hljs-punctuation">: </span>udGGqBU9BqSiThHTKc0B6g==<br></code></pre></td></tr></table></figure><p>å½“æœåŠ¡ç«¯æ”¶åˆ°æ–°çš„<code>Web Scoket</code>é“¾æ¥æ—¶ï¼Œåˆ¤æ–­å½“å‰å‘èµ·çš„æ˜¯<code>Web Socket</code>é“¾æ¥åï¼Œç„¶åéœ€è¦è¿”å›ä¸€ä¸ªå“åº”æŠ¥æ–‡ï¼Œæ¥å‘Šè¯‰å®¢æˆ·ç«¯åˆ‡æ¢åˆ°<code>Web Socket</code>åè®®</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">101</span> Switching Protocols<br><span class="hljs-attribute">Upgrade</span><span class="hljs-punctuation">: </span>websocket<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>Upgrade<br><span class="hljs-attribute">Sec-WebSocket-Accept</span><span class="hljs-punctuation">: </span>4UCGeYLdUGEUaei+36wTyP60Mcg=<br></code></pre></td></tr></table></figure><blockquote><ul><li><code>HTTP 101</code> çŠ¶æ€ç è‹±æ–‡åç§°æ˜¯<code>Switching Protocols</code>ï¼Œè¡¨ç¤ºåˆ‡æ¢åè®®ã€‚æœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ‡æ¢åè®®ã€‚åªèƒ½åˆ‡æ¢åˆ°æ›´é«˜çº§çš„åè®®</li><li><code>Sec-WebSocket-Accept</code> ç”¨ä»¥å‘ŠçŸ¥æœåŠ¡å™¨æ„¿å‘èµ·ä¸€ä¸ª <code>websocket</code> è¿æ¥ã€‚<code>Sec-WebSocket-Accept</code>çš„è®¡ç®—æ–¹æ³•ï¼š<code>base64(hsa1(sec-websocket-key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11))</code>ã€‚å‚è€ƒï¼š<a href="https://www.zhihu.com/question/67784701">https://www.zhihu.com/question/67784701</a></li></ul></blockquote><h2 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h2><blockquote><p>ä»¥ä¸‹åªåˆ—å‡ºäº†å…³é”®æ€§ä»£ç </p></blockquote><h3 id="æ¡æ‰‹"><a href="#æ¡æ‰‹" class="headerlink" title="æ¡æ‰‹"></a>æ¡æ‰‹</h3><p><code>Server</code>ç±»ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ª<code>server</code>ç¤ºä¾‹ï¼ŒåŒæ—¶åœ¨æ„é€ å‡½æ•°ä¸­åšä¸€äº›å‰ç½®å¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Server</span>(<span class="hljs-params">secure, options, callback</span>) &#123;<br>  <span class="hljs-comment">// å†…éƒ¨serverï¼Œæ”¶åˆ°ä¸€ä¸ª&quot;connection&quot;äº‹ä»¶åè°ƒç”¨</span><br>  <span class="hljs-comment">// è¿™ä¸ªäº‹ä»¶æ˜¯nodejs æœåŠ¡çš„äº‹ä»¶ï¼Œä¸ä¸‹é¢è§¦å‘çš„&quot;connection&quot;äº‹ä»¶ä¸æ˜¯ä¸€ä¸ª</span><br><span class="hljs-keyword">var</span> onConnection = <span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªè¿æ¥åçš„å®ä¾‹ï¼Œç”¨äºæ”¶å‘æ•°æ®ï¼Œé”™è¯¯å¤„ç†ç­‰</span><br>    <span class="hljs-comment">// çœ‹ä¸‹é¢çš„ä»‹ç»</span><br><span class="hljs-keyword">var</span> conn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Connection</span>(socket, that, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>that.<span class="hljs-property">connections</span>.<span class="hljs-title function_">push</span>(conn)<br>conn.<span class="hljs-title function_">removeListener</span>(<span class="hljs-string">&#x27;error&#x27;</span>, nop)<br>that.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;connection&#x27;</span>, conn)<br>&#125;)<br>    <span class="hljs-comment">// è¿æ¥å…³é—­åç§»é™¤å½“å‰é“¾æ¥</span><br>conn.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;close&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">var</span> pos = that.<span class="hljs-property">connections</span>.<span class="hljs-title function_">indexOf</span>(conn)<br><span class="hljs-keyword">if</span> (pos !== -<span class="hljs-number">1</span>) &#123;<br>that.<span class="hljs-property">connections</span>.<span class="hljs-title function_">splice</span>(pos, <span class="hljs-number">1</span>)<br>&#125;<br>&#125;)<br><br><span class="hljs-comment">// Ignore errors before the connection is established</span><br>conn.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;error&#x27;</span>, nop)<br>&#125;<br>  <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå†…éƒ¨çš„serverå®ä¾‹</span><br>  <span class="hljs-keyword">if</span> (secure) &#123;<br>    <span class="hljs-comment">// åˆ›å»ºwssæœåŠ¡</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span> = tls.<span class="hljs-title function_">createServer</span>(options, onConnection)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºwsæœåŠ¡</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span> = net.<span class="hljs-title function_">createServer</span>(options, onConnection)<br>&#125;<br>  <span class="hljs-comment">// ä¿å­˜å·²è¿æ¥çš„web socket</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">connections</span> = []<br><br><span class="hljs-comment">// ç»§æ‰¿æ—¶thisç»‘å®š</span><br>events.<span class="hljs-property">EventEmitter</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>)<br><span class="hljs-keyword">if</span> (callback) &#123;<br>    <span class="hljs-comment">// å½“web socket é“¾æ¥åè°ƒç”¨</span><br>    <span class="hljs-comment">// connectionäº‹ä»¶æ˜¯è‡ªå·±å®ç°çš„</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;connection&#x27;</span>, callback)<br>&#125;<br>&#125;<br><span class="hljs-comment">// ç»§æ‰¿events.EventEmitter</span><br>util.<span class="hljs-title function_">inherits</span>(<span class="hljs-title class_">Server</span>, events.<span class="hljs-property">EventEmitter</span>)<br></code></pre></td></tr></table></figure><p><code>server.listen()</code> ç”¨äºå¼€å¯<code>Web Socket</code>æœåŠ¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Server</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">listen</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">port, host, callback</span>) &#123;<br><span class="hljs-keyword">if</span> (callback) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;listening&#x27;</span>, callback)<br>&#125;<br>  <span class="hljs-comment">// å¼€å¯æœåŠ¡ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡è¿æ¥è®¿é—®äº†</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">listen</span>(port, host, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>that.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;listening&#x27;</span>)<br>&#125;)<br><br><span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>Connection</code>ç±»ï¼Œæ˜¯æ•´ä¸ªæ¨¡å—çš„æ ¸å¿ƒï¼Œç”¨äºå¤„ç†<code>Web Socket</code>çš„â€œæ¡æ‰‹â€ï¼Œä»¥åŠâ€œæ¡æ‰‹â€æˆåŠŸåå¯¹æ•°æ®çš„å¤„ç†å’Œå¼‚å¸¸çš„å¤„ç†</p><blockquote><p>åªçœ‹è¢«ä½œä¸ºæœåŠ¡ç«¯æ¥ä½¿ç”¨æ—¶çš„å¤„ç†</p></blockquote><p><code>Connection</code>æ„é€ å‡½æ•°ï¼Œæ•°æ®åˆå§‹åŒ–ï¼Œç»‘å®š<code>net.Socket</code>çš„<code>readable</code>äº‹ä»¶ï¼Œç”¨äºå¯¹è¿›æ¥çš„è¯·æ±‚åšå¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Connection</span>(<span class="hljs-params">socket, parentOrOptions, callback</span>) &#123;<br><span class="hljs-keyword">var</span> that = <span class="hljs-variable language_">this</span>,<br>connectEvent<br>  <span class="hljs-comment">// åˆå§‹åŒ–</span><br>  <span class="hljs-comment">// Server-side connection</span><br>  <span class="hljs-comment">// Server å®ä¾‹</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span> = parentOrOptions<br>  <span class="hljs-comment">// websocket çš„url</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">path</span> = <span class="hljs-literal">null</span><br>  <span class="hljs-comment">// websocket çš„host</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">host</span> = <span class="hljs-literal">null</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">extraHeaders</span> = <span class="hljs-literal">null</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">protocols</span> = []<br><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">protocol</span> = <span class="hljs-literal">undefined</span><br>  <span class="hljs-comment">// net.Socket çš„å®ä¾‹</span><br>  <span class="hljs-comment">// https://nodejs.org/dist/latest-v18.x/docs/api/net.html#event-connection</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span> = socket<br>  <span class="hljs-comment">// è¿æ¥çŠ¶æ€</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">CONNECTING</span><br>  <span class="hljs-comment">// å·²æ¥æ”¶æ•°æ®</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">0</span>)<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> = <span class="hljs-literal">null</span> <span class="hljs-comment">// string for text frames and InStream for binary frames</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">outStream</span> = <span class="hljs-literal">null</span> <span class="hljs-comment">// current allocated OutStream object for sending binary frames</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = <span class="hljs-literal">null</span> <span class="hljs-comment">// the Sec-WebSocket-Key header</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span> = &#123;&#125; <span class="hljs-comment">// read only map of header names and values. Header names are lower-cased</span><br><br><span class="hljs-comment">// å…¥å£ï¼Œåœ¨è¿™é‡Œè¯»æ•°æ®ï¼ŒåŒ…æ‹¬â€œæ¡æ‰‹â€å’Œåé¢æ¥æ”¶æ•°æ®</span><br>socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;readable&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>that.<span class="hljs-title function_">doRead</span>()<br>&#125;)<br>  <span class="hljs-comment">// é”™è¯¯å¤„ç†</span><br>socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) &#123;<br>that.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;error&#x27;</span>, err)<br>&#125;)<br><br><span class="hljs-comment">// Close listeners</span><br>  <span class="hljs-comment">// è¿æ¥å…³é—­ï¼ŒçŠ¶æ€é‡ç½®</span><br><span class="hljs-keyword">var</span> onclose = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">if</span> (that.<span class="hljs-property">readyState</span> === that.<span class="hljs-property">CONNECTING</span> || that.<span class="hljs-property">readyState</span> === that.<span class="hljs-property">OPEN</span>) &#123;<br>that.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;close&#x27;</span>, <span class="hljs-number">1006</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>&#125;<br>that.<span class="hljs-property">readyState</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">CLOSED</span><br><span class="hljs-keyword">if</span> (that.<span class="hljs-property">frameBuffer</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">InStream</span>) &#123;<br>that.<span class="hljs-property">frameBuffer</span>.<span class="hljs-title function_">end</span>()<br>that.<span class="hljs-property">frameBuffer</span> = <span class="hljs-literal">null</span><br>&#125;<br><span class="hljs-keyword">if</span> (that.<span class="hljs-property">outStream</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">OutStream</span>) &#123;<br>that.<span class="hljs-property">outStream</span>.<span class="hljs-title function_">end</span>()<br>that.<span class="hljs-property">outStream</span> = <span class="hljs-literal">null</span><br>&#125;<br>&#125;<br>socket.<span class="hljs-title function_">once</span>(<span class="hljs-string">&#x27;close&#x27;</span>, onclose)<br>socket.<span class="hljs-title function_">once</span>(<span class="hljs-string">&#x27;finish&#x27;</span>, onclose)<br><br><span class="hljs-comment">// ç»§æ‰¿æ—¶thisç»‘å®š</span><br>events.<span class="hljs-property">EventEmitter</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>)<br><span class="hljs-keyword">if</span> (callback) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">once</span>(<span class="hljs-string">&#x27;connect&#x27;</span>, callback)<br>&#125;<br>&#125;<br><span class="hljs-comment">// ç»§æ‰¿events.EventEmitter</span><br>util.<span class="hljs-title function_">inherits</span>(<span class="hljs-title class_">Connection</span>, events.<span class="hljs-property">EventEmitter</span>)<br><br></code></pre></td></tr></table></figure><p><code>Connection.prototype.doRead()</code>æ˜¯æ‰€æœ‰è¯·æ±‚çš„å…¥å£å‡½æ•°ï¼Œç”¨äºå¤„ç†â€œæ¡æ‰‹â€ï¼Œä»¥åŠæ•°æ®è¯»å–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Connection</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">doRead</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">var</span> buffer, temp<br><br><span class="hljs-comment">// Fetches the data</span><br>  <span class="hljs-comment">// ä»å†…éƒ¨ç¼“å­˜åŒºè¯»å–æ•°æ®</span><br>buffer = <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">read</span>()<br><span class="hljs-keyword">if</span> (!buffer) &#123;<br><span class="hljs-comment">// Waits for more data</span><br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// Save to the internal buffer</span><br>  <span class="hljs-comment">// ä¿å­˜å½“å‰è¿›æ¥çš„æ•°æ®</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">concat</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>, buffer], <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">length</span> + buffer.<span class="hljs-property">length</span>)<br>  <span class="hljs-comment">// å¦‚æœè¿æ¥çŠ¶æ€ä¸ºæ­£åœ¨è¿æ¥</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">CONNECTING</span>) &#123;<br>    <span class="hljs-comment">// æ¡æ‰‹å¤„ç†</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readHandshake</span>()) &#123;<br><span class="hljs-comment">// May have failed or we&#x27;re waiting for more data</span><br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">CLOSED</span>) &#123;<br><span class="hljs-comment">// è¯»å–æ•°æ®</span><br><span class="hljs-keyword">while</span> ((temp = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractFrame</span>()) === <span class="hljs-literal">true</span>) &#123;&#125;<br><span class="hljs-keyword">if</span> (temp === <span class="hljs-literal">false</span>) &#123;<br><span class="hljs-comment">// Protocol error</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">close</span>(<span class="hljs-number">1002</span>)<br><span class="hljs-comment">// è¯»å–æ•°æ®è¶…è¿‡æœ€å¤§é•¿åº¦é™åˆ¶å¤„ç†</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-title class_">Connection</span>.<span class="hljs-property">maxBufferLength</span>) &#123;<br><span class="hljs-comment">// Frame too big</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">close</span>(<span class="hljs-number">1009</span>)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Connection.prototype.readHandshake()</code>ç”¨äºå¯¹â€œæ¡æ‰‹â€çš„æŠ¥æ–‡è¿›è¡Œæå–è§£æå¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Connection</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">readHandshake</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">var</span> found = <span class="hljs-literal">false</span>,<br><br><span class="hljs-comment">// Search for &#x27;\r\n\r\n&#x27;</span><br><span class="hljs-comment">// è¿™é‡Œä¸æ˜¯å¾ˆç†è§£ï¼Œå¯èƒ½æ˜¯æœç´¢åˆ°è¿™å‡ ä¸ªå­—ç¬¦ï¼Œåˆ™è¯´æ˜å½“å‰è¯·æ±‚æ¥æ”¶å®Œæˆ</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">length</span> - <span class="hljs-number">3</span>; i++) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>[i] === <span class="hljs-number">13</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>[i + <span class="hljs-number">2</span>] === <span class="hljs-number">13</span> &amp;&amp;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>[i + <span class="hljs-number">1</span>] === <span class="hljs-number">10</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>[i + <span class="hljs-number">3</span>] === <span class="hljs-number">10</span>) &#123;<br>found = <span class="hljs-literal">true</span><br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (!found) &#123;<br><span class="hljs-comment">// Wait for more data</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// æ‹†åˆ†è¯·æ±‚æŠ¥æ–‡</span><br>data = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, i + <span class="hljs-number">4</span>).<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;\r\n&#x27;</span>)<br><span class="hljs-comment">// åˆ‡æ¢Web Socketåè®®å¤„ç†</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">answerHandshake</span>(data)) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(i + <span class="hljs-number">4</span>)<br><span class="hljs-comment">// æ›´æ”¹é“¾æ¥çŠ¶æ€ä¸ºopen</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">OPEN</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;connect&#x27;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// å¯¹äºWeb Socketçš„é”™è¯¯å¤„ç†éƒ½æ˜¯è¿”å›è¿™ä¸ªå“åº”ä¿¡æ¯</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;HTTP/1.1 400 Bad Request\r\n\r\n&#x27;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Connection.prototype.answerHandshake()</code>å°†<code>HTTP</code>åè®®åˆ‡æ¢æˆ<code>Web Socket</code>åè®®ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Connection</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">answerHandshake</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">lines</span>) &#123;<br><span class="hljs-keyword">var</span> path, key, sha1, headers<br><br><span class="hljs-comment">// è¯·æ±‚æŠ¥æ–‡ï¼Œå¿…å®šåŒ…å«ä¸Šé¢ï¼ˆ`å·¥ä½œæ–¹å¼æ‰€åˆ—å‡ºçš„å†…å®¹`ï¼‰æåˆ°çš„å†…å®¹</span><br><span class="hljs-keyword">if</span> (lines.<span class="hljs-property">length</span> &lt; <span class="hljs-number">6</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// è§£æè¯·æ±‚url</span><br>path = lines[<span class="hljs-number">0</span>].<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^GET (.+) HTTP\/\d\.\d$/i</span>)<br><span class="hljs-keyword">if</span> (!path) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">path</span> = path[<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">// è§£æä¸ºæ­£ç¡®çš„headersæ ¼å¼ï¼Œä»£ç åœ¨ä¸‹é¢</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readHeaders</span>(lines)<br><br><span class="hljs-comment">// éªŒè¯å¿…è¦çš„header</span><br><span class="hljs-keyword">if</span> (!(<span class="hljs-string">&#x27;host&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>) ||<br>!(<span class="hljs-string">&#x27;sec-websocket-key&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>) ||<br>!(<span class="hljs-string">&#x27;upgrade&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>) ||<br>!(<span class="hljs-string">&#x27;connection&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// &#x27;Upgrade&#x27; çš„å€¼å¿…é¡»æ˜¯&#x27;websocket&#x27;</span><br><span class="hljs-comment">// &#x27;Connection&#x27; çš„å€¼å¿…é¡»å­˜åœ¨&#x27;Upgrade&#x27;</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>.<span class="hljs-property">upgrade</span>.<span class="hljs-title function_">toLowerCase</span>() !== <span class="hljs-string">&#x27;websocket&#x27;</span> ||<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>.<span class="hljs-property">connection</span>.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\s*,\s*/</span>).<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;upgrade&#x27;</span>) === -<span class="hljs-number">1</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// å†³å®šå½“å‰é“¾æ¥çš„Web Scoketåè®®çš„ç‰ˆæœ¬</span><br><span class="hljs-comment">// è¿™é‡Œå¯¹ä¸ç¬¦åˆçš„ç‰ˆæœ¬ï¼Œåœ¨å“åº”æŠ¥æ–‡ä¸­ï¼Œæ²¡æœ‰åšæç¤ºï¼Œè€Œæ˜¯ç›´æ¥å½“æˆé”™è¯¯æ¥å¤„ç†</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;sec-websocket-version&#x27;</span>] !== <span class="hljs-string">&#x27;13&#x27;</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;sec-websocket-key&#x27;</span>]<br><br><span class="hljs-comment">// Agree on a protocol</span><br><span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;sec-websocket-protocol&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>) &#123;<br><span class="hljs-comment">// Parse</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">protocols</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;sec-websocket-protocol&#x27;</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">each</span>) &#123;<br><span class="hljs-keyword">return</span> each.<span class="hljs-title function_">trim</span>()<br>&#125;)<br><br><span class="hljs-comment">// Select protocol</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span>.<span class="hljs-property">_selectProtocol</span>) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">protocol</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span>.<span class="hljs-title function_">_selectProtocol</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">protocols</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Build and send the response</span><br><span class="hljs-comment">// ç”Ÿæˆä¸€ä¸ª`Sec-WebSocket-Accept` key</span><br>sha1 = crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">&#x27;sha1&#x27;</span>)<br>sha1.<span class="hljs-title function_">end</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> + <span class="hljs-string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span>)<br>key = sha1.<span class="hljs-title function_">read</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;base64&#x27;</span>)<br><br><span class="hljs-comment">// å“åº”å¤´</span><br>headers = &#123;<br><span class="hljs-title class_">Upgrade</span>: <span class="hljs-string">&#x27;websocket&#x27;</span>,<br><span class="hljs-title class_">Connection</span>: <span class="hljs-string">&#x27;Upgrade&#x27;</span>,<br><span class="hljs-string">&#x27;Sec-WebSocket-Accept&#x27;</span>: key<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">protocol</span>) &#123;<br>headers[<span class="hljs-string">&#x27;Sec-WebSocket-Protocol&#x27;</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">protocol</span><br>&#125;<br><br><span class="hljs-comment">// åˆ‡æ¢ä¸ºWeb Socketåè®®çš„åº”ç­”</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">write</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildRequest</span>(<span class="hljs-string">&#x27;HTTP/1.1 101 Switching Protocols&#x27;</span>, headers))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-comment">// å°†è¯·æ±‚å¤´è§£ææˆå¯¹è±¡å½¢å¼çš„headers</span><br><span class="hljs-title class_">Connection</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">readHeaders</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">lines</span>) &#123;<br><span class="hljs-keyword">var</span> i, match<br><br><span class="hljs-comment">// Extract all headers</span><br><span class="hljs-comment">// Ignore bad-formed lines and ignore the first line (HTTP header)</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; lines.<span class="hljs-property">length</span>; i++) &#123;<br><span class="hljs-keyword">if</span> ((match = lines[i].<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^([a-z-]+): (.+)$/i</span>))) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">headers</span>[match[<span class="hljs-number">1</span>].<span class="hljs-title function_">toLowerCase</span>()] = match[<span class="hljs-number">2</span>]<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±å®Œæˆäº†è¿æ¥çš„æ¡æ‰‹å¤„ç†</p><h3 id="æ•°æ®è§£æ"><a href="#æ•°æ®è§£æ" class="headerlink" title="æ•°æ®è§£æ"></a>æ•°æ®è§£æ</h3><p><code>WebSocket</code> ä»¥ <code>frame</code> ä¸ºå•ä½ä¼ è¾“æ•°æ®, <code>frame</code> æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ•°æ®ä¼ è¾“çš„æœ€å°å•å…ƒ, å½“ä¸€æ¡æ¶ˆæ¯è¿‡é•¿æ—¶, é€šä¿¡æ–¹å¯ä»¥å°†è¯¥æ¶ˆæ¯æ‹†åˆ†æˆå¤šä¸ª <code>frame</code> å‘é€, æ¥æ”¶æ–¹æ”¶åˆ°ä»¥åé‡æ–°æ‹¼æ¥ã€è§£ç ä»è€Œè¿˜åŸå‡ºå®Œæ•´çš„æ¶ˆæ¯, åœ¨ <code>WebSocket</code> ä¸­, <code>frame</code> æœ‰å¤šç§ç±»å‹, <code>frame</code> çš„ç±»å‹ç”± <code>frame</code> å¤´éƒ¨çš„ <code>Opcode</code> å­—æ®µæŒ‡ç¤º</p><p><code>Connection.prototype.extractFrame()</code> ä»ç¼“å†²åŒºä¸­æå–å¸§(<code>frame</code>)çš„å†…å®¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Connection</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">extractFrame</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">var</span> fin, opcode, B, <span class="hljs-variable constant_">HB</span>, mask, len, payload, start, i, hasMask<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// Is this the last frame in a sequence?</span><br>B = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>[<span class="hljs-number">0</span>]<br><span class="hljs-variable constant_">HB</span> = B &gt;&gt; <span class="hljs-number">4</span><br><span class="hljs-comment">// åˆ¤æ–­RSV1, RSV2, RSV3ä½ç»„æˆçš„è‡ªå®šä¹‰åè®®</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">HB</span> % <span class="hljs-number">8</span>) &#123;<br><span class="hljs-comment">// RSV1, RSV2 and RSV3 must be clear</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// ç”¨äºæŒ‡ç¤ºå½“å‰çš„ frame æ˜¯æ¶ˆæ¯çš„æœ€åä¸€ä¸ªåˆ†æ®µï¼Œ1ä¸ºæœ€åä¸€ä¸ªframe</span><br>fin = <span class="hljs-variable constant_">HB</span> === <span class="hljs-number">8</span><br><span class="hljs-comment">// æ“ä½œç </span><br><span class="hljs-comment">// *  %x0 è¡¨ç¤ºè¿ç»­æ¶ˆæ¯ç‰‡æ–­</span><br><span class="hljs-comment">// *  %x1 è¡¨ç¤ºæ–‡æœ¬æ¶ˆæ¯ç‰‡æ–­</span><br><span class="hljs-comment">// *  %x2 è¡¨æœªäºŒè¿›åˆ¶æ¶ˆæ¯ç‰‡æ–­</span><br><span class="hljs-comment">// *  %x3-7 ä¸ºå°†æ¥çš„éæ§åˆ¶æ¶ˆæ¯ç‰‡æ–­ä¿ç•™çš„æ“ä½œç </span><br><span class="hljs-comment">// *  %x8 è¡¨ç¤ºè¿æ¥å…³é—­</span><br><span class="hljs-comment">// *  %x9 è¡¨ç¤ºå¿ƒè·³æ£€æŸ¥çš„ping</span><br><span class="hljs-comment">// *  %xA è¡¨ç¤ºå¿ƒè·³æ£€æŸ¥çš„pong</span><br><span class="hljs-comment">// *  %xB-F ä¸ºå°†æ¥çš„æ§åˆ¶æ¶ˆæ¯ç‰‡æ–­çš„ä¿ç•™æ“ä½œç </span><br>opcode = B % <span class="hljs-number">16</span><br><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ˜¯æœ‰æ•ˆæ“ä½œç ï¼Œ0~F,é™¤äº†è¿™é‡Œåˆ—å‡ºçš„ï¼Œå…¶ä»–éƒ½ä¸ºä¿ç•™çš„æ“ä½œç </span><br><span class="hljs-keyword">if</span> (opcode !== <span class="hljs-number">0</span> &amp;&amp; opcode !== <span class="hljs-number">1</span> &amp;&amp; opcode !== <span class="hljs-number">2</span> &amp;&amp;<br>opcode !== <span class="hljs-number">8</span> &amp;&amp; opcode !== <span class="hljs-number">9</span> &amp;&amp; opcode !== <span class="hljs-number">10</span>) &#123;<br><span class="hljs-comment">// Invalid opcode</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> (opcode &gt;= <span class="hljs-number">8</span> &amp;&amp; !fin) &#123;<br><span class="hljs-comment">// Control frames must not be fragmented</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br>B = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>[<span class="hljs-number">1</span>]<br><span class="hljs-comment">// å–å‡ºMaskä½ï¼Œåˆ¤æ–­ä¼ è¾“çš„æ•°æ®æ˜¯å¦æœ‰åŠ æ©ç ï¼Œè®¾ç½®ä¸º1ï¼Œæ©ç é”®å¿…é¡»æ”¾åœ¨Masking-keyåŒºåŸŸ</span><br><span class="hljs-comment">// å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡ç«¯çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ­¤ä½çš„å€¼éƒ½æ˜¯1ï¼›</span><br>hasMask = B &gt;&gt; <span class="hljs-number">7</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span> &amp;&amp; !hasMask) || (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span> &amp;&amp; hasMask)) &#123;<br><span class="hljs-comment">// Frames sent by clients must be masked</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// Payload lengthå¤„ç†</span><br><span class="hljs-comment">// è·å– Payload lengthï¼šä¼ è¾“æ•°æ®çš„é•¿åº¦</span><br><span class="hljs-comment">// å¦‚æœè¿™ä¸ªå€¼ä»¥å­—èŠ‚è¡¨ç¤ºæ˜¯0-125è¿™ä¸ªèŒƒå›´ï¼Œé‚£è¿™ä¸ªå€¼å°±è¡¨ç¤ºä¼ è¾“æ•°æ®çš„é•¿åº¦ï¼›</span><br><span class="hljs-comment">// å¦‚æœè¿™ä¸ªå€¼æ˜¯126ï¼Œåˆ™éšåçš„ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ª16è¿›åˆ¶æ— ç¬¦å·æ•°ï¼Œç”¨æ¥è¡¨ç¤ºä¼ è¾“æ•°æ®çš„é•¿åº¦ï¼›</span><br><span class="hljs-comment">// å¦‚æœè¿™ä¸ªå€¼æ˜¯127,åˆ™éšåçš„æ˜¯8ä¸ªå­—èŠ‚è¡¨ç¤ºçš„ä¸€ä¸ª64ä½æ— ç¬¦åˆæ•°ï¼Œè¿™ä¸ªæ•°ç”¨æ¥è¡¨ç¤ºä¼ è¾“æ•°æ®çš„é•¿åº¦</span><br>len = B % <span class="hljs-number">128</span><br>start = hasMask ? <span class="hljs-number">6</span> : <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">length</span> &lt; start + len) &#123;<br><span class="hljs-comment">// Not enough data in the buffer</span><br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// è·å–å®é™…çš„ payload length</span><br><span class="hljs-keyword">if</span> (len === <span class="hljs-number">126</span>) &#123;<br>len = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">readUInt16BE</span>(<span class="hljs-number">2</span>)<br>start += <span class="hljs-number">2</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (len === <span class="hljs-number">127</span>) &#123;<br><span class="hljs-comment">// Warning: JS can only store up to 2^53 in its number format</span><br>len = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">readUInt32BE</span>(<span class="hljs-number">2</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>) + <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">readUInt32BE</span>(<span class="hljs-number">6</span>)<br>start += <span class="hljs-number">8</span><br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">length</span> &lt; start + len) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// æå–æœ‰æ•ˆæ•°æ®</span><br>payload = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(start, start + len)<br><span class="hljs-comment">// å¦‚æœæœ‰Maskä½ï¼Œä½¿ç”¨ç»™å®šæ©ç è§£ç </span><br><span class="hljs-keyword">if</span> (hasMask) &#123;<br><span class="hljs-comment">// Decode with the given mask</span><br>mask = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(start - <span class="hljs-number">4</span>, start)<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; payload.<span class="hljs-property">length</span>; i++) &#123;<br>payload[i] ^= mask[i % <span class="hljs-number">4</span>]<br>&#125;<br>&#125;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">slice</span>(start + len)<br><br><span class="hljs-comment">// Proceeds to frame processing</span><br><span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processFrame</span>(fin, opcode, payload)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Connection.prototype.processFrame()</code> å¤„ç†æ¥æ”¶åˆ°çš„ç»™å®šå¸§(<code>frame</code>)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Connection</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">processFrame</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">fin, opcode, payload</span>) &#123;<br><span class="hljs-comment">// é“¾æ¥å…³é—­å¤„ç†</span><br><span class="hljs-keyword">if</span> (opcode === <span class="hljs-number">8</span>) &#123;<br><span class="hljs-comment">// Close frame</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">CLOSING</span>) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">end</span>()<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">OPEN</span>) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processCloseFrame</span>(payload)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125; <br><span class="hljs-comment">// å¿ƒè·³æ£€æŸ¥çš„ping å¤„ç†</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opcode === <span class="hljs-number">9</span>) &#123;<br><span class="hljs-comment">// Ping frame</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">OPEN</span>) &#123;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">write</span>(frame.<span class="hljs-title function_">createPongFrame</span>(payload.<span class="hljs-title function_">toString</span>(), !<span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span>))<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125; <br><span class="hljs-comment">// å¿ƒè·³æ£€æŸ¥çš„pong å¤„ç†</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opcode === <span class="hljs-number">10</span>) &#123;<br><span class="hljs-comment">// Pong frame</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;pong&#x27;</span>, payload.<span class="hljs-title function_">toString</span>())<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">OPEN</span>) &#123;<br><span class="hljs-comment">// Ignores if the connection isn&#x27;t opened anymore</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-comment">// è¿ç»­æ¶ˆæ¯å¸§å¤„ç†</span><br><span class="hljs-keyword">if</span> (opcode === <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> === <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// Unexpected continuation frame</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opcode !== <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> !== <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">// Last sequence didn&#x27;t finished correctly</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-keyword">if</span> (!opcode) &#123;<br><span class="hljs-comment">// Get the current opcode for fragmented frames</span><br>opcode = <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> === <span class="hljs-string">&#x27;string&#x27;</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span><br>&#125;<br><span class="hljs-comment">// æ–‡æœ¬æ¶ˆæ¯å¸§å¤„ç†</span><br><span class="hljs-keyword">if</span> (opcode === <span class="hljs-number">1</span>) &#123;<br><span class="hljs-comment">// Save text frame</span><br>payload = payload.<span class="hljs-title function_">toString</span>()<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> + payload : payload<br><br><span class="hljs-keyword">if</span> (fin) &#123;<br><span class="hljs-comment">// Emits &#x27;text&#x27; event</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;text&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span>)<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> = <span class="hljs-literal">null</span><br>&#125;<br>&#125; <br><span class="hljs-comment">// äºŒè¿›åˆ¶æ¶ˆæ¯å¸§å¤„ç†</span><br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Sends the buffer for InStream object</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span>) &#123;<br><span class="hljs-comment">// Emits the &#x27;binary&#x27; event</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InStream</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;binary&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span>)<br>&#125;<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span>.<span class="hljs-title function_">addData</span>(payload)<br><br><span class="hljs-keyword">if</span> (fin) &#123;<br><span class="hljs-comment">// Emits &#x27;end&#x27; event</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span>.<span class="hljs-title function_">end</span>()<br><span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> = <span class="hljs-literal">null</span><br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ•°æ®å‘é€"><a href="#æ•°æ®å‘é€" class="headerlink" title="æ•°æ®å‘é€"></a>æ•°æ®å‘é€</h3><p>å‘é€æ•°æ®ï¼Œéœ€è¦åˆ›å»ºä¸æ¥æ”¶æ—¶ä¸€æ ·çš„æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬<code>fin, opcode, mask, payload-length, mask-key</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Connection</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sendText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">str, callback</span>) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">OPEN</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">socket</span>.<span class="hljs-title function_">write</span>(frame.<span class="hljs-title function_">createTextFrame</span>(str, !<span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span>), callback)<br>&#125;<br>&#125;<br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–‡æœ¬frame</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextFrame</span>(<span class="hljs-params">data, masked</span>) &#123;<br><span class="hljs-keyword">var</span> payload, meta<br><br>payload = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(data)<br>meta = <span class="hljs-title function_">generateMetaData</span>(<span class="hljs-literal">true</span>, <span class="hljs-number">1</span>, masked === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">false</span> : masked, payload)<br><br><span class="hljs-keyword">return</span> <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">concat</span>([meta, payload], meta.<span class="hljs-property">length</span> + payload.<span class="hljs-property">length</span>)<br>&#125;<br><span class="hljs-comment">// åˆ›å»ºframeçš„å…ƒæ•°æ®éƒ¨åˆ†</span><br><span class="hljs-comment">// å¦‚æœframeè¢«å±è”½äº†ï¼Œåˆ™payloadä¼šç›¸åº”åœ°æ”¹å˜</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateMetaData</span>(<span class="hljs-params">fin, opcode, masked, payload</span>) &#123;<br><span class="hljs-keyword">var</span> len, meta, start, mask, i<br><br>len = payload.<span class="hljs-property">length</span><br><br><span class="hljs-comment">// ä¸ºå…ƒæ•°æ®åˆ›å»ºç¼“å†²åŒº</span><br>meta = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">2</span> + (len &lt; <span class="hljs-number">126</span> ? <span class="hljs-number">0</span> : (len &lt; <span class="hljs-number">65536</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">8</span>)) + (masked ? <span class="hljs-number">4</span> : <span class="hljs-number">0</span>))<br><br><span class="hljs-comment">// è®¾ç½® fin å’Œ opcode</span><br>meta[<span class="hljs-number">0</span>] = (fin ? <span class="hljs-number">128</span> : <span class="hljs-number">0</span>) + opcode<br><br><span class="hljs-comment">// è®¾ç½® Mask å’Œ length</span><br>meta[<span class="hljs-number">1</span>] = masked ? <span class="hljs-number">128</span> : <span class="hljs-number">0</span><br>start = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">126</span>) &#123;<br>meta[<span class="hljs-number">1</span>] += len<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">65536</span>) &#123;<br>meta[<span class="hljs-number">1</span>] += <span class="hljs-number">126</span><br>meta.<span class="hljs-title function_">writeUInt16BE</span>(len, <span class="hljs-number">2</span>)<br>start += <span class="hljs-number">2</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Warning: JS doesn&#x27;t support integers greater than 2^53</span><br>meta[<span class="hljs-number">1</span>] += <span class="hljs-number">127</span><br>meta.<span class="hljs-title function_">writeUInt32BE</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(len / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>)), <span class="hljs-number">2</span>)<br>meta.<span class="hljs-title function_">writeUInt32BE</span>(len % <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>), <span class="hljs-number">6</span>)<br>start += <span class="hljs-number">8</span><br>&#125;<br><br><span class="hljs-comment">// è®¾ç½®mask-key</span><br><span class="hljs-keyword">if</span> (masked) &#123;<br>mask = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">4</span>)<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>meta[start + i] = mask[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">256</span>)<br>&#125;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; payload.<span class="hljs-property">length</span>; i++) &#123;<br>payload[i] ^= mask[i % <span class="hljs-number">4</span>]<br>&#125;<br>start += <span class="hljs-number">4</span><br>&#125;<br><br><span class="hljs-keyword">return</span> meta<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®ä¸Šé¢çš„é€»è¾‘ï¼Œå®ç°ä¸€ä¸ªç®€å•ç‰ˆçš„websocketæœåŠ¡ï¼ŒåŒ…æ‹¬æ¡æ‰‹å’Œæ•°æ®æ”¶å‘åŠŸèƒ½</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> net = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;net&quot;</span>)<br><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>)<br><br><span class="hljs-comment">// é“¾æ¥çŠ¶æ€ç±»åˆ«</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONNECTING</span> = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OPEN</span> = <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// é»˜è®¤çŠ¶æ€</span><br><span class="hljs-keyword">let</span> readyState = <span class="hljs-variable constant_">CONNECTING</span><br><br><span class="hljs-comment">// websocket å…¥å£</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">myWebsocket</span> = (<span class="hljs-params">&#123;port, callback&#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> server = <span class="hljs-title function_">createServer</span>(callback)<br>  server.<span class="hljs-title function_">listen</span>(port)<br>&#125;<br><br><span class="hljs-comment">// åˆ›å»ºserver</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">createServer</span> = (<span class="hljs-params">callback</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> buffer<br>  <span class="hljs-keyword">const</span> server = net.<span class="hljs-title function_">createServer</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) &#123;<br><span class="hljs-comment">// ç›‘å¬ &quot;readable&quot; äº‹ä»¶ï¼Œä»è€Œè·å–è¯·æ±‚çš„æ•°æ®åŒ…</span><br>    socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;readable&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;readable....&#x27;</span>);<br>      <span class="hljs-title function_">doRead</span>(socket, callback)<br>    &#125;)<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">close</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>      readyState = <span class="hljs-variable constant_">CONNECTING</span><br>    &#125;<br>    socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;close&#x27;</span>, close)<br>    socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;error&#x27;</span>, close)<br>  &#125;)<br><br>  <span class="hljs-keyword">return</span> server<br>&#125;<br><br><span class="hljs-comment">// æ•°æ®è§£æ</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">doRead</span> = (<span class="hljs-params">socket, callback</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> buffer, headers<br><span class="hljs-comment">// ä»ç¼“å†²åŒºè·å–è¯·æ±‚çš„æ•°æ®</span><br>  buffer = socket.<span class="hljs-title function_">read</span>()<br><br><span class="hljs-comment">// æ¡æ‰‹å¤„ç†</span><br>  <span class="hljs-keyword">if</span> (buffer &amp;&amp; readyState === <span class="hljs-variable constant_">CONNECTING</span>) &#123;<br>    <span class="hljs-keyword">const</span> lines = buffer.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;\r\n&#x27;</span>)<br>    <span class="hljs-keyword">const</span> path = lines[<span class="hljs-number">0</span>].<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^GET (.*) HTTP\/1.1$/</span>)<br>    <span class="hljs-keyword">if</span> (path) &#123;<br>      <span class="hljs-comment">// console.log(lines);</span><br>      headers = <span class="hljs-title function_">readHeaders</span>(lines.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>))<br>      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">checkHeaders</span>(headers)) &#123;<br>        <span class="hljs-keyword">return</span> socket.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;HTTP/1.1 400 Switching Protocols \r\n\r\n&quot;</span>);<br>      &#125;<br><br>      readyState = <span class="hljs-variable constant_">OPEN</span>;<br>      socket.<span class="hljs-title function_">write</span>(<span class="hljs-string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span> + <span class="hljs-title function_">returnHeaders</span>(headers))<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// websocket è¿æ¥åè§£ææ•°æ®</span><br>    <span class="hljs-keyword">if</span> (readyState === <span class="hljs-variable constant_">OPEN</span>) &#123;<br>      <span class="hljs-keyword">const</span> payload = <span class="hljs-title function_">parseData</span>(buffer)<br><span class="hljs-comment">// ç”¨æˆ·ä¼ é€’çš„å›è°ƒ</span><br>      callback&amp;&amp;<span class="hljs-title function_">callback</span>(payload.<span class="hljs-title function_">toString</span>(), <span class="hljs-title function_">sendText</span>(socket))<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-comment">// è·å–headers</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">readHeaders</span> = (<span class="hljs-params">lines</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(lines.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> !!line).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> v = line.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^([a-zA-Z-]+): (.+)$/</span>)<br>    <span class="hljs-keyword">return</span> [v[<span class="hljs-number">1</span>].<span class="hljs-title function_">toLowerCase</span>(), v[<span class="hljs-number">2</span>]]<br>  &#125;));<br>&#125;<br><span class="hljs-comment">// æ£€æŸ¥headersä¸­æ˜¯å¦ç¬¦åˆwebsocketçš„è¯·æ±‚å¤´</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkHeaders</span> = (<span class="hljs-params">headers</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;connection&#x27;</span> <span class="hljs-keyword">in</span> headers &amp;&amp; <span class="hljs-string">&#x27;upgrade&#x27;</span> <span class="hljs-keyword">in</span> headers &amp;&amp; <span class="hljs-string">&#x27;sec-websocket-version&#x27;</span> <span class="hljs-keyword">in</span> headers &amp;&amp; <span class="hljs-string">&#x27;sec-websocket-key&#x27;</span> <span class="hljs-keyword">in</span> headers) &#123;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// åˆ‡æ¢åè®®æ—¶éœ€è¦è¿”å›çš„è¯·æ±‚å¤´</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">returnHeaders</span> = (<span class="hljs-params">headers</span>) =&gt; &#123;<br><span class="hljs-comment">// éœ€è¦ä½¿ç”¨sha1ç”Ÿæˆä¸€ä¸ª Sec-WebSocket-Accept</span><br>  <span class="hljs-keyword">const</span> sha1 = crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">&#x27;sha1&#x27;</span>)<br>  <span class="hljs-keyword">const</span> key = sha1.<span class="hljs-title function_">end</span>(headers[<span class="hljs-string">&#x27;sec-websocket-key&#x27;</span>] + <span class="hljs-string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span>).<span class="hljs-title function_">read</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;base64&#x27;</span>)<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">buildRequest</span>(&#123;<br>    <span class="hljs-title class_">Upgrade</span>: <span class="hljs-string">&#x27;websocket&#x27;</span>,<br><span class="hljs-title class_">Connection</span>: <span class="hljs-string">&#x27;Upgrade&#x27;</span>,<br><span class="hljs-string">&#x27;Sec-WebSocket-Accept&#x27;</span>: key<br>  &#125;)<br>&#125;<br><span class="hljs-comment">// ç”Ÿæˆè¿”å›çš„è¯·æ±‚å¤´æ ¼å¼</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">buildRequest</span> = (<span class="hljs-params">headers</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(headers).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">collect, key</span>) =&gt;</span> &#123;<br>    collect += <span class="hljs-string">`<span class="hljs-subst">$&#123;key&#125;</span>: <span class="hljs-subst">$&#123;headers[key]&#125;</span>\r\n`</span><br><br>    <span class="hljs-keyword">return</span> collect;<br>  &#125;, <span class="hljs-string">&#x27;&#x27;</span>) + <span class="hljs-string">&quot;\r\n&quot;</span><br>&#125;<br><span class="hljs-comment">// å‘é€æ–‡æœ¬æ•°æ®</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">sendText</span> = socket =&gt; <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br><span class="hljs-keyword">const</span> payload = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(data);<br><span class="hljs-keyword">const</span> meta = <span class="hljs-title function_">generateMetaData</span>(<span class="hljs-literal">true</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>, payload)<br><br>socket.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">concat</span>([meta, payload], meta.<span class="hljs-property">length</span> + payload.<span class="hljs-property">length</span>))<br>&#125;<br><br><span class="hljs-comment">// è¿™éƒ¨åˆ†é€»è¾‘æ˜¯ç›´æ¥æ‹¿è¿‡æ¥ç”¨çš„ï¼Œè¿˜æ˜¯åˆ«äººçš„æ›´é¦™ï¼Œæ³¨é‡Šå°±çœ‹ä¸Šé¢</span><br><span class="hljs-keyword">const</span> parseData = <span class="hljs-keyword">function</span> (<span class="hljs-params">buffer</span>) &#123;<br><span class="hljs-keyword">var</span> fin, opcode, B, <span class="hljs-variable constant_">HB</span>, mask, len, payload, start, i, hasMask<br><br><span class="hljs-keyword">if</span> (buffer.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// Is this the last frame in a sequence?</span><br>B = buffer[<span class="hljs-number">0</span>]<br><span class="hljs-variable constant_">HB</span> = B &gt;&gt; <span class="hljs-number">4</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">HB</span> % <span class="hljs-number">8</span>) &#123;<br><span class="hljs-comment">// RSV1, RSV2 and RSV3 must be clear</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>fin = <span class="hljs-variable constant_">HB</span> === <span class="hljs-number">8</span><br>opcode = B % <span class="hljs-number">16</span><br><br><span class="hljs-keyword">if</span> (opcode !== <span class="hljs-number">0</span> &amp;&amp; opcode !== <span class="hljs-number">1</span> &amp;&amp; opcode !== <span class="hljs-number">2</span> &amp;&amp;<br>opcode !== <span class="hljs-number">8</span> &amp;&amp; opcode !== <span class="hljs-number">9</span> &amp;&amp; opcode !== <span class="hljs-number">10</span>) &#123;<br><span class="hljs-comment">// Invalid opcode</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> (opcode &gt;= <span class="hljs-number">8</span> &amp;&amp; !fin) &#123;<br><span class="hljs-comment">// Control frames must not be fragmented</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br>B = buffer[<span class="hljs-number">1</span>]<br>hasMask = B &gt;&gt; <span class="hljs-number">7</span><br><span class="hljs-keyword">if</span> (!hasMask) &#123;<br><span class="hljs-comment">// Frames sent by clients must be masked</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>len = B % <span class="hljs-number">128</span><br>start = hasMask ? <span class="hljs-number">6</span> : <span class="hljs-number">2</span><br><br><span class="hljs-keyword">if</span> (buffer.<span class="hljs-property">length</span> &lt; start + len) &#123;<br><span class="hljs-comment">// Not enough data in the buffer</span><br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// Get the actual payload length</span><br><span class="hljs-keyword">if</span> (len === <span class="hljs-number">126</span>) &#123;<br>len = buffer.<span class="hljs-title function_">readUInt16BE</span>(<span class="hljs-number">2</span>)<br>start += <span class="hljs-number">2</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (len === <span class="hljs-number">127</span>) &#123;<br><span class="hljs-comment">// Warning: JS can only store up to 2^53 in its number format</span><br>len = buffer.<span class="hljs-title function_">readUInt32BE</span>(<span class="hljs-number">2</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>) + buffer.<span class="hljs-title function_">readUInt32BE</span>(<span class="hljs-number">6</span>)<br>start += <span class="hljs-number">8</span><br>&#125;<br><span class="hljs-keyword">if</span> (buffer.<span class="hljs-property">length</span> &lt; start + len) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// Extract the payload</span><br>payload = buffer.<span class="hljs-title function_">slice</span>(start, start + len)<br><span class="hljs-keyword">if</span> (hasMask) &#123;<br><span class="hljs-comment">// Decode with the given mask</span><br>mask = buffer.<span class="hljs-title function_">slice</span>(start - <span class="hljs-number">4</span>, start)<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; payload.<span class="hljs-property">length</span>; i++) &#123;<br>payload[i] ^= mask[i % <span class="hljs-number">4</span>]<br>&#125;<br>&#125;<br>buffer = buffer.<span class="hljs-title function_">slice</span>(start + len)<br><br><span class="hljs-comment">// Proceeds to frame processing</span><br><span class="hljs-keyword">return</span> payload<br>&#125;<br><span class="hljs-comment">// è¿™éƒ¨åˆ†é€»è¾‘æ˜¯ç›´æ¥æ‹¿è¿‡æ¥ç”¨çš„ï¼Œè¿˜æ˜¯åˆ«äººçš„æ›´é¦™ï¼Œæ³¨é‡Šå°±çœ‹ä¸Šé¢</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateMetaData</span>(<span class="hljs-params">fin, opcode, masked, payload</span>) &#123;<br><span class="hljs-keyword">var</span> len, meta, start, mask, i<br><br>len = payload.<span class="hljs-property">length</span><br><br><span class="hljs-comment">// Creates the buffer for meta-data</span><br>meta = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">2</span> + (len &lt; <span class="hljs-number">126</span> ? <span class="hljs-number">0</span> : (len &lt; <span class="hljs-number">65536</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">8</span>)) + (masked ? <span class="hljs-number">4</span> : <span class="hljs-number">0</span>))<br><br><span class="hljs-comment">// Sets fin and opcode</span><br>meta[<span class="hljs-number">0</span>] = (fin ? <span class="hljs-number">128</span> : <span class="hljs-number">0</span>) + opcode<br><br><span class="hljs-comment">// Sets the mask and length</span><br>meta[<span class="hljs-number">1</span>] = masked ? <span class="hljs-number">128</span> : <span class="hljs-number">0</span><br>start = <span class="hljs-number">2</span><br><span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">126</span>) &#123;<br>meta[<span class="hljs-number">1</span>] += len<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">65536</span>) &#123;<br>meta[<span class="hljs-number">1</span>] += <span class="hljs-number">126</span><br>meta.<span class="hljs-title function_">writeUInt16BE</span>(len, <span class="hljs-number">2</span>)<br>start += <span class="hljs-number">2</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Warning: JS doesn&#x27;t support integers greater than 2^53</span><br>meta[<span class="hljs-number">1</span>] += <span class="hljs-number">127</span><br>meta.<span class="hljs-title function_">writeUInt32BE</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(len / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>)), <span class="hljs-number">2</span>)<br>meta.<span class="hljs-title function_">writeUInt32BE</span>(len % <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>), <span class="hljs-number">6</span>)<br>start += <span class="hljs-number">8</span><br>&#125;<br><br><span class="hljs-comment">// Set the mask-key</span><br><span class="hljs-keyword">if</span> (masked) &#123;<br>mask = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">4</span>)<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>meta[start + i] = mask[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">256</span>)<br>&#125;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; payload.<span class="hljs-property">length</span>; i++) &#123;<br>payload[i] ^= mask[i % <span class="hljs-number">4</span>]<br>&#125;<br>start += <span class="hljs-number">4</span><br>&#125;<br><br><span class="hljs-keyword">return</span> meta<br>&#125;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = myWebsocket<br></code></pre></td></tr></table></figure><p>å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å°è£…å®Œæˆäº†ï¼Œå°±å¯ä»¥å¼•ç”¨æˆ‘ä»¬çš„ä»£ç æ¥è¯•ç”¨äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">myWebsocket</span>(&#123;<span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>, <span class="hljs-title function_">callback</span>(<span class="hljs-params">data, sendText</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received Data: &#x27;</span> + data);<br>  <span class="hljs-title function_">sendText</span>(data.<span class="hljs-title function_">toUpperCase</span>() + <span class="hljs-string">&quot;!!!!&quot;</span>);<br>&#125;&#125;)<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç»è¿‡å¯¹<code>nodejs-websocket</code>æºç çš„é˜…è¯»ï¼Œæˆ‘ä»¬ä»æ·±å±‚æ¬¡äº†è§£äº†<code>websocket</code>æ˜¯å¦‚ä½•è¿›è¡Œæ¡æ‰‹ï¼Œå¹¶ä¸”å¦‚ä½•ä»HTTPåè®®åˆ‡æ¢åˆ°<code>Web Socket</code>åè®®ï¼Œä»¥åŠåœ¨å¯¹æ•°æ®è¿›è¡Œè§£ææ—¶ï¼Œéœ€è¦é€šè¿‡å“ªäº›æ ‡å¿—ä½(<code>FIN, Opcode, Mask</code>ç­‰)æ¥å‘Šè¯‰æˆ‘ä»¬å½“å‰æ•°æ®çš„çŠ¶æ€æ˜¯æ€ä¹ˆæ ·çš„ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†ã€‚ç„¶ååœ¨ä»£ç çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½çš„å»å­¦ä¹ <code>Nodejs</code>æ˜¯å¦‚ä½•æ­å»ºä¸€ä¸ªæœåŠ¡ï¼Œå¹¶åŠ æ·±æˆ‘ä»¬å¯¹<code>nodejs</code>çš„å¼€å‘èƒ½åŠ›</p><p>ç¬”è€…èƒ½åŠ›æœ‰é™ï¼Œå€˜è‹¥åœ¨é˜…è¯»æ—¶ï¼Œæœ‰å“ªäº›ä¸æ˜¯å¾ˆæ‡‚ï¼Œæ¬¢è¿åœ¨<a href="https://github.com/yxlazy/blog/issues">è¿™é‡Œ</a>è¯„è®ºç•™è¨€ï¼Œå¤§å®¶ä¸€èµ·è®¨è®ºï¼Œå…±åŒè¿›æ­¥</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Sec-WebSocket-Accept">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Sec-WebSocket-Accept</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket">https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket</a></p><p><a href="https://juejin.cn/post/6844903463202062343">https://juejin.cn/post/6844903463202062343</a></p><p><a href="https://www.php.cn/http/http-http101.html">https://www.php.cn/http/http-http101.html</a></p><p><a href="https://www.jianshu.com/p/3444ea70b6cb">https://www.jianshu.com/p/3444ea70b6cb</a></p><p><a href="https://zhuanlan.zhihu.com/p/407711596">https://zhuanlan.zhihu.com/p/407711596</a></p><p><a href="https://github.com/sitegui/nodejs-websocket">https://github.com/sitegui/nodejs-websocket</a></p>]]></content>
    
    
    <categories>
      
      <category>node</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œå¦‚ä½•å®ç°shouldComponentUpdate</title>
    <link href="/2022/08/04/%E5%9C%A8%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E4%B8%AD%EF%BC%8C%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0shouldComponentUpdate/"/>
    <url>/2022/08/04/%E5%9C%A8%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E4%B8%AD%EF%BC%8C%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0shouldComponentUpdate/</url>
    
    <content type="html"><![CDATA[<p>åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å®ç°<code>class</code>ç»„ä»¶æ‰æœ‰çš„<code>shouldComponentUpdate()</code>ç”Ÿå‘½å‘¨æœŸå‘¢ï¼Ÿ</p><p>é¦–å…ˆæˆ‘ä»¬å¿…é¡»çŸ¥é“<code>shouldComponentUpdate()</code>çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œå®˜æ–¹æ–‡æ¡£è§£é‡Šçš„æ˜¯ï¼Œ<strong>å½“<code>props</code>å’Œ<code>state</code>å‘ç”Ÿæ”¹å˜æ—¶ï¼Œ<code>shouldComponentUpdate()</code>ä¼šåœ¨æ¸²æŸ“ä¹‹å‰è¢«è°ƒç”¨ï¼Œé»˜è®¤çš„è¿”å›å€¼æ˜¯<code>true</code>ï¼Œå½“è¿”å›å€¼ä¸º<code>false</code>æ—¶ï¼Œå°†ä¼šé˜»æ­¢æœ¬æ¬¡æ¸²æŸ“</strong></p><p>æ—¢ç„¶å·²ç»çŸ¥é“äº†å®ƒçš„ä½œç”¨ï¼Œé‚£æˆ‘ä»¬åœ¨å‡½æ•°ç»„ä»¶ä¸­è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p><p>åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œè¦é˜»æ­¢ç»„ä»¶é‡æ–°æ¸²æŸ“å°±éœ€è¦ä½¿ç”¨åˆ°<code>React.memo()</code>ï¼Œ<code>React.memo</code>æ˜¯ç±»ä¼¼äºé«˜é˜¶ç»„ä»¶ï¼Œä½†åªé€‚ç”¨äºå‡½æ•°ç»„ä»¶ï¼Œæˆ‘ä»¬åœ¨ç¬¬äºŒä¸ªå‚æ•°ä¸­ï¼Œé€šè¿‡è¿”å›<code>true</code>æ¥é˜»æ­¢å‡½æ•°ç»„ä»¶çš„æ¸²æŸ“ã€‚</p><p>å¯ä»¥å¤åˆ¶ä¸‹é¢çš„ä»£ç ï¼Œè¿è¡ŒæŸ¥çœ‹æ•ˆæœ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Component</span>, useState, memo &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">Child</span> = (<span class="hljs-params">props</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;props.type&#125;ç»„ä»¶æ¸²æŸ“ç»“æœï¼š&#123;props.text&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br><br><span class="hljs-comment">// å‡½æ•°ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ContentFn</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;å‡½æ•°&#x27;</span> &#123;<span class="hljs-attr">...props</span>&#125; /&gt;</span></span>;<br>&#125;, <span class="hljs-function">(<span class="hljs-params">prevProps, nextProps</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// è¿”å›trueï¼Œç»„ç»‡æ¸²æŸ“</span><br>  <span class="hljs-keyword">return</span> nextProps.<span class="hljs-property">disabled</span><br>&#125;);<br><br><span class="hljs-comment">// ç±»ç»„ä»¶</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(props);<br>  &#125;<br><br>  <span class="hljs-title function_">shouldComponentUpdate</span>(<span class="hljs-params">nextProps, nextState</span>) &#123;<br>    <span class="hljs-comment">// é˜»æ­¢æ¸²æŸ“</span><br>    <span class="hljs-keyword">return</span> !nextProps.<span class="hljs-property">disabled</span>;<br>  &#125;<br><br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;ç±»&#x27;</span> &#123;<span class="hljs-attr">...this.props</span>&#125; /&gt;</span></span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&quot;&quot;</span>);<br>  <span class="hljs-keyword">const</span> [disabled, setDisabled] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;(e)</span> =&gt;</span> setText(e.target.value)&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setDisabled((disabled) =&gt; !disabled)&#125;&gt;</span><br><span class="language-xml">          &#123;disabled ? &quot;æ­£å¸¸æ¸²æŸ“&quot; : &quot;é˜»æ­¢æ¸²æŸ“&quot;&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ContentFn</span> <span class="hljs-attr">text</span>=<span class="hljs-string">&#123;text&#125;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;disabled&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ContentClass</span> <span class="hljs-attr">text</span>=<span class="hljs-string">&#123;text&#125;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;disabled&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;<br><br></code></pre></td></tr></table></figure><p>ç‰¹åˆ«è¯´æ˜ï¼Œ<code>shouldComponentUpdate()</code>å’Œ<code>memo()</code>ä¸¤ä¸ªçš„è¿”å›å€¼ç›¸åï¼Œ<code>shouldComponentUpdate()</code>è¿”å›<code>false</code>ä¼šè·³è¿‡æ¸²æŸ“ï¼Œè€Œ<code>React.memo()</code>æ˜¯åœ¨è¿”å›<code>true</code>çš„æƒ…å†µä¸‹æ‰è·³è¿‡æ¸²æŸ“ã€‚</p><p>äº‹å®ä¸Šï¼Œ<code>React.memo()</code> å¹¶ä¸æ˜¯é˜»æ–­æ¸²æŸ“ï¼Œè€Œæ˜¯è·³è¿‡æ¸²æŸ“ç»„ä»¶çš„æ“ä½œå¹¶ç›´æ¥<strong>å¤ç”¨æœ€è¿‘ä¸€æ¬¡æ¸²æŸ“</strong>çš„ç»“æœï¼Œè¿™ä¸ <code>shouldComponentUpdate()</code> æ˜¯å®Œå…¨ä¸åŒçš„ã€‚</p><p>è€Œå¯¹äºè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ™éƒ½æ˜¯ç”¨äºæ€§èƒ½ä¼˜åŒ–çš„æ‰‹æ®µï¼Œåœ¨ç±»ç»„ä»¶ä¸­ï¼Œå®˜æ–¹æä¾›äº†<code>PrueComponent</code>ç±»ç»„ä»¶å®ç°äº†<code>shouldComponentUpdate()</code>ï¼Œåœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œ<code>React.memo()</code>é€šå¸¸éœ€è¦æ­é…<code>useCallback()</code>å’Œ<code>useMemo()</code>æ‰èƒ½æ›´å¥½çš„å‘æŒ¥å…¶ä½œç”¨ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•å®ç°åˆ†äº«æµ·æŠ¥</title>
    <link href="/2022/06/30/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB%E6%B5%B7%E6%8A%A5/"/>
    <url>/2022/06/30/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%88%86%E4%BA%AB%E6%B5%B7%E6%8A%A5/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠå…³äºå‰ç«¯ç”Ÿæˆæµ·æŠ¥çš„é—®é¢˜ï¼Œä¸€èˆ¬æˆ‘ä»¬åˆ¶ä½œæµ·æŠ¥ï¼Œéƒ½ä¼šé€‰æ‹©å‰ç«¯è¿›è¡Œç”Ÿæˆã€‚å°†éœ€è¦åˆ†äº«å‡ºå»çš„éƒ¨åˆ†çš„domç›´æ¥ç”Ÿæˆå›¾ç‰‡ï¼Œç„¶åæŠŠè¿™ä¸ªå›¾ç‰‡åˆ†äº«ç»™ç”¨æˆ·ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„æ˜¯<code>html2canvas</code>è¿™ä¸ªåº“ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥å®ç°ä¸€ä¸‹</p><blockquote><p>html2canvasæ–‡æ¡£åœ¨è¿™é‡Œ <a href="http://html2canvas.hertzen.com/">http://html2canvas.hertzen.com</a></p><p>æŸ¥çœ‹æœ¬æ–‡çš„å®Œæ•´ä»£ç å¯ç›´æ¥ç§»æ­¥åˆ°æ–‡ç« æœ«å°¾</p></blockquote><h2 id="åŠ¨æ‰‹æ—¶é—´ï¼ˆæŒ–å‘æ—¶é—´ï¼‰"><a href="#åŠ¨æ‰‹æ—¶é—´ï¼ˆæŒ–å‘æ—¶é—´ï¼‰" class="headerlink" title="åŠ¨æ‰‹æ—¶é—´ï¼ˆæŒ–å‘æ—¶é—´ï¼‰"></a>åŠ¨æ‰‹æ—¶é—´ï¼ˆæŒ–å‘æ—¶é—´ï¼‰</h2><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£å®‰è£…ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yarn add html2canvas<br></code></pre></td></tr></table></figure><p>å‡è®¾ä¸‹é¢å°±æ˜¯æˆ‘ä»¬è¦ç”Ÿæˆçš„æµ·æŠ¥å†…å®¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// from https://mobile.ant.design/zh/components/image</span><br><span class="hljs-keyword">const</span> demoSrc = <br>  <span class="hljs-string">&#x27;https://images.unsplash.com/photo-1567945716310-4745a6b7844b?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1500&amp;q=60&#x27;</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">SharePoster</span>(<span class="hljs-params"></span>) &#123;<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;wrapperRef&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#x27;share-poster&#x27;</span>&gt;</span></span><br><span class="language-xml">    &#123;/**å•†å“çš„å›¾ç‰‡ */&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;demoSrc&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#x27;share-poster--img&#x27;</span> <span class="hljs-attr">onLoad</span>=<span class="hljs-string">&#123;imgeLoad&#125;/</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯å¦ä¸€ä¸ªæ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯è¿˜æ˜¯ä¸€ä¸ªæ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">SharePoster</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œå†…å®¹æœ‰äº†ï¼Œè¯¥æ˜¯ç”Ÿç«â€¦ä¸å¯¹ï¼Œè¯¥æ˜¯ç”Ÿæˆæµ·æŠ¥çš„æ—¶å€™äº†ï¼Œæ·»åŠ <code>html2canvas</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> html2canvas <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;html2canvas&#x27;</span><br><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./index.less&#x27;</span><br><br><span class="hljs-keyword">const</span> demoSrc = <br>  <span class="hljs-string">&#x27;https://images.unsplash.com/photo-1567945716310-4745a6b7844b?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1500&amp;q=60&#x27;</span><br><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">SharePoster</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> wrapperRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>)<br><br>  <span class="hljs-comment">// ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">imgeLoad</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">if</span> (wrapperRef.<span class="hljs-property">current</span>) &#123;<br>      <span class="hljs-title function_">html2canvas</span>(wrapperRef.<span class="hljs-property">current</span>, &#123;<br>        <span class="hljs-attr">useCORS</span>: <span class="hljs-literal">true</span><br>      &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">canvas</span> =&gt;</span> &#123;<br>        <span class="hljs-comment">// å°†ç”Ÿæˆçš„canvasè½¬æ¢æˆbase64</span><br>        <span class="hljs-keyword">const</span> base64 = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">&#x27;image/png&#x27;</span>)<br>        <span class="hljs-comment">// åˆ°è¿™é‡Œæˆ‘ä»¬çš„æµ·æŠ¥å°±ç”Ÿæˆäº†</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(base64)<br><br>        <span class="hljs-comment">// ä¸‹è½½åˆ°æœ¬åœ°</span><br>        <span class="hljs-comment">// const a = document.createElement(&#x27;a&#x27;)</span><br>        <span class="hljs-comment">// a.href = base64</span><br>        <span class="hljs-comment">// a.download = +new Date() + &#x27;.png&#x27;</span><br>        <span class="hljs-comment">// a.click()</span><br>      &#125;)<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;wrapperRef&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#x27;share-poster&#x27;</span>&gt;</span></span><br><span class="language-xml">    &#123;/**å•†å“çš„å›¾ç‰‡ */&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;demoSrc&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#x27;share-poster--img&#x27;</span> <span class="hljs-attr">onLoad</span>=<span class="hljs-string">&#123;imgeLoad&#125;/</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯å¦ä¸€ä¸ªæ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯è¿˜æ˜¯ä¸€ä¸ªæ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">SharePoster</span><br></code></pre></td></tr></table></figure><p>æ­å–œğŸ‰ğŸ‰ğŸ‰ï¼Œä½ åœ¨1åˆ†é’Ÿä¸åˆ°çš„æ—¶é—´ï¼Œå°±å®Œæˆäº†äº§å“çš„éœ€æ±‚ï¼Œæˆ‘ä»¬ç°åœ¨å‘å¸ƒåˆ°çº¿ä¸Šå§</p><p>æµ‹è¯•ï¼šæˆ‘è¯´å¤§å…„å¼Ÿå‘€ï¼Œä½ è¿™å†™çš„å•¥å‘€ï¼Œä¸‹è½½ä¸‹æ¥çš„æµ·æŠ¥ï¼Œé™¤äº†æ–‡å­—ï¼Œå•†å“å›¾ç‰‡éƒ½æ²¡æœ‰ï¼Œä½ æ˜¯åœ¨ç©æˆ‘å—ï¼Ÿ</p><p>ï¼ï¼ï¼å’‹å›äº‹ï¼Œæœ¬åœ°ç¯å¢ƒä¸æ˜¯æ²¡æ¯›ç—…å—</p><h2 id="å¡«å‘æ—¶é—´"><a href="#å¡«å‘æ—¶é—´" class="headerlink" title="å¡«å‘æ—¶é—´"></a>å¡«å‘æ—¶é—´</h2><p>é¦–å…ˆæˆ‘ä»¬æœ‰äº†è§£åˆ°<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image">canvasä¸æ”¯æŒåŠ è½½è·¨åŸŸçš„å›¾ç‰‡èµ„æº</a>ï¼Œcanvasä¼šè®¤ä¸ºè¿™å›æ±¡æŸ“ç”»å¸ƒï¼Œè€Œhtml2canvasç”¨åˆ°äº†canvasï¼Œæ‰€ä»¥å°±å­˜åœ¨è½¬æ¢å›¾ç‰‡æ—¶å‡ºé”™ã€‚</p><p>é‚£æˆ‘ä»¬æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥ä»å¦ä¸€ä¸ªæ–¹å‘æ€è€ƒï¼Œæ—¢ç„¶ä¸è®©ç›´æ¥åŠ è½½å›¾ç‰‡ï¼Œé‚£æˆ‘ä»¬åŠ è½½base64çš„å›¾ç‰‡æ€»å¯ä»¥å§</p><p>å°†å›¾ç‰‡è½¬æ¢æˆbase64</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// from https://www.w3docs.com/snippets/javascript/how-to-convert-the-image-into-a-base64-string-using-javascript.html</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">toDataUrl</span>(<span class="hljs-params">src, callback</span>) &#123;<br>  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>()<br>  <span class="hljs-comment">// æ‰§è¡Œä¸€ä¸ªè·¨åŸŸè¯·æ±‚</span><br>  <span class="hljs-comment">// https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/img#attr-crossorigin</span><br>  image.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">&#x27;Anonymous&#x27;</span><br>  image.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;canvas&#x27;</span>)<br>    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&#x27;2d&#x27;</span>)<br>    <span class="hljs-comment">// å°†å›¾ç‰‡ç”»åˆ°canvasä¸­</span><br>    ctx.<span class="hljs-title function_">drawImage</span>(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">const</span> dataURL = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">&#x27;image/png&#x27;</span>)<br><br>    <span class="hljs-title function_">callback</span>(dataURL)<br>  &#125;<br>  <span class="hljs-comment">// åŠ è½½å›¾ç‰‡</span><br>  image.<span class="hljs-property">src</span> = src<br>&#125;<br></code></pre></td></tr></table></figure><p>æ›´æ”¹<code>SharePoster</code>ç»„ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// ....</span><br><span class="hljs-keyword">const</span> [base64, setBase64] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">toDataUrl</span>(demoSrc, setBase64)<br>&#125;, [])<br><br><span class="hljs-comment">// ç­‰å¾…å›¾ç‰‡è½¬æ¢æˆbase64</span><br><span class="hljs-keyword">if</span> (!base64) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span><br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;wrapperRef&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#x27;share-poster&#x27;</span>&gt;</span></span><br><span class="language-xml">  &#123;/**å•†å“çš„å›¾ç‰‡ */&#125;</span><br><span class="language-xml">  &#123;/**ç°åœ¨è¿™é‡Œä½¿ç”¨base64ï¼Œè€Œä¸æ˜¯å›¾ç‰‡åœ°å€ */&#125;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;base64&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#x27;share-poster--img&#x27;</span> <span class="hljs-attr">onLoad</span>=<span class="hljs-string">&#123;imgeLoad&#125;/</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯å¦ä¸€ä¸ªæ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>è¿™æ˜¯è¿˜æ˜¯ä¸€ä¸ªæ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>å¯¹äºåšäº†cdnå¤„ç†çš„å›¾ç‰‡ï¼Œéœ€è¦åœ¨å›¾ç‰‡èµ„æºå°¾éƒ¨åŠ ä¸ªæ—¶é—´æˆ³ï¼Œé¿å…åŠ è½½ç¼“å­˜å¯¼è‡´ç”Ÿæˆæµ·æŠ¥å¤±è´¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// ...</span><br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">toDataUrl</span>(demoSrc + <span class="hljs-string">&#x27;v=&#x27;</span> + +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), setBase64)<br>  &#125;, [])<br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><blockquote><p>å®Œæ•´ä»£ç  <a href="https://codesandbox.io/s/share-poster-vg3gt6">https://codesandbox.io/s/share-poster-vg3gt6</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>h5</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨husky+lint-stagedè§„èŒƒä»£ç æ ¼å¼</title>
    <link href="/2022/03/03/%E4%BD%BF%E7%94%A8husky+lint-staged%E8%A7%84%E8%8C%83%E4%BB%A3%E7%A0%81%E6%A0%BC%E5%BC%8F/"/>
    <url>/2022/03/03/%E4%BD%BF%E7%94%A8husky+lint-staged%E8%A7%84%E8%8C%83%E4%BB%A3%E7%A0%81%E6%A0%BC%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<ol><li>å®‰è£…<code>eslint, prettier</code>å’Œ<code>lint-staged</code><blockquote><p>æ­¤å¤„å¹¶ä¸æ‰“ç®—åˆ—å‡ºeslintrc.jså’Œprettierrc.jsçš„å…·ä½“é…ç½®ï¼Œå…·ä½“é…ç½®è¯·è‡ªè¡Œç™¾åº¦</p></blockquote></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">yarn add eslint prettier lint-staged --dev<br>npx husky-init &amp;&amp; yarn<br></code></pre></td></tr></table></figure><ol start="2"><li>æ›´æ”¹<code>pre-commit.sh</code>ä¸‹çš„å‘½ä»¤ä¸º<br><code>npx lint-staged</code></li></ol><blockquote><p><code>pre-commit</code> æ˜¯æ‰§è¡Œ<code>git commit</code>æ—¶çš„<code>hook</code></p></blockquote><ol start="3"><li>åœ¨package.jsonä¸‹é…ç½®</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;lint-staged&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;**/*.&#123;js, jsx, ts, tsx&#125;&quot;</span>: [<br>      &lt;!-- æ¯æ¬¡commitæ—¶ï¼Œéƒ½å°†æ›´æ”¹çš„æ–‡ä»¶è¿›è¡Œæ ¼å¼æ£€æŸ¥å¹¶æ ¼å¼åŒ– --&gt;<br>      <span class="hljs-string">&quot;eslint --fix&quot;</span>,<br>      &lt;!-- å¦‚æœæœ‰æ ¼å¼åŒ–çš„æ–‡ä»¶ï¼Œå°±å°†å…¶æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œæ–¹ä¾¿commitæäº¤æ–‡ä»¶ --&gt;<br>      <span class="hljs-string">&quot;git add&quot;</span><br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>åœ¨eslintä½¿ç”¨prettier</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">yarn add eslint-plugin-prettier eslint-config-prettier --dev<br></code></pre></td></tr></table></figure><ol start="5"><li>åœ¨eslintrc.jsæ–‡ä»¶æ·»åŠ å¦‚ä¸‹é…ç½®</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  &lt;!-- ä¸€å®šè¦æ”¾åˆ°æœ€åé¢ï¼Œæ‰èƒ½è¦†ç›–å…¶ä»–é…ç½® æ³¨ï¼šv8ä¹‹åå°±æ˜¯ä½¿ç”¨å¦‚ä¸‹æ ¼å¼--&gt;<br>  <span class="hljs-attr">extends</span>: [<span class="hljs-string">&#x27;prettier&#x27;</span>],<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">&#x27;prettier&#x27;</span>],<br>  <span class="hljs-attr">rules</span>: &#123;<br>    &lt;!-- ä½¿ç”¨prettier, é»˜è®¤ä¼šä½¿ç”¨.<span class="hljs-property">prettierrc</span>.<span class="hljs-property">js</span>ä¸­çš„è§„åˆ™ --&gt;<br>    <span class="hljs-string">&quot;prettier/prettier&quot;</span>: <span class="hljs-string">&quot;error&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>other</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä»£ç è§„èŒƒ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>axiosæºç å­¦ä¹ </title>
    <link href="/2022/03/01/axios%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/03/01/axios%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p><code>axios</code>æ˜¯ä¸€ä¸ªè½»é‡æ— ä¾èµ–çš„<code>Promise</code>ç‰ˆçš„<code>http</code>è¯·æ±‚åº“ï¼Œä¸ä»…å¯ä»¥åœ¨æµè§ˆå™¨ç«¯ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨nodeç«¯ä½¿ç”¨ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹è¿™æ¬¾å¤‡å—æ¬¢è¿çš„åº“ã€‚</p><p>åœ¨ä½¿ç”¨<code>axios</code>æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å‘èµ·ä¸€ä¸ª<code>axios</code>è¯·æ±‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">axios</span>(&#123;&#125;)<br><span class="hljs-keyword">new</span> axios.<span class="hljs-title class_">Axios</span>(&#123;&#125;)<br>axios.<span class="hljs-title function_">create</span>(&#123;&#125;)<br>axios[<span class="hljs-string">&#x27;get&#x27;</span>]()<br></code></pre></td></tr></table></figure><p>å…¶å®æœ€åéƒ½æ˜¯è°ƒç”¨çš„<code>Axios.prototype.request</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹<code>createInstance()</code>è¿™ä¸ªå‡½æ•°åˆ°åº•åšäº†ä»€ä¹ˆï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯ç”¨æˆ·åˆ›å»ºä¸€ä¸ª<code>axios</code>å¯¹è±¡ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createInstance</span>(<span class="hljs-params">defaultConfig</span>) &#123;<br>  <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªaxioså¯¹è±¡</span><br>  <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Axios</span>(defaultConfig);<br>  <span class="hljs-comment">// ç»‘å®šAxios.prototype.requestä¸­çš„thiså¹¶åˆ›å»ºä¸€ä¸ªinstanceå˜é‡</span><br>  <span class="hljs-keyword">var</span> instance = <span class="hljs-title function_">bind</span>(<span class="hljs-title class_">Axios</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">request</span>, context);<br>  <span class="hljs-comment">// å°†AxiosåŸå‹å¯¹è±¡æ‰©å±•åˆ°instanceä¸Šï¼Œå¹¶ç»‘å®šthis</span><br>  <span class="hljs-comment">// Copy axios.prototype to instance</span><br>  utils.<span class="hljs-title function_">extend</span>(instance, <span class="hljs-title class_">Axios</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, context);<br>  <span class="hljs-comment">// å°†axioså¯¹è±¡ä¸Šçš„å±æ€§æ‰©å±•åˆ°instanceä¸Š</span><br>  <span class="hljs-comment">// Copy context to instance</span><br>  utils.<span class="hljs-title function_">extend</span>(instance, context);<br><br>  <span class="hljs-comment">// æš´éœ²å‡ºä¸€ä¸ªcreateæ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•åˆ›å»ºaxioså¯¹è±¡</span><br>  <span class="hljs-comment">// Factory for creating new instances</span><br>  instance.<span class="hljs-property">create</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">instanceConfig</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createInstance</span>(<span class="hljs-title function_">mergeConfig</span>(defaultConfig, instanceConfig));<br>  &#125;;<br>  <span class="hljs-comment">// è¿”å›instanceå¯¹è±¡ï¼Œè¿™ä¸ªå°±æ˜¯æ–°çš„axioså¯¹è±¡äº†</span><br>  <span class="hljs-keyword">return</span> instance;<br>&#125;<br><span class="hljs-comment">// æ–°çš„axioså¯¹è±¡</span><br><span class="hljs-keyword">var</span> axios = <span class="hljs-title function_">createInstance</span>(defaults);<br><span class="hljs-comment">// Axiosæ„é€ å‡½æ•°ç»‘å®šåˆ°axiosä¸Š</span><br>axios.<span class="hljs-property">Axios</span> = <span class="hljs-title class_">Axios</span>;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬ç€é‡çœ‹ä¸€ä¸‹<code>Axios.prototype.request</code>æ–¹æ³•, æ–¹æ³•å‰é¢éƒ¨åˆ†éƒ½æ˜¯å¯¹é…ç½®çš„ä¸€äº›å¤„ç†ï¼ˆå°±ä¸ç»†è®²äº†ï¼‰ï¼Œ<br>ç„¶åä»è¿™é‡Œå¼€å§‹ï¼ˆä¹Ÿå°±æ˜¯ä¸‹é¢ä»£ç æ‰€ç¤ºï¼‰ï¼Œè¿™æ˜¯<code>axios</code>çš„æ‹¦æˆªå™¨å¤„ç†ã€‚</p><p>é¦–å…ˆçœ‹ä¸€ä¸‹è¯·æ±‚æ‹¦æˆªå™¨ï¼š<br>è¯·æ±‚æ‹¦æˆªå™¨ä¼šä¾æ¬¡å°†<code>interceptor.fulfilled</code>å’Œ<code>interceptor.rejected</code>å¾€æ•°ç»„ï¼ˆ<code>requestInterceptorChain</code>ï¼‰çš„å‰é¢æ”¾</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// lib\core\Axios.js</span><br><span class="hljs-comment">// ç”¨äºå­˜å‚¨è¯·æ±‚æ‹¦æˆªå™¨çš„å›è°ƒ</span><br>  <span class="hljs-keyword">var</span> requestInterceptorChain = [];<br>  <span class="hljs-comment">// åœ¨å¯¹è¯·æ±‚æ‹¦æˆªå™¨è¿›è¡Œå¤„ç†æ—¶ï¼Œæ˜¯é‡‡ç”¨åŒæ­¥å¤„ç†æ–¹å¼è¿˜æ˜¯é‡‡ç”¨å¼‚æ­¥å¤„ç†çš„æ–¹å¼ï¼Œé»˜è®¤åœ¨æ²¡æœ‰æ·»åŠ æ‹¦æˆªå™¨æ—¶æ—¶åŒæ­¥ï¼Œæ·»åŠ æ‹¦æˆªå™¨åæ˜¯å¼‚æ­¥</span><br>  <span class="hljs-keyword">var</span> synchronousRequestInterceptors = <span class="hljs-literal">true</span>;<br>  <span class="hljs-comment">// éå†æ·»åŠ çš„æ‹¦æˆªå™¨</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">unshiftRequestInterceptors</span>(<span class="hljs-params">interceptor</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> interceptor.<span class="hljs-property">runWhen</span> === <span class="hljs-string">&#x27;function&#x27;</span> &amp;&amp; interceptor.<span class="hljs-title function_">runWhen</span>(config) === <span class="hljs-literal">false</span>) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  <span class="hljs-comment">// interceptor.synchronousæ¥è‡ªæ·»åŠ æ‹¦æˆªå™¨æ—¶ï¼Œæ‰€é…ç½®çš„é€‰é¡¹</span><br>    synchronousRequestInterceptors = synchronousRequestInterceptors &amp;&amp; interceptor.<span class="hljs-property">synchronous</span>;<br>    <span class="hljs-comment">// è¿™é‡Œå°†æ¯ä¸ªè¿­ä»£å™¨ä»¥fulfilledå’Œrejectedä¸ºä¸€ç»„çš„å½¢å¼ï¼Œä¾æ¬¡æ”¾åˆ°æ•°ç»„çš„å‰é¢</span><br>    requestInterceptorChain.<span class="hljs-title function_">unshift</span>(interceptor.<span class="hljs-property">fulfilled</span>, interceptor.<span class="hljs-property">rejected</span>);<br>  &#125;);<br></code></pre></td></tr></table></figure><p>å“åº”æ‹¦æˆªå™¨å¤„ç†:<br>å“åº”æ‹¦æˆªå™¨ä¼šä¾æ¬¡å°†<code>interceptor.fulfilled</code>å’Œ<code>interceptor.rejected</code>å¾€æ•°ç»„ï¼ˆ<code>responseInterceptorChain</code>ï¼‰çš„åé¢æ”¾</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// ç”¨äºå­˜å‚¨å“åº”æ‹¦æˆªå™¨çš„å›è°ƒ</span><br>  <span class="hljs-keyword">var</span> responseInterceptorChain = [];<br>  <span class="hljs-comment">// éå†æ·»åŠ çš„æ‹¦æˆªå™¨</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">pushResponseInterceptors</span>(<span class="hljs-params">interceptor</span>) &#123;<br>    <span class="hljs-comment">// è¿™é‡Œå°†æ¯ä¸ªè¿­ä»£å™¨ä»¥fulfilledå’Œrejectedä¸ºä¸€ç»„çš„å½¢å¼ï¼Œä¾æ¬¡æ”¾åˆ°æ•°ç»„çš„åé¢</span><br>    responseInterceptorChain.<span class="hljs-title function_">push</span>(interceptor.<span class="hljs-property">fulfilled</span>, interceptor.<span class="hljs-property">rejected</span>);<br>  &#125;);<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä¼šå¦‚æ­¤æ”¾ç½®å‘¢ï¼Ÿåœ¨è®¨è®ºè¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ‹¦æˆªå™¨ï¼ˆinterceptorsï¼‰æ˜¯æ€ä¹ˆå­˜æ”¾æˆ‘ä»¬æ³¨å†Œçš„æ‹¦æˆªå™¨çš„ã€‚æ‹¦æˆªå™¨æ˜¯åœ¨æˆ‘ä»¬åˆ›å»ºaxioså®ä¾‹çš„æ—¶å€™åˆ›å»ºçš„ï¼Œå®ƒä»¬éƒ½æ˜¯åŒä¸€ä¸ªæ„é€ å‡½æ•°çš„ä¸¤ä¸ªä¸åŒçš„å®ä¾‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// lib\core\Axios.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Axios</span>(<span class="hljs-params">instanceConfig</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaults</span> = instanceConfig;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptors</span> = &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªè¯·æ±‚æ‹¦æˆªå™¨å¯¹è±¡</span><br>    <span class="hljs-attr">request</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorManager</span>(),<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå“åº”æ‹¦æˆªå™¨å¯¹è±¡</span><br>    <span class="hljs-attr">response</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorManager</span>()<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‹¦æˆªå™¨çš„æ„é€ å‡½æ•°ã€‚å½“æˆ‘ä»¬åœ¨è°ƒç”¨axios.interceptors.request.use()æ—¶ï¼Œå…¶å®å°±æ˜¯å‘è¿™ä¸ªthis.handlersçš„æœ«å°¾æ³¨å†Œä¸€ä¸ªæ‹¦æˆªå™¨å›è°ƒ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//lib\core\InterceptorManager.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">InterceptorManager</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// å­˜æ”¾æ·»åŠ çš„æ‹¦æˆªå™¨å›è°ƒ</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span> = [];<br>&#125;<br><br><span class="hljs-comment">// æ³¨å†Œæ‹¦æˆªå™¨</span><br><span class="hljs-title class_">InterceptorManager</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">use</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">use</span>(<span class="hljs-params">fulfilled, rejected, options</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-title function_">push</span>(&#123;<br>    <span class="hljs-attr">fulfilled</span>: fulfilled,<br>    <span class="hljs-attr">rejected</span>: rejected,<br>    <span class="hljs-attr">synchronous</span>: options ? options.<span class="hljs-property">synchronous</span> : <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">runWhen</span>: options ? options.<span class="hljs-property">runWhen</span> : <span class="hljs-literal">null</span><br>  &#125;);<br>  <span class="hljs-comment">// è¿”å›ä¸€ä¸ªå·²æ³¨å†Œæ‹¦æˆªå™¨çš„idï¼Œç”¨äºæ³¨é”€æ·»åŠ çš„æ‹¦æˆªå™¨</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;<br>&#125;;<br><br><span class="hljs-comment">// è¿™æ˜¯ä¸Šé¢è¿­ä»£æ‹¦æˆªå™¨çš„æ–¹æ³•ï¼Œæ‹¦æˆªå™¨å¯¹è±¡è‡ªå·±å®ç°äº†ä¸€ä¸ªè¿­ä»£æ–¹æ³•</span><br><span class="hljs-title class_">InterceptorManager</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">forEach</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">forEach</span>(<span class="hljs-params">fn</span>) &#123;<br>  utils.<span class="hljs-title function_">forEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">handlers</span>, <span class="hljs-keyword">function</span> <span class="hljs-title function_">forEachHandler</span>(<span class="hljs-params">h</span>) &#123;<br>    <span class="hljs-keyword">if</span> (h !== <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-title function_">fn</span>(h);<br>    &#125;<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸Šé¢æˆ‘ä»¬æå‡ºçš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¼šå¦‚æ­¤æ’åˆ—ï¼Ÿ<br>çœ‹ä»£ç ä¸Šçš„æ³¨é‡Š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// ç”¨æ¥ä¿å­˜ä¸Šä¸€æ¬¡promise.thenå¤„ç†åçš„ç»“æœ</span><br><span class="hljs-keyword">var</span> promise;<br><span class="hljs-comment">// å°†è¯·æ±‚æ‹¦æˆªå™¨å¤„ç†æ”¾åˆ°promiseä¸­è¿›è¡Œå¼‚æ­¥å¤„ç†</span><br><span class="hljs-keyword">if</span> (!synchronousRequestInterceptors) &#123;<br>  <span class="hljs-comment">// å­˜å‚¨æ‰€æœ‰çš„æ“ä½œï¼ŒåŒ…æ‹¬è¯·æ±‚æ‹¦æˆªå™¨å’Œå“åº”æ‹¦æˆªå™¨çš„å¤„ç†ï¼ŒdispatchRequestç”¨æ¥å‘èµ·è¯·æ±‚, è®¾ç½®undefinedæ˜¯ä¸ºäº†å ä½</span><br>  <span class="hljs-keyword">var</span> chain = [dispatchRequest, <span class="hljs-literal">undefined</span>];<br>  <span class="hljs-comment">// è¯·æ±‚æ‹¦æˆªå™¨å’Œå“åº”æ‹¦æˆªå™¨ä¸€å‰ä¸€åæ”¾å…¥chainä¸­</span><br>  <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">unshift</span>.<span class="hljs-title function_">apply</span>(chain, requestInterceptorChain);<br>  chain = chain.<span class="hljs-title function_">concat</span>(responseInterceptorChain);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåšçš„å¤„ç†ï¼Œæˆ‘è§‰å¾—å¯ä»¥è¯´æ˜¯éå¸¸åä¸½äº†ï¼ˆä¸€åªèœæ±ªè·¯è¿‡ï¼‰</p><ol><li><p>æˆ‘ä»¬å‰é¢å·²ç»å°†æ‰€æœ‰çš„æ‹¦æˆªå™¨éƒ½æ”¾å…¥äº†chainæ•°ç»„ä¸­ï¼Œè€Œä¸”å­˜æ”¾çš„æ ¼å¼æ˜¯è¿™æ ·çš„<br><code>[fulfilled1, rejected1, fulfilled2, rejected2, ...dispatchRequest, undefined, fulfilled1, rejected1,fulfilled2, rejected2, ...]</code></p></li><li><p>è¿™é‡Œé€šè¿‡ä¸€ä¸ªwhileå¾ªç¯æ¥éå†è¿™ä¸ªæ•°ç»„ï¼ˆä¹Ÿå°±æ˜¯chainï¼‰ï¼Œå¹¶è¿›è¡Œå¤„ç†</p></li><li><p><code>promise = promise.then(chain.shift(), chain.shift());</code> å°±æ˜¯ç”¨æ¥é˜Ÿåˆ—å¤„ç†æ•´ä¸ªchain</p></li><li><p>ç¬¬ä¸€æ¬¡å¾ªç¯<code>promise = promise.then(fulfilled1, rejected1)</code>å¤„ç†ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨å›è°ƒï¼Œç­‰å¤„ç†ç»“æŸåèµ‹å€¼ç»™promiseï¼Œ</p></li><li><p>æ¥ç€ç¬¬äºŒæ¬¡è¿›å…¥å¾ªç¯<code>promise = promise.then(fulfilled2, rejected2)</code><br>â€¦</p></li><li><p>å½“å¤„ç†åˆ°<code>dispatchRequest, undefined</code>æ—¶ï¼Œè¯æ˜è¯·æ±‚æ‹¦æˆªå™¨å·²ç»å¤„ç†å®Œæˆï¼Œå¼€å§‹å‘èµ·è¯·æ±‚ï¼Œç­‰è¯·æ±‚ç»“æœå›æ¥ï¼Œè¿›å…¥å“åº”æ‹¦æˆªå™¨çš„å¤„ç†</p></li><li><p><code>promise = promise.then(fulfilled1, rejected1)</code>ï¼ŒåŒæ ·çš„ä¾æ¬¡è¿›è¡Œæ¯ä¸ªæ‹¦æˆªå™¨çš„å›è°ƒ</p></li><li><p>æœ€åè¿”å›è¿™ä¸ªç»è¿‡è¯·æ±‚æ‹¦æˆªå™¨å¤„ç†ï¼Œå‘èµ·è¯·æ±‚å¤„ç†ï¼Œå’Œå“åº”æ‹¦æˆªå™¨å¤„ç†çš„ç»“æœ â€“ promise</p></li></ol><blockquote><p>æ³¨ï¼šåœ¨å¤„ç†è¯·æ±‚æ‹¦æˆªå™¨æ—¶ï¼Œ<em>æœ€å…ˆæ·»åŠ åˆ°è¯·æ±‚æ‹¦æˆªå™¨çš„å›è°ƒï¼Œä¼šæœ€åæ‰§è¡Œï¼›ç›¸åï¼Œå¯¹äºå“åº”æ‹¦æˆªå™¨çš„å¤„ç†æ˜¯ï¼Œæœ€å…ˆæ·»åŠ åˆ°å“åº”æ‹¦æˆªå™¨çš„å›è°ƒæœ€å…ˆæ‰§è¡Œ</em></p></blockquote><p>å‡ å¥ä»£ç ï¼Œä½†è¿™åˆ†é‡ç¡®å®è¶³ï¼ˆå­¦åˆ°äº†ï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">  promise = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(config);<br>  <span class="hljs-keyword">while</span> (chain.<span class="hljs-property">length</span>) &#123;<br>    promise = promise.<span class="hljs-title function_">then</span>(chain.<span class="hljs-title function_">shift</span>(), chain.<span class="hljs-title function_">shift</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> promise;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œæ˜¯æŠŠè¯·æ±‚æ‹¦æˆªå¤„ç†å½“åšå¼‚æ­¥æ¥å¤„ç†çš„ï¼Œå¯¹äºåŒæ­¥å¤„ç†ï¼Œæ˜¯å°†æ•´ä¸ªå¤„ç†åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†è¿›è¡Œå¤„ç†çš„ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯è¯·æ±‚æ‹¦æˆªå™¨éƒ¨åˆ†ï¼Œæ˜¯åŒæ­¥å¤„ç†çš„ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯å‘èµ·è¯·æ±‚çš„éƒ¨åˆ†å’Œå“åº”æ‹¦æˆªå™¨éƒ¨åˆ†åˆåœ¨ä¸€èµ·è¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œå°±å’Œä¸Šé¢çš„ä¸€æ ·äº†</p></blockquote><p>æ€»ç»“ï¼šå¯ä»¥çœ‹åˆ°åœ¨promise.thenå¤„ç†çš„æ—¶å€™ï¼Œæ­£å¥½ä¸€ä¸ªæ˜¯fulfilledå›è°ƒï¼Œä¸€ä¸ªæ˜¯rejectedå›è°ƒï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å°†æ‹¦æˆªå™¨æ³¨å†Œçš„å›è°ƒä¹Ÿä¾æ¬¡æŒ‰è¿™æ ·æ’åˆ—å°±æ­£å¥½æ–¹ä¾¿æˆ‘ä»¬å¤„ç†ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬å°†çœŸæ­£å‘èµ·è¯·æ±‚çš„å¤„ç†ä¹ŸæŒ‰ç€æˆå¯¹çš„é€»è¾‘å¹¶æ”¾ç½®åœ¨ä¸­é—´ï¼Œå°±èƒ½ä¿è¯å¤„ç†çš„é¡ºåºæ˜¯æŒ‰ç…§ï¼šå¤„ç†è¯·æ±‚æ‹¦æˆªå™¨ &#x3D;&gt; å‘èµ·è¯·æ±‚ &#x3D;&gt; å¤„ç†å“åº”æ‹¦æˆªå™¨çš„é¡ºåº</p>]]></content>
    
    
    <categories>
      
      <category>other</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react-router v6 apiå­¦ä¹ </title>
    <link href="/2022/02/15/react-router%20v6%20api%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/02/15/react-router%20v6%20api%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>react routerç›®å‰å·²ç»æ›´æ–°åˆ°v6ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬ä¸ä»…ä½¿ç”¨<code>TypeScript</code>è¿›è¡Œäº†é‡æ„ï¼Œè€Œä¸”è¿˜æ–°å¢äº†å¾ˆå¤šçš„åŠŸèƒ½ï¼Œå…¶ä¸v5ç‰ˆæœ¬å¯ä»¥è¯´å·²å®Œå…¨æ²¡æœ‰å…³è”ã€‚<br>ç°åœ¨v6å·²æˆä¸ºé»˜è®¤å®‰è£…ç‰ˆæœ¬ã€‚</p><p>react router v6åˆ†ä¸º3ä¸ªåŒ…ï¼š</p><ul><li>react-router: åŒ…å«æ ¸å¿ƒåŠŸèƒ½</li><li>react-router-dom: webç«¯ä½¿ç”¨çš„åŒ…</li><li>react-router-native: rnç«¯ä½¿ç”¨çš„åŒ…<blockquote><p>react-router-domå’Œreact-router-nativeå·²ç»è‡ªåŠ¨å¼•å…¥äº†react-routerï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¼€å‘æ—¶ï¼Œåªéœ€è¦å®‰è£…å¯¹åº”å¼€å‘ç¯å¢ƒçš„åŒ…å³å¯</p></blockquote></li></ul><h2 id="å¼•ç”¨è·¯ç”±ç»„ä»¶"><a href="#å¼•ç”¨è·¯ç”±ç»„ä»¶" class="headerlink" title="å¼•ç”¨è·¯ç”±ç»„ä»¶"></a>å¼•ç”¨è·¯ç”±ç»„ä»¶</h2><p>å¯¹äºwebç«¯ï¼Œæ”¯æŒä¸¤ç§å½¢å¼çš„è·¯ç”±:</p><ul><li><code>&lt;HashRouter /&gt;</code>: hashè·¯ç”±ï¼Œå½“è·¯ç”±å‘ç”Ÿæ”¹å˜ä¸ä¼šé‡æ–°å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚</li><li><code>&lt;BrowserRouter /&gt;</code>: ä½¿ç”¨æµè§ˆå™¨å†…ç½®å†å²å †æ ˆè¿›è¡Œå¯¼èˆª</li></ul><blockquote><p>æ–°çš„ç»„ä»¶å·²ä¸å†éœ€è¦æ˜¾ç¤ºæ·»åŠ historyï¼Œå…¶å·²ç»åœ¨ç»„ä»¶å†…éƒ¨å®ç°</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// ä½¿ç”¨hash</span><br><span class="hljs-keyword">import</span> &#123;<span class="hljs-title class_">HashRouter</span>, <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span>(<br>    &lt;HashRouter&gt;<br>      &lt;Routes&gt;<br>        &lt;Route path=&#x27;/&#x27; element=&#123;&lt;Home /&gt;&#125;&gt;<br>        &lt;Route path=&#x27;/about&#x27; element=&#123;&lt;About /&gt;&#125;&gt;<br>      &lt;/Routes&gt;<br>    &lt;/HashRouter&gt;<br>  )<br>&#125;<br><br>// ä¸ä½¿ç”¨hash<br>import &#123;BrowserRouter, Routes&#125; from &#x27;react-router-dom&#x27;<br><br>function App() &#123;<br>  return(<br>    &lt;BrowserRouter&gt;<br>      &lt;Routes&gt;<br>        &lt;Route path=&#x27;/&#x27; element=&#123;&lt;Home /&gt;&#125;&gt;<br>        &lt;Route path=&#x27;/about&#x27; element=&#123;&lt;About /&gt;&#125;&gt;<br>      &lt;/Routes&gt;<br>    &lt;/BrowserRouter&gt;<br>  )<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼Œå¦‚æœä¸ä½¿ç”¨hashï¼Œåˆ™æ¯ä¸ªè·¯ç”±å¿…é¡»è¦æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„æœåŠ¡ç«¯è·¯ç”±ï¼Œå¦åˆ™ä¼šå‡ºç°404</p></blockquote><p><code>&lt;NativeRouter /&gt;</code>: React Nativeç«¯ä½¿ç”¨çš„è·¯ç”±</p><p><code>&lt;MemoryRouter /&gt;</code>: å…¶å°†è·¯ç”±å­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œä¸ä¾èµ–å¤–éƒ¨æºï¼Œå¯ä»¥é€‚åˆå„ç§åœºæ™¯ï¼Œä¾‹å¦‚æµ‹è¯•ç¯å¢ƒä¸‹</p><h3 id="lt-Routes-gt"><a href="#lt-Routes-gt" class="headerlink" title="&lt;Routes /&gt;"></a><code>&lt;Routes /&gt;</code></h3><p>æ£€æŸ¥ä¸ä¹‹åŒ¹é…çš„pathï¼Œå¹¶æ¸²æŸ“å¯¹åº”çš„<code>&lt;Route /&gt;</code></p><h3 id="lt-Route-gt"><a href="#lt-Route-gt" class="headerlink" title="&lt;Route /&gt;"></a><code>&lt;Route /&gt;</code></h3><p>æ¸²æŸ“åŒ¹é…pathçš„React Element</p><h2 id="è·¯ç”±è·³è½¬"><a href="#è·¯ç”±è·³è½¬" class="headerlink" title="è·¯ç”±è·³è½¬"></a>è·¯ç”±è·³è½¬</h2><h3 id="lt-Link-gt"><a href="#lt-Link-gt" class="headerlink" title="&lt;Link /&gt;"></a><code>&lt;Link /&gt;</code></h3><p>å…¶å†…éƒ¨ä¼šæ¸²æŸ“ä¸€ä¸ªaæ ‡ç­¾ï¼Œç‚¹å‡»ä¼šè·³è½¬åˆ°å¯¹åº”çš„è·¯ç”±</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">Link</span> to=<span class="hljs-string">&#x27;/home&#x27;</span>&gt;è·³è½¬åˆ°homeè·¯å¾„&lt;/<span class="hljs-title class_">Link</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="lt-NavLink-gt"><a href="#lt-NavLink-gt" class="headerlink" title="&lt;NavLink /&gt;"></a><code>&lt;NavLink /&gt;</code></h3><p>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„<code>&lt;Link /&gt;</code>ç»„ä»¶ï¼Œå¸¸ç”¨äºæ¸²æŸ“å¯¼èˆªæ é€‰ä¸­æ—¶çš„é«˜äº®</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts">&lt;<span class="hljs-title class_">NavLink</span> style=&#123;<span class="hljs-function">(<span class="hljs-params">&#123;isActive: <span class="hljs-built_in">boolean</span>&#125;</span>) =&gt;</span> isActive ? <span class="hljs-string">&#x27;blue&#x27;</span> : <span class="hljs-string">&#x27;white&#x27;</span>&#125;&gt;<br>  <span class="hljs-title class_">Home</span><br>&lt;/<span class="hljs-title class_">NavLink</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="lt-Navigate-gt"><a href="#lt-Navigate-gt" class="headerlink" title="&lt;Navigate /&gt;"></a><code>&lt;Navigate /&gt;</code></h3><p>å¯¹<code>useNavigate()</code>çš„å°è£…</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">Navigate</span> to=<span class="hljs-string">&#x27;/home&#x27;</span> /&gt;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªç»„ä»¶åªæ˜¯ä¸ºäº†åœ¨Classç»„ä»¶å†™æ³•ä¸­ä½¿ç”¨ï¼Œå¦‚æœæ˜¯ä½¿ç”¨Functionç»„ä»¶,å»ºè®®ä½¿ç”¨hookså†™æ³•</p></blockquote><h3 id="useNavigate"><a href="#useNavigate" class="headerlink" title="useNavigate():"></a><code>useNavigate()</code>:</h3><p>æ”¹å˜è·¯ç”±ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();<br><br><span class="hljs-comment">// è·³è½¬åˆ°/loginè·¯ç”±</span><br><span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/login&#x27;</span>);<br><br><span class="hljs-comment">// é»˜è®¤è·³è½¬ç±»å‹ä¸ºPUSH, å¯ä»¥è®¾ç½®è·³è½¬çš„ç±»å‹ä¸ºREPLACE</span><br><span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, &#123;<span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>&#125;);<br><br><span class="hljs-comment">// å¯ä»¥ç›´æ¥ä¼ é€’æ•°å€¼è·³è½¬åˆ°æŒ‡å®šæŸä¸ªè®°å½•ï¼Œä¸window.history.go()ç±»ä¼¼</span><br><span class="hljs-title function_">navigate</span>(-<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨åµŒå¥—è·¯ç”±"><a href="#ä½¿ç”¨åµŒå¥—è·¯ç”±" class="headerlink" title="ä½¿ç”¨åµŒå¥—è·¯ç”±"></a>ä½¿ç”¨åµŒå¥—è·¯ç”±</h2><h3 id="lt-Outlet-gt"><a href="#lt-Outlet-gt" class="headerlink" title="&lt;Outlet /&gt;"></a><code>&lt;Outlet /&gt;</code></h3><p>å®ç°åµŒå¥—è·¯ç”±çš„æ¸²æŸ“</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">ReactDom</span>.<span class="hljs-title function_">render</span>(<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&#x27;/&#x27;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">App</span> /&gt;</span>&#125;&gt; </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&#x27;/home&#x27;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span>,<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>);<br>);<br><span class="hljs-comment">// App.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span>(<br>    &lt;div&gt;<br>      &lt;p&gt;æ¸²æŸ“Appç»„ä»¶&lt;p&gt;<br>      &#123;/**å¦‚æœä¸æ·»åŠ è¿™ä¸ªï¼Œå½“pathåŒ¹é…/homeæ—¶ï¼Œé¡µé¢å°†ä¸ä¼šæ¸²æŸ“Homeç»„ä»¶**/&#125;<br>      &lt;Outlet /&gt;<br>    &lt;/div&gt;<br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="useOutlet"><a href="#useOutlet" class="headerlink" title="useOutlet()"></a><code>useOutlet()</code></h3><p>è¿”å›è·¯ç”±å±‚æ¬¡ç»“æ„ä¸­æ­¤çº§åˆ«çš„å­è·¯ç”±çš„å…ƒç´ , <code>&lt;Outlet /&gt;</code>çš„hooksç‰ˆ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// App.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> outlet = <span class="hljs-title function_">useOutlet</span>();<br>  <span class="hljs-keyword">return</span>(<br>    &lt;div&gt;<br>      &lt;p&gt;æ¸²æŸ“Appç»„ä»¶&lt;p&gt;<br>      &#123;/**å¦‚æœä¸æ·»åŠ è¿™ä¸ªï¼Œå½“pathåŒ¹é…/homeæ—¶ï¼Œé¡µé¢å°†ä¸ä¼šæ¸²æŸ“Homeç»„ä»¶**/&#125;<br>      &#123;outlet&#125;<br>    &lt;/div&gt;<br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="useOutLetContext"><a href="#useOutLetContext" class="headerlink" title="useOutLetContext()"></a><code>useOutLetContext()</code></h3><p>ç”¨æ¥å‘å­ç»„ä»¶ä¼ é€’å±æ€§</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// App.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&quot;&quot;</span>);<br>  <span class="hljs-keyword">return</span> (<br>    &lt;div&gt;<br>      &lt;p&gt;æ¸²æŸ“Appç»„ä»¶&lt;p&gt;<br>      &#123;/**é€šè¿‡contextå‘å­ç»„ä»¶å¹¿æ’­å±æ€§**/&#125;<br>      &lt;Outlet context=&#123;[message, setMessage]&#125; /&gt;<br>    &lt;/div&gt;<br>  );<br>&#125;<br><br>// Home.js<br>function Home() &#123;<br>  // å­ç»„ä»¶é€šè¿‡useOutletContext() æ‹¿åˆ°çˆ¶ç»„ä»¶ä¼ é€’çš„å±æ€§<br>  const [message, setMessage] = useOutletContext();<br>  return (<br>    &lt;div&gt;<br>      home<br>      &lt;p&gt;&#123;message&#125;&lt;/p&gt;<br>      &lt;input onChange=&#123;(e) =&gt; setMessage(e.target.value)&#125; /&gt;<br>    &lt;/div&gt;<br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Index-Routes-æ¦‚å¿µ"><a href="#Index-Routes-æ¦‚å¿µ" class="headerlink" title="Index Routes æ¦‚å¿µ"></a>Index Routes æ¦‚å¿µ</h2><p>ä»€ä¹ˆå«â€index routeâ€?</p><ul><li>index route æ¸²æŸ“åœ¨çˆ¶è·¯ç”±çš„outlet</li><li>å½“ä¸€ä¸ªçˆ¶è·¯ç”±è¢«åŒ¹é…æ—¶ï¼Œå…¶ä»–å­è·¯ç”±éƒ½æœªè¢«åŒ¹é…ï¼Œå°†ä¼šåŒ¹é…index routeï¼Œ</li><li>index route æ˜¯çˆ¶è·¯ç”±çš„é»˜è®¤å­è·¯ç”±</li><li>å¦‚æœç”¨æˆ·å°šæœªç‚¹å‡»å¯¼èˆªçš„ä»»ä½•ä¸€ä¸ªè·¯ç”±æ—¶ï¼Œindex routeå°†ä¼šè¢«æ¸²æŸ“</li></ul><blockquote><p>å¯èƒ½æˆ‘ç†è§£çš„ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œå¯ä»¥æŸ¥çœ‹<a href="https://reactrouter.com/docs/en/v6/getting-started/tutorial#index-routes">å®˜æ–¹çš„è§£é‡Š</a></p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">ReactDom</span>.<span class="hljs-title function_">render</span>(<br>  &lt;Routes&gt;<br>    &lt;Route path=&#x27;/&#x27; element=&#123;&lt;App /&gt;&#125;&gt; <br>      &lt;Route path=&#x27;/home&#x27; element=&#123;&lt;Home /&gt;&#125; /&gt;<br>      &lt;Route path=&#x27;/about&#x27; element=&#123;&lt;About /&gt;&#125;&gt;<br>    &lt;/Route&gt;<br>  &lt;/Routes&gt;,<br>  document.getElementById(&#x27;root&#x27;);<br>);<br>// App.js<br>function App() &#123;<br>  return(<br>    &lt;div&gt;<br>      &lt;p&gt;æ¸²æŸ“Appç»„ä»¶&lt;p&gt;<br>      &#123;/**å¦‚æœä¸æ·»åŠ è¿™ä¸ªï¼Œå½“pathåŒ¹é…/homeæ—¶ï¼Œé¡µé¢å°†ä¸ä¼šæ¸²æŸ“Homeç»„ä»¶**/&#125;<br>      &lt;Outlet /&gt;<br>    &lt;/div&gt;<br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œå½“pathä¸ºâ€™&#x2F;â€˜æ—¶ï¼Œæ­¤æ—¶çš„æ¸²æŸ“ç»„ä»¶ä¸ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">App</span> /&gt;<br></code></pre></td></tr></table></figure><p>å¦‚æœæ·»åŠ ä¸€ä¸ªIndex Routeè·¯ç”±ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">ReactDom</span>.<span class="hljs-title function_">render</span>(<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&#x27;/&#x27;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">App</span> /&gt;</span>&#125;&gt; </span><br><span class="language-xml">      &#123;/** Index Route **/&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">index</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&#x27;/about&#x27;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>,</span><br><span class="language-xml">  document.getElementById(&#x27;root&#x27;);</span><br><span class="language-xml">);</span><br></code></pre></td></tr></table></figure><p>å½“path&#x3D;â€™&#x2F;â€˜æ—¶ï¼Œæ­¤æ—¶æ¸²æŸ“çš„ç»„ä»¶ä¸ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">App</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span></span><br>&lt;/<span class="hljs-title class_">App</span>&gt;<br></code></pre></td></tr></table></figure><h2 id="Not-Found-Routes-æ¦‚å¿µ"><a href="#Not-Found-Routes-æ¦‚å¿µ" class="headerlink" title="Not Found Routes æ¦‚å¿µ"></a>Not Found Routes æ¦‚å¿µ</h2><p>å½“æ²¡æœ‰è·¯ç”±èƒ½å¤ŸåŒ¹é…ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šæ·»åŠ ä¸€ä¸ªNotFoundé¡µé¢:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">Routes</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&#x27;/&#x27;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&#x27;*&#x27;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">NotFound</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p><code>path=&#39;*&#39;</code>å°†åŒ¹é…æ‰€æœ‰çš„URL,ä½†ä¼˜å…ˆçº§æœ€ä½ï¼Œåªæœ‰ä¸å­˜åœ¨åŒ¹é…çš„è·¯ç”±æ—¶æ‰ä¼šåŒ¹é…å®ƒï¼ˆå°è¯•äº†ä¸‹ï¼Œè¿™ä¸ªåŒ¹é…å®Œå…¨ä¸ä¾èµ–æ”¾ç½®çš„é¡ºåºï¼Œå³ä½ å¯ä»¥ä»»æ„æ”¾ç½®<code>path=&#39;*&#39;</code>è·¯ç”±çš„ä½ç½®ğŸ¤”æ„Ÿè§‰æ¯”ä»¥å‰å¥½ç”¨äº†ï¼Œå¿ƒæ™ºæ¨¡å¼è‡³å°‘å¾—åˆ°äº†é™ä½ï¼‰</p><h2 id="hooks"><a href="#hooks" class="headerlink" title="hooks"></a>hooks</h2><p>è¿™é‡Œä»‹ç»å‰é¢æ²¡æœ‰ä»‹ç»çš„hook</p><h3 id="useHref"><a href="#useHref" class="headerlink" title="useHref()"></a>useHref()</h3><p>ä¼ å…¥ä¸€ä¸ª<code>To</code>ç±»å‹çš„æ•°æ®ï¼Œè¿”å›ä¸€ä¸ªæ‹¼å¥½çš„URL, å¯ä»¥ç”¨æ¥æ”¾åœ¨å±æ€§<code>to</code>çš„ä½ç½®</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-comment">// type To = Partial&lt;Location&gt; | string;</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">to</span>: <span class="hljs-title class_">To</span> = &#123;<br>  <span class="hljs-attr">pathname</span>: <span class="hljs-string">&quot;/123456&quot;</span>,<br>  <span class="hljs-attr">search</span>: <span class="hljs-string">&quot;a=b&amp;c=d&quot;</span>,<br>  <span class="hljs-attr">hash</span>: <span class="hljs-string">&quot;home&quot;</span><br>&#125;;<br><span class="hljs-comment">// const href = useHref(&#x27;/home?a=b&amp;c=d&#x27;);</span><br><span class="hljs-keyword">const</span> href = <span class="hljs-title function_">useHref</span>(to);<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&#123;href&#125;</span> /&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="useLinkClickHandler"><a href="#useLinkClickHandler" class="headerlink" title="useLinkClickHandler()"></a>useLinkClickHandler()</h3><p>è¿”å›ä¸€ä¸ªç‚¹å‡»äº‹ä»¶å›è°ƒï¼Œé€šå¸¸ç”¨äºè‡ªå®šä¹‰<code>&lt;Link /&gt;</code>ç»„ä»¶</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useLinkClickHandler</span>(to);<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span>ç‚¹æˆ‘è·³è½¬<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="useLinkPressHandler"><a href="#useLinkPressHandler" class="headerlink" title="useLinkPressHandler()"></a>useLinkPressHandler()</h3><p>åŒuseLinkClickHandler(), è¿™æ˜¯ç”¨äºrnç«¯çš„</p><h3 id="useInRouterContext"><a href="#useInRouterContext" class="headerlink" title="useInRouterContext()"></a>useInRouterContext()</h3><p>ç”¨äºåˆ¤æ–­ç»„ä»¶æ˜¯å¦åœ¨<code>&lt;Router /&gt;</code>ä¸­æ¸²æŸ“, trueä¸ºæ˜¯ï¼Œfalseä¸ºå¦</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> isInRouterRender = <span class="hljs-title function_">useInRouterContext</span>();<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">  &#123;isInRouterRender ? &#x27;ç»„ä»¶æ¸²æŸ“åœ¨<span class="hljs-tag">&lt;<span class="hljs-name">Router</span> /&gt;</span>ä¸­&#x27; : &#x27;ç»„ä»¶å¯èƒ½é£äº†&#x27;&#125;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="useNavigationType"><a href="#useNavigationType" class="headerlink" title="useNavigationType()"></a>useNavigationType()</h3><p>è¿”å›è¿›å…¥å½“å‰é¡µé¢çš„ç±»å‹æˆ–å½“å‰å¯¼èˆªç±»å‹</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">NavigationType</span> = <span class="hljs-string">&quot;POP&quot;</span> | <span class="hljs-string">&quot;PUSH&quot;</span> | <span class="hljs-string">&quot;REPLACE&quot;</span>;<br></code></pre></td></tr></table></figure><blockquote><p>é¡µé¢åˆæ¬¡åŠ è½½æ˜¯NavigationTypeä¸ºâ€™POPâ€™ç±»å‹, åé¢å¦‚æœä¸è®¾ç½®ï¼Œé»˜è®¤æ˜¯â€™PUSHâ€™ç±»å‹</p></blockquote><h3 id="useMatch"><a href="#useMatch" class="headerlink" title="useMatch()"></a>useMatch()</h3><p>è¿”å›ç»™å®šè·¯å¾„ä¸Šç›¸å¯¹äºå½“å‰ä½ç½®çš„è·¯ç”±çš„åŒ¹é…æ•°æ®ã€‚</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PathMatch</span>&lt;<span class="hljs-title class_">ParamKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> = <span class="hljs-built_in">string</span>&gt; &#123;<br>  <span class="hljs-attr">params</span>: <span class="hljs-title class_">Params</span>&lt;<span class="hljs-title class_">ParamKey</span>&gt;;<br>  <span class="hljs-attr">pathname</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">pattern</span>: <span class="hljs-title class_">PathPattern</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PathPattern</span> &#123;<br>  <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>;<br>  caseSensitive?: <span class="hljs-built_in">boolean</span>;<br>  end?: <span class="hljs-built_in">boolean</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">match</span>: <span class="hljs-title class_">PathMatch</span>&lt;<span class="hljs-title class_">ParamKey</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-title function_">useMatch</span>(<span class="hljs-string">&#x27;/home&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="useParams"><a href="#useParams" class="headerlink" title="useParams()"></a>useParams()</h3><p>è¿”å›å½“å‰URLä¸­çš„paramsï¼Œå¹¶ç»„æˆä¸€ä¸ªé”®&#x2F;å€¼å¯¹å¯¹è±¡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span>, useParams &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfilePage</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// Get the userId param from the URL.</span><br>  <span class="hljs-keyword">let</span> &#123; userId &#125; = <span class="hljs-title function_">useParams</span>();<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;users&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;:userId&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ProfilePage</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;me&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;...&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="useResolvedPath"><a href="#useResolvedPath" class="headerlink" title="useResolvedPath()"></a>useResolvedPath()</h3><p>è¿”å›ä¸€ä¸ªè§£æåçš„Pathå¯¹è±¡</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useResolvedPath</span>(<span class="hljs-params">to: To</span>): <span class="hljs-title class_">Path</span>;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Path</span> &#123;<br>  <span class="hljs-attr">pathname</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">search</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">hash</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="useRoutes"><a href="#useRoutes" class="headerlink" title="useRoutes()"></a>useRoutes()</h3><p>ç­‰åŒäº<code>&lt;Routes /&gt;</code>ï¼Œæ¥æ”¶ä¸€ä¸ªå’Œ<code>&lt;Route /&gt;</code>ä¸€æ ·å‚æ•°çš„å¯¹è±¡ç»„æˆçš„æ•°ç»„ï¼Œè¿˜æ˜¯çœ‹ä¾‹å­å§ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js">  <span class="hljs-comment">// æˆ‘ä»¬å°†ä¸Šé¢çš„ReactDOM.renderæ¸²æŸ“ç”¨hooksé‡å†™</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Root</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> element = <span class="hljs-title function_">useRoutes</span>([<br>    &#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>      <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>,<br>      <span class="hljs-attr">children</span>: [<br>        &#123;<br>          <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/home&#x27;</span>,<br>          <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span></span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/about&#x27;</span>,<br>          <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">About</span> /&gt;</span></span><br>        &#125;<br>      ]<br>    &#125;,<br>    <span class="hljs-comment">// æ·»åŠ ä¸€ä¸ªæ–°çš„è·¯ç”±</span><br>    &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;team&quot;</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AboutPage</span> /&gt;</span></span> &#125;<br>  ]);<br><br>  <span class="hljs-keyword">return</span> element;<br>&#125;<br><br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Root</span> /&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>));<br></code></pre></td></tr></table></figure><h3 id="useSearchParams"><a href="#useSearchParams" class="headerlink" title="useSearchParams()"></a>useSearchParams()</h3><p>ç”¨æ¥æ“ä½œURLçš„searchå‚æ•°ï¼Œä»æ­¤æˆ‘ä»¬ä¸åœ¨éœ€è¦è‡ªå·±å»å†™ä¸€ä¸ªè§£æsearchçš„å·¥å…·å‡½æ•°äº†ã€‚ä½¿ç”¨æ–¹å¼ä¸React.useStateä¸€æ ·ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// http://localhost?id=1</span><br><span class="hljs-keyword">const</span> [searchParams, setSearchParams] = <span class="hljs-title function_">useSearchParams</span>();<br><br><span class="hljs-comment">// è·å¾—idå­—æ®µå¾—å€¼</span><br>searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;id&#x27;</span>);<br><br><span class="hljs-comment">// è·å–æ‰€æœ‰çš„idå­—æ®µå€¼ï¼Œè¿”å›æ•°ç»„</span><br>searchParams.<span class="hljs-title function_">getAll</span>(<span class="hljs-string">&#x27;id&#x27;</span>); <span class="hljs-comment">// =&gt; [&#x27;1&#x27;]</span><br><br><span class="hljs-comment">// æ›´æ”¹idå­—æ®µå¾—å€¼</span><br><span class="hljs-title function_">setSearchParams</span>(&#123;<span class="hljs-attr">id</span>: <span class="hljs-number">2</span>&#125;);<br></code></pre></td></tr></table></figure><p>searchParamsæ˜¯ä¸€ä¸ªURLSearchParamsç±»å‹å®ä¾‹, setSearchParamså…¶æ•ˆæœä¸navigateï¼ˆuseNavigate()çš„è¿”å›å€¼ï¼‰ç±»ä¼¼ï¼Œåªæ˜¯å‰è€…åªæ”¹å˜urlçš„searchæ®µ</p><blockquote><p>å…³äºURLSearchParamsç±»å‹å®ä¾‹ï¼Œè¯¦æƒ…æŸ¥çœ‹ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/URLSearchParams">https://developer.mozilla.org/zh-CN/docs/Web/API/URLSearchParams</a><br>æ³¨æ„URLSearchParamsçš„å…¼å®¹æ€§</p></blockquote><h3 id="useLocation"><a href="#useLocation" class="headerlink" title="useLocation()"></a>useLocation()</h3><p>è¿”å›å½“å‰æ‰€åœ¨é¡µé¢çš„locationå¯¹è±¡ï¼ˆå’Œwindow.locationè¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼‰ã€‚å¯ä»¥ç”¨æ¥å¤„ç†ä¸€äº›å½“å‰é¡µé¢çš„locationå‘ç”Ÿæ”¹å˜æ—¶çš„å‰¯ä½œç”¨</p><blockquote><p>æœ‰äº›apiå¹¶æ²¡æœ‰åœ¨è¿™é‡ŒæåŠ</p><ul><li><a href="https://reactrouter.com/docs/en/v6/api#router"><code>&lt;Router&gt;</code></a></li><li><a href="https://reactrouter.com/docs/en/v6/api#staticrouter"><code>&lt;StaticRouter&gt;</code></a></li><li><a href="https://reactrouter.com/docs/en/v6/api#createroutesfromchildren">createRoutesFromChildren</a></li><li><a href="https://reactrouter.com/docs/en/v6/api#generatepath">generatePath</a></li><li><a href="https://reactrouter.com/docs/en/v6/api#location">Location</a></li><li><a href="https://reactrouter.com/docs/en/v6/api#matchroutes">matchRoutes</a></li><li><a href="https://reactrouter.com/docs/en/v6/api#rendermatches">renderMatches</a></li><li><a href="https://reactrouter.com/docs/en/v6/api#matchpath">matchPath</a></li><li><a href="https://reactrouter.com/docs/en/v6/api#resolvepath">resolvePath</a></li><li><a href="https://reactrouter.com/docs/en/v6/api#createsearchparams">createSearchParams</a></li></ul></blockquote><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <em>react routerå®˜ç½‘ <a href="https://reactrouter.com/docs/en/v6/api">https://reactrouter.com/docs/en/v6/api</a></em></p>]]></content>
    
    
    <categories>
      
      <category>react-router</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>react-router</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¦‚ä½•å®ç°å›¾ç‰‡æ‡’åŠ è½½</title>
    <link href="/2022/01/08/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD/"/>
    <url>/2022/01/08/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD/</url>
    
    <content type="html"><![CDATA[<p>å½“ç”¨æˆ·è®¿é—®ä¸€ä¸ªå›¾ç‰‡å¾ˆå¤šçš„é¡µé¢ï¼Œå¦‚æœä¸åšä»»ä½•å¤„ç†ï¼Œå¯èƒ½ç­‰åˆ°å›¾ç‰‡åŠ è½½å®Œæˆç”¨æˆ·å¯èƒ½æ—©å·²ç»ç¦»å¼€é¡µé¢ï¼Œæ‰€ä»¥ä¸ºäº†ç•™ä½æˆ‘ä»¬çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸€è¿‡ç¨‹åšä¸€æ¬¡ä¼˜åŒ–ï¼Œæˆ‘ä»¬é€‰æ‹©â€™æ‡’åŠ è½½â€™çš„æ–¹å¼æ¥è¿›è¡Œä¼˜åŒ–ã€‚</p><h2 id="ä½•ä¸ºæ‡’åŠ è½½ï¼Ÿ"><a href="#ä½•ä¸ºæ‡’åŠ è½½ï¼Ÿ" class="headerlink" title="ä½•ä¸ºæ‡’åŠ è½½ï¼Ÿ"></a>ä½•ä¸ºæ‡’åŠ è½½ï¼Ÿ</h2><p>æ‰€è°“æ‡’åŠ è½½ï¼Œå°±æ˜¯å»¶è¿ŸåŠ è½½ã€‚æˆ‘ä»¬åªé€‰æ‹©ç”¨æˆ·éœ€è¦çœ‹åˆ°çš„ä¸œè¥¿è¿›è¡ŒåŠ è½½ï¼Œå¯¹äºç”¨æˆ·çœ‹ä¸åˆ°çš„ä¸œè¥¿ï¼Œä¹Ÿè®¸æ°¸è¿œä¹Ÿä¸éœ€è¦åŠ è½½ï¼Œå¦‚æœç¬¬ä¸€æ¬¡è¯·æ±‚å°±åŠ è½½æ‰€æœ‰ï¼Œä¸ä»…æµªè´¹å¸¦å®½ï¼Œè€Œä¸”å¯èƒ½è¿˜ä¼šé€¼èµ°ä½ çš„ç”¨æˆ·ã€‚</p><h2 id="è§†å£ï¼ˆviewpointï¼‰"><a href="#è§†å£ï¼ˆviewpointï¼‰" class="headerlink" title="è§†å£ï¼ˆviewpointï¼‰"></a>è§†å£ï¼ˆviewpointï¼‰</h2><p>è¯´åˆ°æ‡’åŠ è½½ï¼Œéš¾å…ä¸ä¼šæåˆ°è§†å£ï¼Œè§†å£åˆåˆ†ä¸º<strong>è§†è§‰è§†å£ï¼ˆvisual viewportï¼‰</strong>å’Œ<strong>å¸ƒå±€è§†å£ï¼ˆlayout viewportï¼‰</strong>ã€‚è§†å£åœ¨æµè§ˆå™¨ä¸­æ˜¯æŒ‡æˆ‘ä»¬æ­£åœ¨æµè§ˆçš„ä¸€éƒ¨åˆ†ï¼Œå³æ’é™¤æµè§ˆå™¨UIå’Œèœå•æ çš„éƒ¨åˆ†ã€‚</p><p><code>visual viewport</code> æŒ‡å½“å‰æµè§ˆå™¨ä¸­å¯è§çš„éƒ¨åˆ†ï¼Œå¹¶ä¸”å¯ä»¥å˜åŒ–ã€‚</p><p><code>layout viewport</code>æ˜¯æŒ‡ <code>innerHeight</code> å’Œ <code>innerWidth</code> æ‰€ç»„æˆçš„åŒºåŸŸã€‚</p><p>è·å–è§†å£çš„å®½å’Œé«˜ï¼š</p><p><code>document.documentElement.clientWidth</code>: è·å–é¡µé¢å¯¹è±¡çš„å®½åº¦ï¼ˆæ³¨ï¼š<code>Element.clientWidth</code>è·å¾—çš„å…ƒç´ å®½åº¦ä¸º<code>content + padding * 2</code> ä½†ä¸åŒ…å«æ»šåŠ¨æ¡ï¼‰</p><p><code>document.documentElement.clientHeight</code>: è·å–é¡µé¢å¯¹è±¡çš„é«˜åº¦</p><p><code>window.innerWidth</code>: è·å–æµè§ˆå™¨çª—å£ï¼ˆ<code>viewpoint</code>ï¼‰å®½åº¦ï¼ŒåŒ…æ‹¬æ»šåŠ¨æ¡</p><p><code>window.innerHeight</code>: è·å–æµè§ˆå™¨çª—å£ï¼ˆ<code>viewpoint</code>ï¼‰é«˜åº¦</p><p><code>window.outerWidth</code>: æ˜¯æŒ‡åŒ…æ‹¬äº†æµè§ˆå™¨å¤–è¾¹æ¡†çš„çª—å£å®½åº¦ </p><p><code>window.outerHeight</code>: è·å–æ•´ä¸ªæµè§ˆå™¨çª—å£çš„é«˜åº¦ï¼ˆå•ä½ï¼šåƒç´ ï¼‰ï¼ŒåŒ…æ‹¬ä¾§è¾¹æ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€çª—å£é•¶è¾¹ï¼ˆ<code>window chrome</code>ï¼‰å’Œçª—å£è°ƒæ­£è¾¹æ¡†</p><h2 id="Element-getBoundingClientRect"><a href="#Element-getBoundingClientRect" class="headerlink" title="Element.getBoundingClientRect()"></a>Element.getBoundingClientRect()</h2><p>è¯¥æ–¹æ³•ç”¨äºè¿”å›æŸä¸ª<code>ELement</code>çš„å®½åº¦ï¼Œé«˜åº¦ä»¥åŠç›¸å¯¹äºè§†å£çš„ä½ç½®ã€‚å®ƒçš„è¿”å›å€¼æ˜¯ä¸ª<code>DOMRect</code>å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«çš„å±æ€§æœ‰ï¼š</p><p><code>DOMRect.x</code>: æŒ‡Elementçš„æ°´å¹³åæ ‡</p><p><code>DOMRect.y</code>: æŒ‡Elementçš„å‚ç›´åæ ‡</p><p><code>DOMRect.top</code>: æŒ‡Elementä¸Šè¾¹ç¼˜è·ç¦»è§†å£é¡¶éƒ¨çš„é«˜åº¦</p><p><code>DOMRect.bottom</code>: æŒ‡Elementä¸‹è¾¹ç¼˜è·ç¦»è§†å£é¡¶éƒ¨çš„é«˜åº¦</p><p><code>DOMRect.left</code>: æŒ‡Elementå·¦è¾¹ç¼˜è·ç¦»è§†å£å·¦è¾¹çš„å®½åº¦</p><p><code>DOMRect.right</code>: æŒ‡Elementå³è¾¹ç¼˜è·ç¦»è§†å£å·¦è¾¹çš„å®½åº¦</p><p><code>DOMRect.width</code>: æŒ‡Elementæœ¬èº«çš„å®½åº¦</p><p><code>DOMRect.height</code>: æŒ‡Elementæœ¬èº«çš„é«˜åº¦</p><p><img src="/2022/01/08/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD/E48030B8-4561-4E91-82BC-D94D88C8BA99.png" alt="rect å›¾ç‰‡"></p><p>å¦‚æœæ˜¯æ ‡å‡†ç›’å­æ¨¡å‹ï¼Œå…ƒç´ çš„å°ºå¯¸ç­‰äº<code>width/height + padding + border-width</code>çš„æ€»å’Œã€‚å¦‚æœ<code>box-sizing: border-box</code>ï¼Œå…ƒç´ çš„çš„å°ºå¯¸ç­‰äº <code>width/height</code>ã€‚</p><h2 id="å®ç°æ‡’åŠ è½½"><a href="#å®ç°æ‡’åŠ è½½" class="headerlink" title="å®ç°æ‡’åŠ è½½"></a>å®ç°æ‡’åŠ è½½</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€å•çš„å›¾ç‰‡æ‡’åŠ è½½ç»„ä»¶</p><p><a href="https://codepen.io/yanxiaolazy/embed/RwZXZPw">https://codepen.io/yanxiaolazy/embed/RwZXZPw</a></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> node = ref.<span class="hljs-property">current</span><br>  <span class="hljs-keyword">if</span> (node) &#123;<br>    <span class="hljs-title function_">checkVisible</span>(node, setVisible);<br>  &#125;<br>&#125;, []);<br></code></pre></td></tr></table></figure><p>é¦–æ¬¡æ¸²æŸ“æ—¶ï¼ŒåŠ è½½å·²ç»å‡ºç°åœ¨è§†å£ä¸­çš„èŠ‚ç‚¹</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> node = ref.<span class="hljs-property">current</span><br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">lazyLoadHandle</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">checkVisible</span>(node, setVisible);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (node) &#123;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, lazyLoadHandle)<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, lazyLoadHandle);<br>&#125;, [])<br></code></pre></td></tr></table></figure><p>é¦–æ¬¡æ¸²æŸ“æ—¶ç»‘å®šæ»šåŠ¨äº‹ä»¶ï¼Œç”¨äºåŠ è½½æ»šåŠ¨æ—¶å‡ºç°åœ¨è§†å£ä¸­çš„èŠ‚ç‚¹</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkVisible</span> = (<span class="hljs-params">node, callback</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123;top, height&#125; = node.<span class="hljs-title function_">getBoundingClientRect</span>();<br>  <span class="hljs-keyword">const</span> innerHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;<br>  top &lt;= innerHeight &amp;&amp; (top + height) &gt; <span class="hljs-number">0</span> &amp;&amp;  <span class="hljs-title function_">callback</span>(<span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>checkVisible</code>å‡½æ•°ç”¨äºåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²ç»å‡ºç°åœ¨è§†å£ä¸­ï¼Œå…¶ä¸­<code>top &lt;= innerHeight</code> è¯´æ˜è¯¥èŠ‚ç‚¹å‡ºç°åœ¨äº†è§†å£ä¸­ï¼Œ<code>(top + height) &gt; 0</code>è¯´æ˜è¯¥èŠ‚ç‚¹è¿˜æœªç¦»å¼€è§†å£ï¼Œæ¥ç€è®¾ç½®<code>visible</code>ä¸º<code>true</code>åŠ è½½è¯¥èŠ‚ç‚¹</p>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>react-router ç®€å•ä»‹ç»ä¸æœ¬åœ°è°ƒè¯•ç¯å¢ƒæ­å»º</title>
    <link href="/2021/09/29/react-router%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <url>/2021/09/29/react-router%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>react-router</code>æ˜¯<code>react</code>çš„æµè§ˆå™¨è·¯ç”±ç»„ä»¶ï¼Œä½¿ç”¨<code>react-router</code>å¯ä»¥è½»æ¾çš„å®ç°æµè§ˆå™¨è·¯ç”±è·³è½¬ã€‚<code>react-router</code>ç›®å‰å·²ç»æ›´æ–°åˆ°<code>v5.3.0</code>, æœ€æ–°çš„<code>history</code>ä¹Ÿå·²ç»æ›´æ–°åˆ°<code>v5.0.1</code>ã€‚ç›®å‰ï¼Œä»<code>Github</code>ä»“åº“å¯ä»¥çœ‹å‡ºï¼Œå®˜æ–¹äººå‘˜æ­£åœ¨å…¨åŠ›ä½¿ç”¨<code>TypeScript</code>é‡æ„ä¸¤ä¸ªé¡¹ç›®, æ–°ç‰ˆçš„<code>history</code>ä»“åº“å’ŒåŸæ¥çš„ä»“åº“å¹¶ä¸å…¼å®¹ã€‚æˆ‘ä»¬ä»<code>npm</code>ä¸Šç›´æ¥æ·»åŠ çš„<code>history</code>ä»ç„¶æ˜¯<code>v4</code>ç‰ˆæœ¬ã€‚</p><blockquote><p>ä½¿ç”¨<code>TypeScript</code>é‡æ„çš„ä¸¤ä¸ªä»“åº“:<br><a href="https://github.com/remix-run/react-router/tree/dev">react-routerä»“åº“</a><br><a href="https://github.com/remix-run/history/tree/main">historyä»“åº“</a></p></blockquote><blockquote><p>ä»¥ä¸‹ä»‹ç»çš„é¡¹ç›®ç‰ˆæœ¬ï¼š<code>react-router</code>æ˜¯<code>v5.3.0</code>, <code>history</code>æ˜¯<code>v4.10.1</code> </p></blockquote><h2 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h2><p><code>react-router</code>ä»“åº“, åˆ†ä¸ºå››ä¸ªåŒ…: </p><ul><li><code>react-router</code>: <code>react router</code>çš„æ ¸å¿ƒç»„ä»¶</li><li><code>react-router-dom</code>: æµè§ˆå™¨è·¯ç”±ç»„ä»¶</li><li><code>react-router-native</code>: <code>react native</code>çš„è·¯ç”±ç»„ä»¶</li><li><code>react-router-config</code>: é™æ€è·¯ç”±ç»„ä»¶ï¼ˆå¦‚æœéœ€è¦ä½¿ç”¨<code>react router</code>çš„é™æ€è·¯ç”±ï¼Œéœ€è¦å¼•ç”¨è¿™ä¸ªåŒ…ï¼Œé‡æ„åè¿™ä¸ªåŒ…ï¼Œå·²ç»è¢«åˆ é™¤ï¼‰</li></ul><p>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ å¯¹åº”çš„åŒ…å³å¯ï¼Œä¸éœ€è¦æ·»åŠ <code>react-router</code>ï¼Œä¾‹å¦‚ï¼Œåœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨æ·»åŠ <code>react-router-dom</code>ï¼›åœ¨<code>native</code>ä¸­ä½¿ç”¨æ·»åŠ <code>react-router-native</code>ï¼›å¦‚æœéœ€è¦ä½¿ç”¨ä»¥å‰çš„é™æ€è·¯ç”±ï¼Œå°±æ·»åŠ <code>react-router-config</code> ã€‚</p><h2 id="æœ¬åœ°è°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#æœ¬åœ°è°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="æœ¬åœ°è°ƒè¯•ç¯å¢ƒæ­å»º"></a>æœ¬åœ°è°ƒè¯•ç¯å¢ƒæ­å»º</h2><p>åœ¨é˜…è¯»æºç è¿‡ç¨‹ä¸­éš¾å…ä¼šæœ‰ä»¤äººå¤´ç—›çš„ä»£ç ç‰‡æ®µéƒ¨åˆ†ï¼Œè€Œè¿™éƒ¨åˆ†ï¼Œæƒ³è¦å¼„æ˜ç™½ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯é€šè¿‡è°ƒè¯•ï¼Œä½†æ€ä¹ˆåœ¨æœ¬åœ°è°ƒè¯•ä»£ç å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å€ŸåŠ©<code>webpack</code>çš„<code>resolve.alias</code>è¿›è¡Œæœ¬åœ°ä»£ç æ˜ å°„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">resolve</span>: &#123;<br>  <span class="hljs-attr">extensions</span>: [<span class="hljs-string">&#x27;.js&#x27;</span>, <span class="hljs-string">&#x27;.jsx&#x27;</span>],<br>  <span class="hljs-attr">alias</span>: &#123;<br>        <span class="hljs-string">&#x27;react-router-dom&#x27;</span>:path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;../src/react-router/packages/react-router-dom/modules&#x27;</span>),<br>        <span class="hljs-string">&#x27;react-router&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;../src/react-router/packages/react-router/modules&#x27;</span>),<br>        <span class="hljs-string">&#x27;history&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;../src/history/modules&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>react-router</code>è¿˜éœ€è¦å…¶ä»–åŒ…ï¼Œå› æ­¤éœ€è¦åœ¨<code>react-router</code>å’Œ<code>history</code>ä¸‹è¿è¡Œ<code>yarn</code>å®‰è£…å¯¹åº”çš„åŒ…ã€‚</p><p>ç„¶åï¼Œå°±å¯ä»¥å¼•å…¥åˆ°é¡¹ç›®ä¸­äº†ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span>, <span class="hljs-title class_">Switch</span>, <span class="hljs-title class_">Route</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-router-dom&quot;</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Start</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;App&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>test page<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">Root</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>root page<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  )<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Switch</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&#x27;/test&#x27;</span> <span class="hljs-attr">component</span>=<span class="hljs-string">&#123;Start&#125;/</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">component</span>=<span class="hljs-string">&#123;Root&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Switch</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span><br>  )<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>react-router</category>
      
    </categories>
    
    
    <tags>
      
      <tag>react</tag>
      
      <tag>æºç è§£æ</tag>
      
      <tag>react-router</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>React Context</title>
    <link href="/2021/09/23/React%E4%B9%8BContext/"/>
    <url>/2021/09/23/React%E4%B9%8BContext/</url>
    
    <content type="html"><![CDATA[<p><img src="/2021/09/23/React%E4%B9%8BContext/image-20210924142001161.png"></p><hr><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>React</code>ä¸ºæˆ‘ä»¬æä¾›äº†<code>Context</code>ç”¨äºå°†æ•°æ®è¿›è¡Œå¹¿æ’­ï¼Œæ¶ˆè´¹è€…åªéœ€ä½¿ç”¨ç‰¹å®šçš„æ–¹æ³•å°±èƒ½æ‹¿åˆ°å¹¿æ’­çš„æ•°æ®ï¼Œä¸ç”¨å†é‡‡ç”¨å±‚å±‚é€’ä¼ <code>props</code>çš„æ–¹å¼ã€‚å¦‚æœç»„ä»¶ä¹‹é—´éœ€è¦å…±äº«æ•°æ®ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨<code>Context</code>çš„æ–¹å¼ï¼Œå¦‚<code>react-router</code>ä¸­çš„<code>Router</code>ç»„ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs react">...<br>render() &#123;<br>    return (<br>      &lt;RouterContext.Provider<br>        value=&#123;&#123;<br>          history: this.props.history,<br>          location: this.state.location,<br>          match: Router.computeRootMatch(this.state.location.pathname),<br>          staticContext: this.props.staticContext<br>        &#125;&#125;<br>      &gt;<br>        &lt;HistoryContext.Provider<br>          children=&#123;this.props.children || null&#125;<br>          value=&#123;this.props.history&#125;<br>        /&gt;<br>      &lt;/RouterContext.Provider&gt;<br>    );<br>  &#125;<br>...<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<code>Provider</code>åŒ…è£¹ç»„ä»¶åï¼Œåç»­å°±èƒ½ç›´æ¥ä»<code>context</code>ä¸­è·å–æœ€æ–°çš„<code>history</code>ç­‰æ•°æ®ã€‚</p><blockquote><p>åœ¨ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ä½¿ç”¨<code>Context</code> : <em><a href="https://react.docschina.org/docs/context.html#when-to-use-context">https://react.docschina.org/docs/context.html#when-to-use-context</a></em> </p><p>ä½¿ç”¨ä¹‹å‰çš„è€ƒè™‘: <em><a href="https://react.docschina.org/docs/context.html#before-you-use-context">https://react.docschina.org/docs/context.html#before-you-use-context</a></em> </p></blockquote><h2 id="React-createContext"><a href="#React-createContext" class="headerlink" title="React.createContext"></a>React.createContext</h2><p>ç”¨äºåˆ›å»ºä¸€ä¸ª<code>Context</code>å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«<code>Provider</code>å’Œ<code>Consumer</code>ä¸¤ä¸ªç»„ä»¶ã€‚<code>Provider</code>ç»„ä»¶å¯ä»¥æä¾›ç”¨äº<code>Consumer</code>ç»„ä»¶æ¶ˆè´¹çš„<code>context</code>ã€‚åŒæ—¶å¯ä»¥åœ¨åˆ›å»º<code>Context</code>å¯¹è±¡æ—¶ï¼Œä¸ºå…¶æŒ‡å®šä¸€ä¸ªé»˜è®¤å€¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs react">const NewContext = React.createContext(defaultValue);<br></code></pre></td></tr></table></figure><p>å¦‚æœ<code>Consumer</code>ç»„ä»¶ä¸èƒ½åœ¨æ‰€å¤„çš„æ ‘ä¸­åŒ¹é…åˆ°<code>Provider</code>ï¼Œå°†ä¼šä½¿ç”¨è¿™ä¸ª<code>defaultValue</code>ã€‚</p><blockquote><p>å¦‚æœç›´æ¥ç»™<code>Provider</code>çš„<code>value</code>èµ‹å€¼ä¸º<code>undefined</code>ï¼Œæ¶ˆè´¹ç»„ä»¶çš„<code>defaultValue</code>ä¸ä¼šç”Ÿæ•ˆ</p></blockquote><h2 id="Context-Provider"><a href="#Context-Provider" class="headerlink" title="Context.Provider"></a>Context.Provider</h2><p><code>Provider</code>å¯ä»¥ä¸ºæ¶ˆè´¹ç»„ä»¶æä¾›<code>context</code>ï¼Œé€šè¿‡å°†è¦å¹¿æ’­çš„æ•°æ®æ”¾å…¥<code>value</code>ï¼Œå†…éƒ¨çš„æ¶ˆè´¹ç»„ä»¶å°±å¯ä»¥æ¶ˆè´¹è¿™ä¸ª<code>value</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs react">const &#123;Provider&#125; = NewContext;<br>...<br>&lt;Provider value=&#x27;provider&#x27;&gt;<br>&lt;Button /&gt;<br>&lt;/Provider&gt;<br>...<br></code></pre></td></tr></table></figure><p><code>Provider</code>å¯ä»¥è¿›è¡ŒåµŒå¥—ï¼Œä½†<code>Consumer</code>åªä¼šæ¶ˆè´¹<strong>æœ€è¿‘</strong>çš„<code>Provider</code>ã€‚</p><p>å¦‚æœ<code>Provider</code>çš„<code>value</code>å‘ç”Ÿå˜åŒ–ï¼Œ<strong>å®ƒå†…éƒ¨çš„æ‰€æœ‰çš„æ¶ˆè´¹ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“</strong>ï¼Œå³ä½¿ä½¿ç”¨äº†<code>shouldComponentUpdate</code>è¿›è¡Œäº†ä¼˜åŒ–å¤„ç†ï¼Œä¹Ÿä¸ä¼šå½±åƒæ¶ˆè´¹ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚</p><blockquote><p>å¦‚æœä¸º<code>Provider</code>æä¾›çš„æ˜¯å¯¹è±¡ï¼Œç”±äºè¯¥çˆ¶ç»„ä»¶è¿›è¡Œé‡æ¸²æŸ“æ—¶ï¼Œæ¯æ¬¡<code>value</code>éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œä»è€Œconsumersç»„ä»¶ä¸­ä¹Ÿä¼šå‘ç”Ÿä¸å¿…è¦çš„æ¸²æŸ“ã€‚</p></blockquote><p>è§£å†³æ–¹å¼æ˜¯å°†è¯¥å¯¹è±¡ä¿å­˜åœ¨<code>state</code>ä¸­:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs react">const App = () =&gt; &#123;<br>  const [state, setState] = useState(&#123;&#125;);<br>  useEffect(() =&gt; &#123;<br>    ...<br>    setState(&#123;theme: &#x27;#fff&#x27;&#125;)<br>    ...<br>  &#125;)<br>  return(<br>  &lt;NewContext.Provider value=&#123;state&#125;&gt;<br>  &lt;Button /&gt;  <br>  &lt;/NewContext.Provider&gt;)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Class-contextType"><a href="#Class-contextType" class="headerlink" title="Class.contextType"></a>Class.contextType</h2><p>é€šè¿‡ç»™ç»„ä»¶çš„<code>contextType</code>å±æ€§èµ‹å€¼ä¸º<code>Context</code>å¯¹è±¡åï¼Œå¯ä»¥åœ¨è¯¥ç»„ä»¶çš„å†…éƒ¨æ‹¿åˆ°<code>context</code>: </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs react">class App extends React.Component &#123;<br>  ...<br>  componentDidMount() &#123;<br>    ...<br>    let value = this.context<br>    ...<br>  &#125;<br>  ...<br>  render() &#123;<br>    ...<br>    let value = this.context<br>    ...<br>  &#125;<br>&#125;<br>App.contextType = NewContext<br></code></pre></td></tr></table></figure><p>å¯ä»¥åœ¨ç»„ä»¶çš„ä»»ä½•ç”Ÿå‘½å‘¨æœŸä¸­æ‹¿åˆ°<code>context</code>ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨<code>static</code>å…³é”®å­—è¿›è¡Œåˆå§‹åŒ–:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs react">class App extends React.Component &#123;<br>  static contextType = NewContext<br>render() &#123;<br>    ...<br>    let value = this.context<br>    ...<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Context-Consumer"><a href="#Context-Consumer" class="headerlink" title="Context.Consumer"></a>Context.Consumer</h2><p><code>contextType</code>åªé€‚ç”¨äºç±»ç»„ä»¶ï¼Œå¯¹äºå‡½æ•°ç»„ä»¶ï¼Œå¯ä»¥ä½¿ç”¨<code>Consutmer</code>ç»„ä»¶è·å–<code>context</code>: </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs react">const App = () =&gt; &#123;<br>  return(<br>  &lt;NewContext.Consumer&gt;<br>    &#123;context =&gt; &#123;<br>        // æ‹¿åˆ°contextï¼Œå¹¶è¿›è¡Œå…¶ä»–é€»è¾‘<br>        <br>        // è¿”å›ReactèŠ‚ç‚¹<br>        return &lt;Button style=&#123;&#123;background: context.theme&#125;&#125;/&gt;<br>      &#125;&#125;<br>    &lt;/NewContext.Consumer&gt;<br>  )<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Consumer</code>ç»„ä»¶ä¸­éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥æ¥æ”¶å½“å‰çš„<code>context</code>ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ª<code>React</code>èŠ‚ç‚¹ã€‚</p><h2 id="Context-displayName"><a href="#Context-displayName" class="headerlink" title="Context.displayName"></a>Context.displayName</h2><p><code>Context</code>å¯¹è±¡æ¥æ”¶ä¸€ä¸ª<code>displayName</code>å±æ€§ï¼Œç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼ŒReact DevTools ä½¿ç”¨è¯¥å­—ç¬¦ä¸²æ¥ç¡®å®š <code>context</code> è¦æ˜¾ç¤ºçš„å†…å®¹: </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs react">const MyContext = React.createContext(/* some value */);<br>MyContext.displayName = &#x27;MyDisplayName&#x27;;<br><br>&lt;MyContext.Provider&gt; // &quot;MyDisplayName.Provider&quot; åœ¨ DevTools ä¸­<br>&lt;MyContext.Consumer&gt; // &quot;MyDisplayName.Consumer&quot; åœ¨ DevTools ä¸­<br></code></pre></td></tr></table></figure><h2 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h2><p><code>useContext</code>æ˜¯<code>React</code>æä¾›çš„ä¸€ä¸ª<code>hooks API</code>ï¼Œå¯ä»¥ç”¨æ¥æ‹¿åˆ°å¯¹åº”çš„<code>Context</code>å¯¹è±¡æä¾›çš„<code>context</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs react">// context.js<br>export const NewContext = React.createContext(defaultValue);<br><br>// app.js<br>import &#123;NewContext&#125; from &#x27;./context&#x27;<br>import &#123;Buttons&#125; from &#x27;./buttons&#x27;<br>const App = () =&gt; &#123;<br>  ...<br>  return(<br>  &lt;NewContext.Provider value=&#123;&#123;theme: &#x27;#fff&#x27;&#125;&#125;&gt;<br>    ...<br>      &lt;Buttons /&gt;<br>    &lt;/NewContext.Provider&gt;<br>  )<br>&#125;<br><br>// buttons.js<br>import &#123;Button&#125; from &#x27;./button&#x27;<br>const Buttons = () =&gt; &#123;<br>  ...<br>  return(<br>    ...<br>  &lt;Button /&gt;<br>    ...<br>  )<br>&#125;<br><br>// button.js<br>import &#123;useContext&#125; from &#x27;react&#x27;<br>import &#123;NewContext&#125; from &#x27;./context&#x27;<br>const Button = () =&gt; &#123;<br>  const context = useContext(NewContext)<br>  <br>  return (<br>  &lt;button style=&#123;&#123;background: context.theme&#125;&#125;&gt;æŒ‰é’®&lt;/button&gt;<br>  )<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç»„ä»¶ä¸Šå±‚æœ€è¿‘çš„ <code>&lt;NewContext.Provider&gt;</code> æ›´æ–°æ—¶ï¼Œè¯¥ Hook ä¼šè§¦å‘é‡æ¸²æŸ“ï¼Œå¹¶ä½¿ç”¨æœ€æ–°ä¼ é€’ç»™ <code>NewContext</code> provider çš„ context <code>value</code> å€¼ã€‚å³ä½¿ç¥–å…ˆä½¿ç”¨ <a href="https://react.docschina.org/docs/react-api.html#reactmemo"><code>React.memo</code></a> æˆ– <a href="https://react.docschina.org/docs/react-component.html#shouldcomponentupdate"><code>shouldComponentUpdate</code></a>ï¼Œä¹Ÿä¼šåœ¨ç»„ä»¶æœ¬èº«ä½¿ç”¨ <code>useContext</code> æ—¶é‡æ–°æ¸²æŸ“ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <em><a href="https://react.docschina.org/docs/context.html">https://react.docschina.org/docs/context.html</a></em></p><p>[2] <em><a href="https://react.docschina.org/docs/hooks-reference.html#usecontext">https://react.docschina.org/docs/hooks-reference.html#usecontext</a></em> </p>]]></content>
    
    
    <categories>
      
      <category>react</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FormDataå¤šæ–‡ä»¶ä¸Šä¼ å¹¶åŒæ—¶æ·»åŠ å…¶ä»–æ•°æ®</title>
    <link href="/2021/09/10/FormData%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%B9%B6%E5%90%8C%E6%97%B6%E6%B7%BB%E5%8A%A0%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE/"/>
    <url>/2021/09/10/FormData%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%B9%B6%E5%90%8C%E6%97%B6%E6%B7%BB%E5%8A%A0%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨åšé¡¹ç›®æ—¶ï¼Œæœ‰ä¸€ä¸ªæ¥å£è¦æ±‚ä¸Šä¼ æ–‡ä»¶çš„åŒæ—¶èƒ½æºå¸¦å…¶å®ƒæ•°æ®ï¼Œåœ¨è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>FormData</code>å¯¹è±¡æ¥è¿›è¡Œæ“ä½œã€‚ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªå¯¹è±¡ã€‚<br><code>FormData</code> æ¥å£æä¾›äº†ä¸€ç§è¡¨ç¤ºè¡¨å•æ•°æ®çš„é”®å€¼å¯¹ <code>key/value</code> çš„æ„é€ æ–¹å¼ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾çš„å°†æ•°æ®é€šè¿‡<code>XMLHttpRequest.send()</code> æ–¹æ³•å‘é€å‡ºå»ï¼Œæœ¬æ¥å£å’Œæ­¤æ–¹æ³•éƒ½ç›¸å½“ç®€å•ç›´æ¥ã€‚å¦‚æœé€å‡ºæ—¶çš„ç¼–ç ç±»å‹è¢«è®¾ä¸º <code>&quot;multipart/form-data&quot;</code>ï¼Œå®ƒä¼šä½¿ç”¨å’Œè¡¨å•ä¸€æ ·çš„æ ¼å¼ã€‚(ä»¥ä¸Šå‡ºè‡ª<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FormData">è¿™é‡Œ</a>) </p><h2 id="å•æ–‡ä»¶ä¸Šä¼ "><a href="#å•æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="å•æ–‡ä»¶ä¸Šä¼ "></a>å•æ–‡ä»¶ä¸Šä¼ </h2><p>è¿™é‡Œä½¿ç”¨<code>FormData</code>çš„<code>append()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå‘<code>FormData</code>å¯¹è±¡ä¸­æ·»åŠ æ–°çš„å±æ€§å€¼</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;file&#x27;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;upload&#x27;</span>&gt;</span>ä¸Šä¼ <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;file&#x27;</span>);</span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> uploadBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;upload&#x27;</span>);</span><br><span class="language-javascript">  <span class="hljs-keyword">let</span> files = <span class="hljs-literal">null</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript">  input.<span class="hljs-property">onchange</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> file = input.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];</span><br><span class="language-javascript">    files = file;</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadFile</span> = (<span class="hljs-params">file</span>) =&gt; &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();</span><br><span class="language-javascript">    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;file&#x27;</span>, file);</span><br><span class="language-javascript">    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://xxx.com&#x27;</span>, &#123;</span><br><span class="language-javascript">      <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>, </span><br><span class="language-javascript">      <span class="hljs-attr">body</span>: formData</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;</span><br><span class="language-javascript">      <span class="hljs-comment">//åœ¨è¿™é‡Œå¤„ç†è¯·æ±‚æˆåŠŸ</span></span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;</span><br><span class="language-javascript">      <span class="hljs-comment">//åœ¨è¿™é‡Œå¤„ç†è¯·æ±‚å¤±è´¥</span></span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript">  uploadBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">if</span> (!files) &#123;</span><br><span class="language-javascript">      <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;è¯·é€‰æ‹©æ–‡ä»¶&#x27;</span>)</span><br><span class="language-javascript">      <span class="hljs-keyword">return</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    <span class="hljs-title function_">uploadFile</span>(files);</span><br><span class="language-javascript">  &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼šä¸Šä¼ æ–‡ä»¶æ˜¯ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±è®¾ç½®<code>Content-Type</code>å¤´çš„ï¼Œè®¾ç½®äº†åè€Œæ— æ³•ä¸Šä¼ ï¼Œåˆ‡è®°ï¼Œåˆ‡è®°ï¼Œåˆ‡è®°ï¼ï¼ï¼</p><p>è¯¦ç»†çš„å¯ä»¥æŸ¥çœ‹è¿™ä¸ªissue: <a href="https://github.com/github/fetch/issues/505#issuecomment-293064470">https://github.com/github/fetch/issues/505#issuecomment-293064470</a></p></blockquote><h3 id="å¤šæ–‡ä»¶ä¸Šä¼ "><a href="#å¤šæ–‡ä»¶ä¸Šä¼ " class="headerlink" title="å¤šæ–‡ä»¶ä¸Šä¼ "></a>å¤šæ–‡ä»¶ä¸Šä¼ </h3><p>å¦‚æœ<code>FormData</code>çš„å±æ€§å€¼ä¸­å·²ç»å­˜åœ¨å¯¹åº”çš„å±æ€§å€¼ä¹Ÿä¸ä¼šè¢«è¦†ç›–ï¼Œè€Œæ˜¯ä¼šå°†è¿™ä¸ªæ–°å€¼æ·»åŠ åˆ°å·²æœ‰é›†åˆçš„åé¢</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs html">+ <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-attr">multiple</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;upload&#x27;</span>&gt;</span>ä¸Šä¼ <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;file&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> uploadBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;upload&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-keyword">let</span> files = <span class="hljs-literal">null</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    input.<span class="hljs-property">onchange</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">-     <span class="hljs-keyword">const</span> file = input.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];</span><br><span class="language-javascript">-     files = file;</span><br><span class="language-javascript">+     <span class="hljs-keyword">const</span> files = input.<span class="hljs-property">files</span></span><br><span class="language-javascript">+     files = files;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">-   <span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadFile</span> = (<span class="hljs-params">file</span>) =&gt; &#123;</span><br><span class="language-javascript">+   <span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadFile</span> = (<span class="hljs-params">files</span>) =&gt; &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();</span><br><span class="language-javascript">-     formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;file&#x27;</span>, file);</span><br><span class="language-javascript"><span class="hljs-comment">//å¤šæ–‡ä»¶ä¸Šä¼ ï¼ŒformDataçš„appendæ–¹æ³•ï¼Œå¯¹äºåŒä¸€ä¸ªkeyä¼šå°†æ–°æ·»åŠ çš„key/valueæ·»åŠ åˆ°åé¢ï¼Œä¸ä¼šè¦†ç›–å·²ç»å­˜åœ¨çš„key</span></span><br><span class="language-javascript">+     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) &#123;</span><br><span class="language-javascript">+       formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;files&#x27;</span>, file);</span><br><span class="language-javascript">+     &#125; </span><br><span class="language-javascript">      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://xxx.com&#x27;</span>, &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>, </span><br><span class="language-javascript">        <span class="hljs-attr">body</span>: formData</span><br><span class="language-javascript">      &#125;)</span><br><span class="language-javascript">      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;</span><br><span class="language-javascript">        <span class="hljs-comment">//åœ¨è¿™é‡Œå¤„ç†è¯·æ±‚æˆåŠŸ</span></span><br><span class="language-javascript">      &#125;)</span><br><span class="language-javascript">      .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;</span><br><span class="language-javascript">        <span class="hljs-comment">//åœ¨è¿™é‡Œå¤„ç†è¯·æ±‚å¤±è´¥</span></span><br><span class="language-javascript">      &#125;)</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    uploadBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">if</span> (!files) &#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;è¯·é€‰æ‹©æ–‡ä»¶&#x27;</span>)</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span></span><br><span class="language-javascript">      &#125;</span><br><span class="language-javascript">      <span class="hljs-title function_">uploadFile</span>(files);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="å¤šæ–‡ä»¶ä¸Šä¼ å¹¶æºå¸¦å…¶ä»–æ•°æ®"><a href="#å¤šæ–‡ä»¶ä¸Šä¼ å¹¶æºå¸¦å…¶ä»–æ•°æ®" class="headerlink" title="å¤šæ–‡ä»¶ä¸Šä¼ å¹¶æºå¸¦å…¶ä»–æ•°æ®"></a>å¤šæ–‡ä»¶ä¸Šä¼ å¹¶æºå¸¦å…¶ä»–æ•°æ®</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs html">  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;file&#x27;</span> <span class="hljs-attr">multiple</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;upload&#x27;</span>&gt;</span>ä¸Šä¼ <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;file&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> uploadBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;upload&#x27;</span>);</span><br><span class="language-javascript">    <span class="hljs-keyword">let</span> files = <span class="hljs-literal">null</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    input.<span class="hljs-property">onchange</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">const</span> files = input.<span class="hljs-property">files</span></span><br><span class="language-javascript">      files = files;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">-   <span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadFile</span> = (<span class="hljs-params">files</span>) =&gt; &#123;</span><br><span class="language-javascript">+   <span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadFile</span> = (<span class="hljs-params">files, payload</span>) =&gt; &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();</span><br><span class="language-javascript">      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) &#123;</span><br><span class="language-javascript">        formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;files&#x27;</span>, file);</span><br><span class="language-javascript">      &#125; </span><br><span class="language-javascript">      <span class="hljs-comment">//å¯¹äºå…¶ä»–é™„åŠ çš„æ•°æ®ï¼Œåˆ†åˆ«å¢åŠ åˆ°FormDataä¸­å³å¯</span></span><br><span class="language-javascript">+     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> payload) &#123;</span><br><span class="language-javascript">+       formData.<span class="hljs-title function_">append</span>([key], payload[key]);</span><br><span class="language-javascript">+     &#125;</span><br><span class="language-javascript">      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://xxx.com&#x27;</span>, &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>, </span><br><span class="language-javascript">        <span class="hljs-attr">body</span>: formData</span><br><span class="language-javascript">      &#125;)</span><br><span class="language-javascript">      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;</span><br><span class="language-javascript">        <span class="hljs-comment">//åœ¨è¿™é‡Œå¤„ç†è¯·æ±‚æˆåŠŸ</span></span><br><span class="language-javascript">      &#125;)</span><br><span class="language-javascript">      .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;</span><br><span class="language-javascript">        <span class="hljs-comment">//åœ¨è¿™é‡Œå¤„ç†è¯·æ±‚å¤±è´¥</span></span><br><span class="language-javascript">      &#125;)</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    uploadBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">      <span class="hljs-keyword">if</span> (!files) &#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;è¯·é€‰æ‹©æ–‡ä»¶&#x27;</span>)</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span></span><br><span class="language-javascript">      &#125;</span><br><span class="language-javascript">-     <span class="hljs-title function_">uploadFile</span>(files);</span><br><span class="language-javascript">+     <span class="hljs-title function_">uploadFile</span>(files, &#123;<span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;upload&#x27;</span>&#125;);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p><code>FormData</code>å¯¹è±¡çš„<code>set()</code>æ–¹æ³•å’Œ<code>append()</code>æ–¹æ³•æ¯”è¾ƒï¼Œ<code>set()</code>æ–¹æ³•æŒ‡å®šçš„é”®å¦‚æœå­˜åœ¨ï¼Œä¼šä½¿ç”¨æ–°å€¼è¦†ç›–åŸæ¥çš„å€¼ï¼Œè€Œ<code>append()</code>æ–¹æ³•ä¼šæŠŠæ–°å€¼æ·»åŠ åˆ°å·²æœ‰å€¼é›†åˆçš„åé¢</p></blockquote><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FormData">https://developer.mozilla.org/zh-CN/docs/Web/API/FormData</a></p>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git ç”¨æ³•</title>
    <link href="/2021/07/15/git-%E7%94%A8%E6%B3%95/"/>
    <url>/2021/07/15/git-%E7%94%A8%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<p><img src="/2021/07/15/git-%E7%94%A8%E6%B3%95/github.jpg"></p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åˆ«äººä¸Šç­ï¼Œæˆ‘æ‘¸é±¼ï¼Œåˆ«äººåŠ ç­ï¼Œæˆ‘æ‘¸é±¼ï¼Œç„¶åå°±å†™å‡ºäº†è¿™ç¯‡ Git çš„ç®€å•ä½¿ç”¨æ•™ç¨‹ã€‚</p><p>æ‘¸æ‘¸ç´¢ç´¢ä¸€ä¸ªå¤šæœˆæ€»ç®—æ˜¯å®Œæˆäº†è¿™ç¯‡ git çš„å­¦ä¹ ç¬”è®° ğŸ˜‚ï¼Œ è¿˜å¥½æœ€åè¿˜æ˜¯åšæŒäº†ä¸‹æ¥ï¼Œå¯èƒ½æœ‰äº›æœ‰é—®é¢˜ï¼Œæ¬¢è¿å„ä½å¤§ä½¬æŒ‡æ­£ï¼Œå¯ä»¥é€šè¿‡æ<a href="https://github.com/yxlazy/blog/issues">issue</a>çš„æ–¹å¼ï¼Œæˆ–è€…å…³æ³¨æˆ‘çš„å…¬ä¼—å·, å¾®ä¿¡æœç´¢ <strong>å‰ç«¯å…¥å‘æ‰‹å†Œ</strong>ï¼Œåœ¨åå°ç»™æˆ‘ç•™è¨€ã€‚</p><h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><ol><li>é¦–å…ˆéœ€è¦ç”Ÿæˆ ssh ç§˜é’¥ï¼Œ<code>ssh-keygen -t rsa -C &quot;ä½ å…¬å¸å†…éƒ¨é‚®ç®±åœ°å€&quot;</code> ï¼Œå¦‚æœæˆåŠŸï¼Œå°†ä¼šåœ¨<code>~/.ssh</code>æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆå¯¹åº”çš„ç§é’¥å’Œå…¬é’¥ã€‚<br><code>ls</code></li></ol><p><img src="/2021/07/15/git-%E7%94%A8%E6%B3%95/image-20210716095654977.png"></p><ol start="2"><li>å¤åˆ¶<code>id_rsa.pub</code>æ–‡ä»¶çš„å†…å®¹ï¼ˆå¦‚æœæ˜¯ GitHubï¼‰åˆ°<code>setting -&gt; SSH and GPG keys-&gt; New SSH key</code> å¹¶ä¿å­˜</li></ol><blockquote><p>è®°ä½æ”¾åˆ° GitHub ä¸Šçš„æ˜¯å…¬é’¥</p></blockquote><ol start="3"><li><p>å…¨å±€é…ç½®è´¦å·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git config --global user.name <span class="hljs-string">&quot;xxxx&quot;</span><br>git config --global user.email <span class="hljs-string">&quot;xxxx&quot;</span><br></code></pre></td></tr></table></figure></li></ol><p>å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œå°±å¯ä»¥æ„‰å¿«çš„ pull æˆ– push ä»£ç äº†ã€‚å’Œ https æ‹‰å–æ–¹å¼ä¸åŒçš„æ˜¯ï¼Œhttps æ–¹å¼éœ€è¦æ¯æ¬¡æäº¤å‰éƒ½æ‰‹åŠ¨è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œssh çš„æ–¹å¼é…ç½®å®Œæ¯•å Git éƒ½ä¼šä½¿ç”¨ä½ æœ¬åœ°çš„ç§é’¥å’Œè¿œç¨‹ä»“åº“çš„å…¬é’¥è¿›è¡ŒéªŒè¯æ˜¯å¦æ˜¯ä¸€å¯¹ç§˜é’¥ï¼Œä»è€Œç®€åŒ–äº†æ“ä½œæµç¨‹ã€‚</p><h2 id="åŸºç¡€ç¯‡"><a href="#åŸºç¡€ç¯‡" class="headerlink" title="åŸºç¡€ç¯‡"></a>åŸºç¡€ç¯‡</h2><p>â€‹ åˆå§‹åŒ–ä¸€ä¸ª git ä»“åº“ï¼Œä½¿ç”¨å‘½ä»¤<code>git init</code> ï¼Œä¼šåœ¨é¡¹ç›®ä¸‹ç”Ÿæˆä¸€ä¸ª.git çš„æ–‡ä»¶å¤¹ï¼Œè¿™å°±æ˜¯ Git çš„ç‰ˆæœ¬åº“</p><blockquote><p>å‰æƒ…æè¦ï¼šgit æœ‰å·¥ä½œåŒºå’Œæš‚å­˜åŒºä¹‹åˆ†</p><p>å·¥ä½œåŒºï¼šå°±æ˜¯æˆ‘ä»¬é¡¹ç›®æ‰€åœ¨çš„åŒºåŸŸ</p><p>æš‚å­˜åŒºï¼šgit add æ“ä½œä¹‹åï¼Œå®é™…å°±æ˜¯å°†å·¥ä½œåŒºçš„å†…å®¹æ·»åŠ åˆ°æš‚å­˜åŒº</p></blockquote><h3 id="git-add"><a href="#git-add" class="headerlink" title="git add"></a>git add</h3><p>å°†å·¥ä½œåŒºçš„æ›´æ”¹ï¼Œæ·»åŠ åˆ°æš‚å­˜åŒº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ·»åŠ æŒ‡å®šæ–‡ä»¶ï¼Œåé¢å¯è·Ÿå¤šä¸ªæ–‡ä»¶ï¼Œä»¥ç©ºæ ¼åˆ†å¼€</span><br>git add &lt;å…·ä½“çš„æ–‡ä»¶åæˆ–æŸä¸ªæ–‡ä»¶ä¸‹çš„æ‰€æœ‰å†…å®¹&gt;<br><span class="hljs-comment"># æ·»åŠ é¡¹ç›®ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</span><br>git add .<br></code></pre></td></tr></table></figure><h3 id="git-commit"><a href="#git-commit" class="headerlink" title="git commit"></a>git commit</h3><p>å°†æš‚å­˜åŒºçš„å†…å®¹æäº¤åˆ°å½“å‰åˆ†æ”¯ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¼šæ‰“å¼€ä¸€ä¸ªå¯ç¼–è¾‘åŒºåŸŸ</span><br>git commit<br><span class="hljs-comment"># ç›´æ¥å°†å¤‡æ³¨æ·»åŠ åœ¨åé¢</span><br>git commit -m <span class="hljs-string">&quot;xxxx&quot;</span><br><span class="hljs-comment"># ç­‰ä»·äºgit add &amp;&amp; git commit</span><br>git commit -am <span class="hljs-string">&quot;xxxx&quot;</span><br><span class="hljs-comment"># å¯¹æœ€è¿‘ä¸€æ¬¡çš„æäº¤ä¿¡æ¯è¿›è¡Œä¿®æ”¹ï¼Œä¼šæ›´æ”¹hashå€¼</span><br>git commit --amend<br></code></pre></td></tr></table></figure><h3 id="git-push"><a href="#git-push" class="headerlink" title="git push  "></a>git push <remote> <place></place></remote></h3><p>å°†æœ¬åœ°åˆ†æ”¯å‘å¸ƒåˆ°è¿œç«¯åˆ†æ”¯</p><ul><li>å¸¸ç”¨å‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸å¸¦å‚æ•°çš„pushã€‚æ³¨æ„ â€”â€” git push ä¸å¸¦ä»»ä½•å‚æ•°æ—¶çš„è¡Œä¸ºä¸ Git çš„ä¸€ä¸ªåä¸º push.default çš„é…ç½®æœ‰å…³</span><br>git push<br><span class="hljs-comment"># å°†æœ¬åœ°çš„devåˆ†æ”¯ï¼Œå‘å¸ƒåˆ°è¿œç«¯åŒåçš„devåˆ†æ”¯</span><br>git push origin dev<br><span class="hljs-comment"># å°†æœ¬åœ°å½“å‰åˆ†æ”¯ï¼Œå‘å¸ƒåˆ°è¿œç«¯ä¸æœ¬åœ°å½“å‰åˆ†æ”¯åŒåçš„åˆ†æ”¯ä¸Š</span><br>git push origin<br></code></pre></td></tr></table></figure><ul><li>è¿›é˜¶å‘½ä»¤</li></ul><p>æ ¼å¼ï¼š<code>git push origin &lt;source&gt;:&lt;destination&gt;</code></p><blockquote><p><code>source</code> å¯ä»¥æ˜¯ä»»ä½• Git èƒ½è¯†åˆ«çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š<code>HEAD~2</code>ï¼Œ<code>foo^2</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å°†æœ¬åœ°devåˆ†æ”¯ä¸Šçš„dev^å¤„å‘ç”Ÿçš„æ›´æ”¹æäº¤åˆ°è¿œç«¯åˆ†æ”¯feat</span><br>git push origin dev^:feat<br></code></pre></td></tr></table></figure><h3 id="git-pull"><a href="#git-pull" class="headerlink" title="git pull  "></a>git pull <remote> <place></place></remote></h3><p>æ‹‰å–è¿œç«¯æ›´æ–°åˆ†æ”¯åˆ°æœ¬åœ°</p><ul><li>å¸¸ç”¨å‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¸å¸¦å‚æ•°çš„pullã€‚ å°†è¿œç«¯originä¸Šçš„masterä¸Šçš„æ›´æ–°æ‹‰å–åˆ°æœ¬åœ°ï¼Œå¹¶ä¸æœ¬åœ°çš„masteråˆ†æ”¯è¿›è¡Œåˆå¹¶</span><br>git pull<br>git pull origin<br></code></pre></td></tr></table></figure><ul><li>è¿›é˜¶å‘½ä»¤</li></ul><p>åŒæ ·<code>git pull</code>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>&lt;source&gt;:&lt;destination&gt;</code>æ ¼å¼<br>æ ¼å¼ï¼š<code>git pull origin &lt;source&gt;:&lt;destination&gt;</code></p><blockquote><p><code>source</code> å¯ä»¥æ˜¯ä»»ä½• Git èƒ½è¯†åˆ«çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š<code>HEAD~2</code>ï¼Œ<code>foo^2</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ‹‰å–è¿œç«¯åˆ†æ”¯ä¸Šçš„æ›´æ–°å¹¶ä¸æœ¬åœ°çš„æŸä¸ªåˆ†æ”¯è¿›è¡Œåˆå¹¶</span><br>git pull origin master:dev<br></code></pre></td></tr></table></figure><h3 id="git-fetch"><a href="#git-fetch" class="headerlink" title="git fetch"></a>git fetch</h3><p>å°†è¿œç¨‹ä¸»æœºçš„æœ€æ–°å†…å®¹æ‹‰å–åˆ°æœ¬åœ°ï¼Œä½†ä¸ä¼šåˆå¹¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é»˜è®¤è¿œç¨‹ä¸»æœºæ˜¯origin</span><br>git fetch<br><span class="hljs-comment"># æ‹‰å–æ‰€æœ‰è¿œç¨‹ä¸»æœºä¸Šçš„æ›´æ–°ï¼Œé»˜è®¤æ˜¯origin</span><br>git fetch --all<br><span class="hljs-comment"># æ‹‰å–è¿œç¨‹ä¸»æœºoriginä¸Šdevåˆ†æ”¯æœ€æ–°çš„æ›´æ–°</span><br>git fetch origin dev<br></code></pre></td></tr></table></figure><h3 id="git-merge"><a href="#git-merge" class="headerlink" title="git merge"></a>git merge</h3><p>å°†ä¸¤ä¸ªæˆ–å¤šä¸ªåˆ†æ”¯è¿›è¡Œåˆå¹¶ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„æäº¤è®°å½•ï¼Œä¿ç•™åˆå¹¶å†å²</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å‡è®¾åœ¨masteråˆ†æ”¯ï¼Œä»¥ä¸‹å‘½ä»¤ï¼Œå°±æ˜¯åœ¨è¯´ï¼Œå°†devåˆ†æ”¯åˆå¹¶åˆ°masterä¸Š</span><br>git merge dev<br><span class="hljs-comment"># -ff æŒ‡fast-forword, é»˜è®¤é‡‡ç”¨æ¨¡å¼ã€‚ä½¿ç”¨è¿™ç§æ¨¡å¼ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„commitèŠ‚ç‚¹</span><br>git merge --ff -m <span class="hljs-string">&quot;æ·»åŠ ä¸€äº›message&quot;</span><br><span class="hljs-comment"># --no-ff fast-forwordæ¨¡å¼ä¸‹ï¼Œä»ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„commitèŠ‚ç‚¹ã€‚è¿™æ˜¯åˆå¹¶ä¸€ä¸ªtagæ—¶çš„é»˜è®¤è¡Œä¸º</span><br>git merge --no-ff -m <span class="hljs-string">&quot;æ·»åŠ message&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>æ‰§è¡Œ<code>git pull</code>å‘½ä»¤ï¼Œå®é™…å°±æ˜¯<code>git fetch + git merge</code></p></blockquote><h3 id="git-rebase"><a href="#git-rebase" class="headerlink" title="git rebase"></a>git rebase</h3><p>æ˜¯å¦ä¸€ä¸ªåˆå¹¶åˆ†æ”¯çš„å‘½ä»¤ï¼Œå…¶å®é™…ä¸Šå°±æ˜¯å–å‡ºä¸€ç³»åˆ—çš„æäº¤è®°å½•ï¼Œâ€å¤åˆ¶â€œå®ƒä»¬ï¼Œ ç„¶ååœ¨å¦å¤–ä¸€ä¸ªåœ°æ–¹ç€ä¸ªçš„æ”¾ä¸‹å»ã€‚</p><ul><li><p>åˆå¹¶åˆ†æ”¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å½“å‰åˆ†æ”¯topic</span><br><span class="hljs-comment"># A---B---C topic</span><br><span class="hljs-comment"># /</span><br><span class="hljs-comment"># D---E---F---G master</span><br><span class="hljs-comment">#æ‰§è¡Œä»¥ä¸‹ä»»æ„ä¸€æ¡å‘½ä»¤</span><br>git rebase master<br>git rebase master topic<br><span class="hljs-comment"># A&#x27;--B&#x27;--C&#x27; topic</span><br><span class="hljs-comment"># /</span><br><span class="hljs-comment"># D---E---F---G master</span><br></code></pre></td></tr></table></figure></li></ul><ul><li><code>git rebase --abort</code>: <code>rebase</code>æ—¶ï¼Œå‘ç”Ÿå†²çªï¼Œå¯ä»¥ç”¨æ¥é˜»æ­¢<code>rebase</code></li><li><code>git rebase --continue</code>: <code>rebase</code>æ—¶ï¼Œ è§£å†³äº†å†²çªåï¼Œç”¨æ¥ç»§ç»­<code>rebase</code></li><li><code>git rebase -i</code>: åˆå¹¶å¤šä¸ª<code>commit</code> è®°å½•</li><li><code>git pull --rebase = git fetch + git rebase</code></li></ul><h3 id="git-checkout"><a href="#git-checkout" class="headerlink" title="git checkout"></a>git checkout</h3><p>è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å‘½ä»¤ï¼Œå¯ä»¥åšå¾ˆå¤šäº‹</p><ul><li><p>åˆ›å»ºæ–°çš„åˆ†æ”¯</p><p><code>git checkout -b dev</code> : åŸºäºå½“å‰åˆ†æ”¯åˆ›å»ºä¸€ä¸ªæ–°çš„<code>dev</code>åˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢åˆ°<code>dev</code>åˆ†æ”¯</p><p><code>git checkout -b dev master</code>: åŸºäº<code>master</code>åˆ†æ”¯åˆ›å»ºä¸€ä¸ªæ–°çš„<code>dev</code>åˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢åˆ°<code>dev</code>åˆ†æ”¯</p><blockquote><p>ç­‰ä»·äº<code>git branch -b dev</code></p></blockquote></li><li><p><code>git checkout dev</code>: åˆ‡æ¢åˆ†æ”¯ï¼Œ åˆ‡æ¢åˆ°<code>dev</code>åˆ†æ”¯</p><blockquote><p>ç­‰ä»·äº<code>git branch dev</code></p></blockquote></li><li><p><code>git checkout &lt;file&gt;</code>: ï¼ˆ<code>file</code>å¯ä»¥æ˜¯ä¸ªâ€ç‚¹â€, è¡¨ç¤ºæ’¤é”€æ‰€æœ‰æ–‡ä»¶çš„æ›´æ”¹ï¼‰æ’¤é”€å·¥ä½œåŒºä¸­çš„æŒ‡å®šæ›´æ”¹ï¼Œä¸åŒ…å«æœªè¢«<code>git</code>ç›‘æ§çš„æ–‡ä»¶</p><blockquote><p>ç­‰ä»·äº<code>git restore &lt;file&gt; </code></p><p>å¦‚æœéœ€è¦æ’¤é”€æš‚å­˜åŒºçš„æ›´æ”¹ï¼Œå¯ä»¥ä½¿ç”¨<code>git restore --staged &lt;file&gt;</code></p></blockquote></li></ul><h3 id="git-cherry-pick"><a href="#git-cherry-pick" class="headerlink" title="git cherry-pick"></a>git cherry-pick</h3><p>å¦‚æœä½ åªéœ€è¦æŸä¸ªåˆ†æ”¯çš„éƒ¨åˆ†æäº¤ä»£ç ï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨è¿™æ¡å‘½ä»¤</p><ul><li><code>git cherry-pick &lt;commit&gt;</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å½“å‰åˆ†æ”¯ master (ä»¥ä¸‹å­—æ¯ä»£è¡¨commit hash)</span><br><span class="hljs-comment"># e - f - g dev</span><br><span class="hljs-comment"># /</span><br><span class="hljs-comment"># a - b - c - d master</span><br><span class="hljs-comment"># å€˜è‹¥masteråˆ†æ”¯åªéœ€è¦devåˆ†æ”¯ä¸Šçš„æœ¬åˆ†æäº¤, å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç </span><br>git cherry-pick e...f<br><span class="hljs-comment"># e - f - g dev</span><br><span class="hljs-comment"># /</span><br><span class="hljs-comment"># a - b - c - d - e&#x27; - f&#x27; master</span><br></code></pre></td></tr></table></figure><ul><li><code>git cherry-pick &lt;branch&gt;</code> : å‘½ä»¤çš„å‚æ•°ï¼Œä¸ä¸€å®šæ˜¯æäº¤çš„å“ˆå¸Œå€¼ï¼Œåˆ†æ”¯åä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¡¨ç¤ºè½¬ç§»è¯¥åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚</li><li><code>git cherry-pick --abort</code>: å‘ç”Ÿä»£ç å†²çªæ—¶ï¼Œå¯ä»¥é˜»æ­¢åˆå¹¶ä»£ç ï¼Œå›åˆ°æ“ä½œå‰çš„æ ·å­</li><li><code>git cherry-pick --continue</code>: è§£å†³ä»£ç å†²çªåï¼Œç»§ç»­è¿›è¡Œ<code>cherry-pick</code> å‘½ä»¤</li><li><code>git cherry-pick --quite</code> : å‘ç”Ÿä»£ç å†²çªåï¼Œå¯ä»¥é˜»æ­¢åˆå¹¶ä»£ç ï¼Œä½†æ˜¯ä¸ä¼šå›åˆ°æ“ä½œå‰çš„æ ·å­</li></ul><h2 id="å…¶ä»–å‘½ä»¤"><a href="#å…¶ä»–å‘½ä»¤" class="headerlink" title="å…¶ä»–å‘½ä»¤"></a>å…¶ä»–å‘½ä»¤</h2><h3 id="git-branch"><a href="#git-branch" class="headerlink" title="git branch"></a>git branch</h3><p>ç”¨äºåˆ†æ”¯ç®¡ç†çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ—å‡ºæ‰€æœ‰åˆ†æ”¯</span><br>git branch<br><span class="hljs-comment"># åˆ—å‡ºæ‰€æœ‰åˆ†æ”¯ï¼Œå¹¶å¸¦ä¸Šæœ€è¿›ä¸€æ¬¡çš„commitè®°å½•</span><br>git branch -v<br><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯dev</span><br>git branch dev<br><span class="hljs-comment"># åˆ é™¤devåˆ†æ”¯</span><br>git branch -d dev<br><span class="hljs-comment"># git branch --delete --forceçš„ç®€å†™ï¼Œç”¨äºå¼ºåˆ¶åˆ é™¤</span><br>git branch -D dev<br><span class="hljs-comment"># åŸºäºå½“å‰åˆ†æ”¯å¤åˆ¶ä¸€ä¸ªæ–°çš„åˆ†æ”¯branch-copy</span><br>git branch -c branch-copy<br><span class="hljs-comment"># åŸºäºdevåˆ†æ”¯å¤åˆ¶ä¸€ä¸ªæ–°çš„åˆ†æ”¯dev-copy</span><br>git branch -c dev dev-copy<br></code></pre></td></tr></table></figure><h3 id="git-stash"><a href="#git-stash" class="headerlink" title="git stash"></a>git stash</h3><p>å°†æœ¬åœ°çš„æ›´æ”¹æš‚å­˜ã€‚</p><p>å½“æœ¬åœ°å‘ç”Ÿæ›´æ”¹ï¼Œä½†è¿˜æœª<code>commit</code>, åˆè¦è¿›è¡Œå…¶ä»–æ“ä½œ( å¦‚æ›´æ–°è¿œç«¯æœ€æ–°ä»£ç  )ï¼Œå¦‚æœç›´æ¥<code>git pull</code>æˆ–<code>git pull --rebase</code> ä¼šæŠ¥é”™ï¼Œè¿™æ—¶ï¼Œå°±éœ€è¦æˆ‘ä»¬å…ˆå°†æ›´æ”¹æš‚å­˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å°†æ›´æ”¹æš‚å­˜èµ·æ¥</span><br>git stash<br><span class="hljs-comment"># ä¹Ÿå¯ä»¥åœ¨æš‚å­˜æ—¶ï¼Œæ·»åŠ å¤‡æ³¨</span><br>git stash -m <span class="hljs-string">&quot;æš‚å­˜&quot;</span><br><span class="hljs-comment"># æŸ¥çœ‹stashäº†å“ªäº›</span><br>git stash list<br><span class="hljs-comment"># å–å‡ºæœ€è¿‘çš„ä¸€æ¬¡stash, å¹¶åˆ é™¤è®°å½•</span><br>git stash pop<br><span class="hljs-comment"># å–å‡ºæŒ‡å®šçš„stashè®°å½•, ä¸ä¼šåˆ é™¤</span><br>git stash list<br>git stash apply &lt;å‰é¢list åˆ—å‡ºçš„æŸä¸€é¡¹&gt;<br><span class="hljs-comment"># åˆ é™¤æ‰€æœ‰çš„stash</span><br>git stash clear<br><span class="hljs-comment"># åˆ é™¤æŒ‡å®šçš„ä¸€æ¬¡stash</span><br>git stash drop &lt;stash è®°å½•&gt;<br></code></pre></td></tr></table></figure><blockquote><p>å¦‚æœéœ€è¦æš‚å­˜è¿˜æœªè¢«<code>git</code>è·Ÿè¸ªçš„æ–‡ä»¶ï¼Œå¯ä»¥å…ˆ<code>git add</code> åå†<code>git stash</code></p></blockquote><h3 id="git-reset"><a href="#git-reset" class="headerlink" title="git reset"></a>git reset</h3><p>ç‰ˆæœ¬å›é€€ï¼Œå¦‚æœæ˜¯è¿˜æœªæäº¤åˆ°è¿œç«¯ä»“åº“ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨<code>git reset</code> å›é€€ï¼Œå¦‚æœå·²ç»æäº¤åˆ™éœ€è¦ä¸‹é¢æåˆ°çš„<code>git revert</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å›é€€ä¸€ä¸ªcommit</span><br>git reset HEAD^<br><span class="hljs-comment"># å‘åå›é€€ä¸¤ä¸ªcommit, å¹¶ä¸”ä¸¢å¤±å›é€€åçš„æ‰€æœ‰commitæ•°æ®</span><br>git reset --hard HEAD~2<br></code></pre></td></tr></table></figure><h3 id="git-revert"><a href="#git-revert" class="headerlink" title="git revert"></a>git revert</h3><p>ç‰ˆæœ¬å›é€€ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>commit</code>è®°å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ’¤é”€æœ€æ–°çš„commit</span><br>git revert HEAD<br></code></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://juejin.cn/post/6974184935804534815?share_token=e6867a4f-d921-469d-84e2-e4a3e1810d0f">https://juejin.cn/post/6974184935804534815?share_token=e6867a4f-d921-469d-84e2-e4a3e1810d0f</a></p><p>[2] <a href="https://learngitbranching.js.org/?locale=zh_CN">https://learngitbranching.js.org/?locale=zh_CN</a></p><p>[3] <a href="https://www.liaoxuefeng.com/wiki/896043488029600">https://www.liaoxuefeng.com/wiki/896043488029600</a>)</p><p>[4] <a href="https://www.cnblogs.com/hujunzheng/p/9732936.html">https://www.cnblogs.com/hujunzheng/p/9732936.html</a></p><p>[5] <a href="https://www.ruanyifeng.com/blog/2020/04/git-cherry-pick.html">https://www.ruanyifeng.com/blog/2020/04/git-cherry-pick.html</a></p>]]></content>
    
    
    <categories>
      
      <category>other</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>typeofçš„ç”¨æ³•</title>
    <link href="/2021/06/30/typeof%E7%9A%84%E7%94%A8%E6%B3%95/"/>
    <url>/2021/06/30/typeof%E7%9A%84%E7%94%A8%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code>typeof</code> çš„ä¸€èˆ¬æ“ä½œï¼Œå°±æ˜¯ç”¨æ¥åˆ¤æ–­æŸä¸ªå˜é‡æ˜¯ä»€ä¹ˆç±»å‹ï¼Œä»è€Œè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚ä½†æ˜¯æœ€è¿‘å‘ç°<code>lodash</code>æºç ä¸­<code>typeof</code>è¿˜æœ‰å¦‚æ­¤ä½œç”¨ï¼Œç‰¹è®°å½•äºæ­¤</p><h2 id="å¸¸è§„æ“ä½œ"><a href="#å¸¸è§„æ“ä½œ" class="headerlink" title="å¸¸è§„æ“ä½œ"></a>å¸¸è§„æ“ä½œ</h2><p>å¸¸è§„æ“ä½œæ— éå°±æ˜¯åˆ¤æ–­ç±»å‹ï¼Œå¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">typeof</span> <span class="hljs-literal">null</span> === <span class="hljs-string">&#x27;object&#x27;</span> <span class="hljs-comment">//true æ³¨ï¼šç‰¹æ®Š</span><br><span class="hljs-keyword">typeof</span> <span class="hljs-literal">undefined</span> === <span class="hljs-string">&#x27;undefined&#x27;</span> <span class="hljs-comment">//true</span><br><span class="hljs-keyword">typeof</span> <span class="hljs-number">111</span> === <span class="hljs-string">&#x27;number&#x27;</span> <span class="hljs-comment">//true</span><br><span class="hljs-keyword">typeof</span> <span class="hljs-string">&#x27;å­—ç¬¦ä¸²&#x27;</span> === <span class="hljs-string">&#x27;string&#x27;</span> <span class="hljs-comment">//true</span><br><span class="hljs-keyword">typeof</span> <span class="hljs-literal">true</span> === <span class="hljs-string">&#x27;boolean&#x27;</span> <span class="hljs-comment">//true</span><br><span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;foo&#x27;</span>) === <span class="hljs-string">&#x27;symbol&#x27;</span> <span class="hljs-comment">//true</span><br><span class="hljs-keyword">typeof</span> <span class="hljs-number">111n</span> === <span class="hljs-string">&#x27;bigint&#x27;</span> <span class="hljs-comment">//true</span><br><span class="hljs-keyword">typeof</span> &#123;&#125; === <span class="hljs-string">&#x27;object&#x27;</span> <span class="hljs-comment">//true</span><br><span class="hljs-keyword">typeof</span> [] === <span class="hljs-string">&#x27;object&#x27;</span> <span class="hljs-comment">//true</span><br><span class="hljs-keyword">typeof</span> (<span class="hljs-function">() =&gt;</span> &#123;&#125;) === <span class="hljs-string">&#x27;function&#x27;</span> <span class="hljs-comment">//true</span><br></code></pre></td></tr></table></figure><h2 id="éå¸¸è§„æ“ä½œ"><a href="#éå¸¸è§„æ“ä½œ" class="headerlink" title="éå¸¸è§„æ“ä½œ"></a>éå¸¸è§„æ“ä½œ</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹äºæœªå£°æ˜çš„å˜é‡ï¼Œåªèƒ½æ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œé‚£å°±æ˜¯ä½¿ç”¨<code>typeof</code>åˆ¤æ–­ç±»å‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//let a = 1  //ç¡®ä¿aæ²¡æœ‰å£°æ˜</span><br><span class="hljs-keyword">typeof</span> a  <span class="hljs-comment">//undefined</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">//æŠ¥é”™: Uncaught ReferenceError: a is not defined</span><br></code></pre></td></tr></table></figure><p>é‚£æ€ä¹ˆèƒ½è®©ç¬¬äºŒä¸ªè¯­å¥ä¸æŠ¥é”™ï¼Œæœ‰è¾“å‡ºå‘¢ï¼Ÿå¾€ä¸‹çœ‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">&#x27;undefined&#x27;</span> &amp;&amp; a) <span class="hljs-comment">//è¾“å‡ºfalse</span><br></code></pre></td></tr></table></figure><blockquote><p><code>lodash</code>ç±»ä¼¼æºç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/** Detect free variable `global` from Node.js. */</span><br><span class="hljs-keyword">const</span> freeGlobal = <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">global</span> === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; <span class="hljs-variable language_">global</span> !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-variable language_">global</span>.<span class="hljs-property">Object</span> === <span class="hljs-title class_">Object</span> &amp;&amp; <span class="hljs-variable language_">global</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> freeGlobal<br></code></pre></td></tr></table></figure></blockquote>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
      <tag>æºç è§£æ</tag>
      
      <tag>lodash</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>eslint æ­é… vscode çš„ç®€å•ä½¿ç”¨</title>
    <link href="/2021/05/12/eslint-%E6%90%AD%E9%85%8D-vscode-%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <url>/2021/05/12/eslint-%E6%90%AD%E9%85%8D-vscode-%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åˆšå¼€å§‹æ—¶ï¼Œç”±äºå«Œéº»çƒ¦ï¼Œå¹¶æ²¡æœ‰å®‰è£…<code>eslint</code>ï¼Œæœ€è¿‘åœ¨æ–°çš„é¡¹ç›®ä¸Šä½¿ç”¨äº†<code>eslint</code>å†é…åˆ<code>vscode</code>çš„æ’ä»¶ï¼ŒçœŸæ˜¯çˆ½çš„ä¸è¦å¤ªçˆ½ã€‚å› æ­¤æ‰“ç®—å†™ä¸€ç¯‡ç®€å•çš„é£Ÿç”¨è¯´æ˜æ¥è®°å½•é£Ÿç”¨è¿‡ç¨‹</p><h2 id="å‰æœŸå‡†å¤‡"><a href="#å‰æœŸå‡†å¤‡" class="headerlink" title="å‰æœŸå‡†å¤‡"></a>å‰æœŸå‡†å¤‡</h2><p>æ²¡å•¥å¥½å‡†å¤‡çš„ï¼Œä½œä¸ºå¼€å‘è‚¯å®šæ˜¯å…·å¤‡<code>yarn</code>å’Œ<code>node</code>çš„ï¼Œç¼–è¾‘å™¨ä½¿ç”¨çš„æ˜¯å¾®è½¯çš„äº²å„¿å­<code>vscode</code> </p><p>ç„¶åæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹<code>eslint-example</code>ï¼Œ<code>cd</code>è¿›å…¥è¿™ä¸ªæ–‡ä»¶å¤¹å¹¶åˆå§‹åŒ–ä¸€ä¸ª<code>package.json</code></p><p>åˆå§‹åŒ–<code>package.json</code>å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ yarn init -y<br></code></pre></td></tr></table></figure><p>æ–‡ä»¶ç»“æ„</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">-</span> eslint-example<br><span class="hljs-bullet">-</span> package.json<br></code></pre></td></tr></table></figure><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>é¦–å…ˆå®‰è£…<code>eslint</code>ï¼Œå¹¶åˆå§‹åŒ–ä¸€ä¸ªé…ç½®æ–‡ä»¶ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ yarn add eslint --dev<br>$ ./node_modules/.bin/eslint --init<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–å®Œæˆåä¼šåœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªé…ç½®æ–‡ä»¶<code>.eslintrc.js</code>ï¼ˆä½ çš„å¯èƒ½å’Œæˆ‘çš„ä¸ä¸€æ ·ï¼Œä½†å‰ç¼€éƒ½æ˜¯ä¸€æ ·çš„ï¼‰ </p><blockquote><p>å…³äºé…ç½®æ–‡ä»¶çš„ä¸€äº›è¯´æ˜ï¼Œé…ç½®æ–‡ä»¶å¯ä»¥ä½¿ç”¨<code>.js</code>ï¼Œ<code>.json</code>ï¼Œ<code>.yaml/.yml</code>åç¼€æˆ–è€…æ²¡æœ‰åç¼€çš„<code>.eslintrc</code>æ–‡ä»¶,ä¹Ÿå¯ä»¥ç›´æ¥åœ¨<code>package.json</code>ä¸­æ·»åŠ ä¸€ä¸ª<code>eslintConfig</code>å±æ€§è¿›è¡Œé…ç½®ã€‚<code>eslint</code>ä¼šè¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œä¼˜å…ˆçº§ä¸ºä»å·¦åˆ°å³ä¾æ¬¡æŸ¥æ‰¾æ–‡ä»¶æ ¼å¼ï¼Œæ²¡æœ‰åç¼€çš„é…ç½®æ–‡ä»¶å£°æ˜å·²åºŸå¼ƒï¼Œä¸å»ºè®®ä½¿ç”¨</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>...<br>    <span class="hljs-comment">//åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰è§„åˆ™å»è¦†ç›–é»˜è®¤è§„åˆ™</span><br>    <span class="hljs-string">&quot;rules&quot;</span>: &#123;<br>        <span class="hljs-comment">//è¦æ±‚æˆ–ç¦æ­¢ä½¿ç”¨åˆ†å·ä»£æ›¿ ASI</span><br>        <span class="hljs-string">&quot;semi&quot;</span>: [<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;always&quot;</span>],<br>        <span class="hljs-comment">//å¼ºåˆ¶ä½¿ç”¨ä¸€è‡´çš„ç¼©è¿›</span><br>        <span class="hljs-string">&quot;indent&quot;</span>: [<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-number">2</span>],<br>        <span class="hljs-comment">//å¼ºåˆ¶ä½¿ç”¨ä¸€è‡´çš„åå‹¾å·ã€åŒå¼•å·æˆ–å•å¼•å·</span><br>        <span class="hljs-string">&quot;quotes&quot;</span>: [<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;double&quot;</span>],<br>        <span class="hljs-comment">//ç¦ç”¨console</span><br>        <span class="hljs-string">&quot;no-console&quot;</span>: <span class="hljs-string">&quot;warn&quot;</span> <span class="hljs-comment">// å¯ä»¥ç›´æ¥å†™é”™è¯¯ç±»å‹</span><br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>eslint</code>æœ‰ä¸‰ç§é”™è¯¯è§„åˆ™ï¼Œå¯ä»¥ç›´æ¥å†™è§„åˆ™ç±»å‹ä¹Ÿå¯ä»¥ç›´æ¥å†™æ•°å­—ï¼Œé”™è¯¯è§„åˆ™:</p><ul><li><code>error</code>å¯¹åº”æ•°å­—<code>2</code></li><li><code>warn</code>å¯¹åº”æ•°å­—<code>1</code></li><li><code>off</code>å¯¹åº”æ•°å­—<code>0</code></li></ul><p>åœ¨<code>package.json</code>ä¸­æ·»åŠ <code>scripts</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">...<br><span class="hljs-attr">&quot;script&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;lint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eslint --ext .js src&quot;</span><br><span class="hljs-punctuation">&#125;</span><br>...<br></code></pre></td></tr></table></figure><p>è¿è¡Œå‘½ä»¤éªŒè¯</p><h2 id="é…åˆvscodeæ’ä»¶é£Ÿç”¨æ›´èˆ’é€‚"><a href="#é…åˆvscodeæ’ä»¶é£Ÿç”¨æ›´èˆ’é€‚" class="headerlink" title="é…åˆvscodeæ’ä»¶é£Ÿç”¨æ›´èˆ’é€‚"></a>é…åˆvscodeæ’ä»¶é£Ÿç”¨æ›´èˆ’é€‚</h2><p>åœ¨<code>vscode</code>çš„æ’ä»¶æ æœç´¢<code>eslint</code>ï¼Œå®‰è£…<code>ESLint</code>æ’ä»¶</p><p>ç„¶ååœ¨<code>settings.json</code>ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œå¯¹äºæ›´è¯¦ç»†çš„é…ç½®è¯·æŸ¥çœ‹æ’ä»¶æ–‡æ¡£<sup>[2]</sup> </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">...<br><span class="hljs-comment">//ä¸ºeslintå¼€å¯è‡ªåŠ¨ä¿®å¤ï¼Œä¿å­˜æ—¶å°†è§¦å‘ï¼Œä½†å¹¶ä¸èƒ½è‡ªåŠ¨ä¿®å¤æ‰€æœ‰çš„é—®é¢˜ï¼Œä½†å·²ç»å¾ˆçˆ½äº†</span><br><span class="hljs-attr">&quot;editor.codeActionsOnSave&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;source.fixAll.eslint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] <a href="https://eslint.org/docs/user-guide/">https://eslint.org/docs/user-guide/</a> </p><p>[2] <a href="https://github.com/Microsoft/vscode-eslint#readme">https://github.com/Microsoft/vscode-eslint#readme</a> </p>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨canalè¿æ¥kafka</title>
    <link href="/2021/04/20/%E4%BD%BF%E7%94%A8canal%E8%BF%9E%E6%8E%A5kafka/"/>
    <url>/2021/04/20/%E4%BD%BF%E7%94%A8canal%E8%BF%9E%E6%8E%A5kafka/</url>
    
    <content type="html"><![CDATA[<h1 id="ä½¿ç”¨canalè¿æ¥kafka"><a href="#ä½¿ç”¨canalè¿æ¥kafka" class="headerlink" title="ä½¿ç”¨canalè¿æ¥kafka"></a>ä½¿ç”¨canalè¿æ¥kafka</h1><p>è¿™ç¯‡ä¸»è¦æ˜¯é¡¹ç›®è¿˜åŸï¼Œç›®çš„æ˜¯è®°å½•æ„å»ºæ—¶é‡åˆ°çš„å„ç§å¥‡è‘©å‘ï¼Œé¿å…ä¸‹æ¬¡è¿·è·¯ã€‚åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šæ‰‹ã€‚</p><blockquote><p>é»˜è®¤å·²å®‰è£…<code>docker</code>ï¼Œ<code>docker-compose</code>ï¼Œ<code>nodejs</code>ï¼Œ<code>yarn</code>ï¼Œ<code>typescript</code>  </p></blockquote><ol><li>é¦–å…ˆæ ¹æ® <a href="https://github.com/wurstmeister/kafka-docker/blob/master/docker-compose.yml">kafka-docker</a> è¿™ä¸ªå®˜æ–¹çš„ä»“åº“ä¸‹çš„<code>docker-compose.yml</code>å¤åˆ¶ä¸€ä»½åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;2&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">zookeeper:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">wurstmeister/zookeeper</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;2181:2181&quot;</span><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9092&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-comment"># æ›´æ”¹ä¸ºè‡ªå·±çš„ipåœ°å€ï¼Œæœ€å¥½æ˜¯ipåœ°å€ï¼Œæˆ‘å…ˆä½¿ç”¨localhost</span><br>      <span class="hljs-attr">KAFKA_ADVERTISED_HOST_NAME:</span> <span class="hljs-string">localhost</span><br>      <span class="hljs-attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="hljs-string">zookeeper:2181</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/var/run/docker.sock:/var/run/docker.sock</span><br></code></pre></td></tr></table></figure><p>å°†<code>kafka</code>ä¸‹çš„<code>build</code>é¡¹ï¼Œæ›´æ”¹ä¸º<code>kafka</code>é•œåƒï¼Œå¯ä»¥ä»<a href="https://hub.docker.com/r/wurstmeister/kafka">dockerhub</a>ä¸­æŸ¥æ‰¾æŒ‡å®šç‰ˆæœ¬çš„<code>kafka</code>ï¼Œè¿™é‡Œä½¿ç”¨<code>wurstmeister/kafka:2.13-2.7.0</code></p><p>åœ¨<code>environment</code>ä¸‹æ·»åŠ é…ç½®å±æ€§</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">...</span><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">wurstmeister/kafka:2.13-2.7.0</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9092:9092&quot;</span> <span class="hljs-comment">#å‘å¤–æš´éœ²ç«¯å£</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">KAFKA_BROKER_ID:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#æ–°å¢ä¸€ä¸ªbroker id</span><br>      <span class="hljs-attr">KAFKA_ADVERTISED_HOST_NAME:</span> <span class="hljs-string">localhost</span><br>      <span class="hljs-attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="hljs-string">zookeeper:2181</span><br>      <span class="hljs-attr">KAFKA_CREATE_TOPICS:</span> <span class="hljs-string">&quot;test:2:1&quot;</span> <span class="hljs-comment">#æ–°å¢ä¸€ä¸ªtopicæˆ–å¤šä¸ª </span><br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ‹‰å–é•œåƒï¼Œå¹¶è¿è¡Œèµ·æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ docker-compose up<br></code></pre></td></tr></table></figure><ol start="2"><li><p>ç¼–å†™<code>Producer</code>å’Œ<code>Customer</code> </p><p><code>kafkajs</code>ç‰ˆ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//config.ts //ç®€å•çš„é…ç½®</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Config</span> = &#123;<br>    <span class="hljs-attr">brokers</span>: [<br>        <span class="hljs-string">&quot;localhost:9092&quot;</span> <span class="hljs-comment">//kafkaçš„æœåŠ¡å™¨</span><br>    ],<br>    <span class="hljs-attr">topic</span>: <span class="hljs-string">&#x27;test&#x27;</span> <span class="hljs-comment">//ä¸kafkaæ·»åŠ çš„topcsä¸€æ ·</span><br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Config</span>;<br><br><br><span class="hljs-comment">//kafka.ts //å®ä¾‹åŒ–ä¸€ä¸ªkafkajså¯¹è±¡</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Kafka</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;kafkajs&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./config&quot;</span>;<br><br><span class="hljs-keyword">const</span> kafka = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Kafka</span>(&#123;<br>    <span class="hljs-attr">clientId</span>: <span class="hljs-string">&#x27;kafkajs&#x27;</span>,<br>    <span class="hljs-attr">brokers</span>: <span class="hljs-title class_">Config</span>.<span class="hljs-property">brokers</span><br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> kafka;<br><br><span class="hljs-comment">//producer.ts //kafka Producer</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Message</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;kafkajs&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./config&quot;</span>;<br><span class="hljs-keyword">import</span> kafka <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./kafka&quot;</span>;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">messages: Message[]</span>) &#123;<br>    <span class="hljs-keyword">const</span> producer = kafka.<span class="hljs-title function_">producer</span>();<br>    <span class="hljs-keyword">await</span> producer.<span class="hljs-title function_">connect</span>();<br>    <span class="hljs-keyword">await</span> producer.<span class="hljs-title function_">send</span>(&#123;<br>        <span class="hljs-attr">topic</span>: <span class="hljs-title class_">Config</span>.<span class="hljs-property">topic</span>,<br>        messages<br>    &#125;);<br>    <span class="hljs-keyword">await</span> producer.<span class="hljs-title function_">disconnect</span>()<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> producer;<br><br><span class="hljs-comment">//consumer.ts //kafka Consumer</span><br><span class="hljs-keyword">import</span> kafka <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./kafka&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Config</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./config&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ConsumerConfig</span>, <span class="hljs-title class_">EachMessagePayload</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;kafkajs&quot;</span>;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">consumer</span>(<span class="hljs-params">config: ConsumerConfig</span>) &#123;<br>    <span class="hljs-keyword">const</span> consumer = kafka.<span class="hljs-title function_">consumer</span>(config);<br>    <span class="hljs-keyword">await</span> consumer.<span class="hljs-title function_">connect</span>()<br>    <span class="hljs-keyword">await</span> consumer.<span class="hljs-title function_">subscribe</span>(&#123;<br>        <span class="hljs-attr">topic</span>: <span class="hljs-title class_">Config</span>.<span class="hljs-property">topic</span>,<br>        <span class="hljs-attr">fromBeginning</span>: <span class="hljs-literal">true</span><br>    &#125;);<br>    <span class="hljs-keyword">await</span> consumer.<span class="hljs-title function_">run</span>(&#123;<br>        <span class="hljs-attr">eachMessage</span>: <span class="hljs-keyword">async</span> (&#123;topic, partition, message&#125;: <span class="hljs-title class_">EachMessagePayload</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; =&gt; &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(&#123;<br>                <span class="hljs-attr">value</span>: message.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>(),<br>                topic,<br>                partition<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> consumer;<br><br><span class="hljs-comment">//index.ts //å‡½æ•°å…¥å£</span><br><span class="hljs-keyword">import</span> producer <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./producer&quot;</span>;<br><span class="hljs-keyword">import</span> consumer <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./consumer&#x27;</span>;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">producer</span>([<br>        &#123;<span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;Hello&#x27;</span>&#125;,<br>        &#123;<span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;,&#x27;</span>&#125;,<br>        &#123;<span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;I\&#x27;m&#x27;</span>&#125;,<br>        &#123;<span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;kafkajs&#x27;</span>&#125;<br>    ])<br><br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">consumer</span>(&#123;<br>        <span class="hljs-attr">groupId</span>: <span class="hljs-string">&#x27;consumer-1&#x27;</span><br>    &#125;)<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">consumer</span>(&#123;<br>        <span class="hljs-attr">groupId</span>: <span class="hljs-string">&#x27;consumer-2&#x27;</span><br>    &#125;)<br>&#125;<br><br><span class="hljs-title function_">start</span>()<br>.<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åç¼–è¯‘æ–‡ä»¶ï¼Œå¹¶è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ¶ˆæ¯ä»<code>Producer</code>å‘é€åˆ°äº†<code>Consumer</code></p></li><li><p>æ¥å…¥<code>canal</code></p><p>ä¿®æ”¹<code>docker-compose.yml</code>ï¼Œæ·»åŠ <code>canal</code>çš„é•œåƒå’Œç›¸å…³é…ç½®ï¼ŒåŒæ—¶æ·»åŠ ä¸€ä¸ªæµ‹è¯•çš„<code>mysql</code>é•œåƒï¼ˆæ³¨ï¼Œç”±äºé¡¹ç›®éœ€æ±‚ï¼Œæˆ‘è¿˜é…ç½®äº†<code>wordpress</code>é•œåƒï¼‰</p><p><a href="https://github.com/alibaba/canal/wiki/AdminGuide">canalé…ç½®è¯´æ˜</a> </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">...</span><br>  <span class="hljs-attr">canal:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">canal/canal-server:v1.1.4</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.instance.mysql.slaveId=54321</span> <span class="hljs-comment">#slave id ä¸è¦ä¸mysqlçš„ä¸€æ ·å°±è¡Œ</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.instance.master.address=mysql:3306</span> <span class="hljs-comment">#mysqlåœ°å€</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.instance.dbUsername=kafka</span> <span class="hljs-comment">#mysql å¯¹åº”çš„ç”¨æˆ·å</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.instance.dbPassword=kafka</span> <span class="hljs-comment">#mysql å¯¹åº”çš„å¯†ç </span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.instance.parser.parallel=false</span> <span class="hljs-comment">#ç”±äºæˆ‘ç”¨çš„è™šæ‹Ÿæœºï¼Œcpuä¸º1Gï¼Œæ‰€ä»¥è®¾ä¸ºfalse</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.instance.filter.regex=kafka\.user</span> <span class="hljs-comment">#æ•°æ®åº“ä¸­è¦ç›‘å¬çš„è¡¨ï¼Œè¯¦ç»†çœ‹å®˜æ–¹è¯´æ˜</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.mq.dynamicTopic=.*\..*</span> <span class="hljs-comment">#åŠ¨æ€ç”Ÿæˆtopic</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.zkServers=zookeeper:2181</span> <span class="hljs-comment">#é“¾æ¥zookeeperé›†ç¾¤çš„é“¾æ¥ä¿¡æ¯</span><br>      <span class="hljs-comment">#canal.properties é…ç½®</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.serverMode=kafka</span> <span class="hljs-comment">#MQä½¿ç”¨çš„kafka</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">canal.mq.servers=kafka:9092</span> <span class="hljs-comment">#kafkaåœ°å€</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">zookeeper</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">kafka</span><br><br>  <span class="hljs-attr">mysql:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./configuration/conf.d/binlog.cnf:/etc/mysql/conf.d/binlog.cnf</span> <span class="hljs-comment">#ä¸ºäº†è®©mysqlå¼€å¯bin_logæ¨¡å¼çš„é…ç½®</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root_password_can_you</span><br>      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">kafkadb</span><br>      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">kafka</span><br>      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">kafka</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">3306</span><span class="hljs-string">:3306</span><br><br></code></pre></td></tr></table></figure><p><code>binlog.cnf</code>é…ç½®æ–‡ä»¶å†…å®¹ï¼Œ<a href="https://github.com/alibaba/canal/wiki/QuickStart#%E5%87%86%E5%A4%87">canalå®˜æ–¹è¯´æ˜</a> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">[mysqld]<br>log-bin=mysql-bin # å¼€å¯ binlog<br>binlog-format=ROW # é€‰æ‹© ROW æ¨¡å¼<br>server_id=1 # é…ç½® MySQL replaction éœ€è¦å®šä¹‰ï¼Œä¸è¦å’Œ canal çš„ slaveId é‡å¤<br></code></pre></td></tr></table></figure><p>æ‹‰å–é•œåƒï¼Œå¯åŠ¨é¡¹ç›®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ docker-compose up<br></code></pre></td></tr></table></figure><p>æ›´æ”¹<code>mysql</code>æƒé™ ï¼Œä½¿ç”¨<code>root</code>ç™»å½•åˆ°<code>mysql</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE USER kafka IDENTIFIED BY &#x27;kafka&#x27;;  # åˆ›å»ºä¸docker-compose.ymlä¸­å¯¹åº”çš„ç”¨æˆ·å’Œå¯†ç <br>GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#x27;kafka&#x27;@&#x27;%&#x27;; #ç»™mysqlç”¨æˆ·æƒé™<br>-- GRANT ALL PRIVILEGES ON *.* TO &#x27;canal&#x27;@&#x27;%&#x27; ; #ä¹Ÿå¯ä»¥ç»™æ‰€æœ‰æƒé™<br>FLUSH PRIVILEGES;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªæ•°æ®åº“<code>kafkadb</code>å¹¶æ·»åŠ ä¸€ä¸ª<code>user</code>è¡¨</p><p>å‘<code>user</code>è¡¨æ’å…¥æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">INSERT INTO user ( `id`, `username`) VALUES ( 1, &#x27;yan&#x27;);<br></code></pre></td></tr></table></figure><p>å¥½åƒæ²¡æœ‰æ•°æ®è¿‡æ¥ï¼ˆè‡³å°‘æˆ‘çš„æ˜¯è¿™æ ·ï¼‰</p></li><li><p>æ’æŸ¥é—®é¢˜</p><p>é¦–å…ˆæŸ¥çœ‹æ˜¯å¦é•œåƒè¿è¡Œæ­£å¸¸</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ docker ps <br></code></pre></td></tr></table></figure><p>å‘ç°æ²¡æœ‰é—®é¢˜ï¼Œåªæœ‰ä¾æ¬¡æ’æŸ¥æ¯ä¸ªé•œåƒæ—¥å¿—ï¼Œå…ˆä»<code>canal</code>æŸ¥èµ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ docker <span class="hljs-built_in">exec</span> -it &lt;canal é•œåƒ&gt; bash<br><span class="hljs-comment">#ç„¶åè¿›å…¥canal-serveræ–‡ä»¶å¤¹</span><br>$ <span class="hljs-built_in">cd</span> canal-server<br>$ <span class="hljs-built_in">cat</span> logs/example/example.log<br><span class="hljs-comment">#å‘ç°å‡ºé”™äº†ï¼Œä»¥ä¸‹ä¸ºç‰‡æ®µ</span><br><span class="hljs-comment"># Caused by: java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.TimeoutException: Failed to update metadata after 60000 ms.</span><br></code></pre></td></tr></table></figure><p>ç™¾åº¦åï¼Œå‘ç°å’Œ<a href="https://blog.csdn.net/maoyuanming0806/article/details/80553632">è¿™ä¸ªé—®é¢˜å¾ˆåƒ</a>ï¼Œé‚£åº”è¯¥å°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„<code>kafka</code>çš„<code>ip</code>è®¾ç½®æˆ<code>localhost</code>å¯¼è‡´çš„ï¼Œå°è¯•æ›´æ”¹ä¸€ä¸‹ï¼Œé—®é¢˜è§£å†³</p><p>å†æ’å…¥æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®è¢«æ¥æ”¶åˆ°äº†</p></li></ol><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>å…¶å®åœ¨éƒ¨ç½²ä¹‹é—´ï¼Œé‡åˆ°äº†å¾ˆå¤šé—®é¢˜ï¼Œç”±äºè¿™æ¬¡æ˜¯é—®é¢˜é‡ç°ï¼Œæœ‰äº›é—®é¢˜å¹¶æ²¡æœ‰å†å‡ºç°</p><p>ä¾‹å¦‚æœ‰è‡ªå·±å†™çš„<code>Producer</code>ç¨‹åºæ¨é€æ¶ˆæ¯æ—¶ï¼ŒæŠ¥é”™<code>There is no leader for this topic-partition as we are in the middle of a leadership election</code> è¿™æ˜¯ç”±äºï¼Œæ²¡æœ‰è®¾ç½®<code>KAFKA_BROKER_ID</code>å¯¼è‡´æ¯æ¬¡æ„å»ºé¡¹ç›®ï¼Œéƒ½é‡æ–°ç”Ÿæˆäº†<code>brokder id</code>ï¼Œå¯ä»¥åœ¨æ„å»ºé¡¹ç›®æ—¶åœ¨å…¶åæ·»åŠ <code>--no-recreate</code> ï¼Œ<a href="https://github.com/wurstmeister/kafka-docker/issues/516">å¯ä»¥å†è¿™é‡Œæ‰¾åˆ°</a> ã€‚è®°å¾—ä½¿ç”¨<code>docker-compose rm -vfs</code>åˆ é™¤åå†æ„å»ºé¡¹ç›®</p><p>ä¹Ÿæœ‰<code>zookeeper</code>æŠ¥é”™<code>Zookeeper Report Error:KeeperErrorCode = NoNode</code>ï¼Œ<a href="https://github.com/wurstmeister/kafka-docker/issues/427">å¯ä»¥å†è¿™é‡Œæ‰¾åˆ°</a> </p><p>ç­‰ç­‰</p>]]></content>
    
    
    <categories>
      
      <category>other</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kafka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®šå‹æ•°ç»„(typed array)</title>
    <link href="/2021/04/09/%E5%AE%9A%E5%9E%8B%E6%95%B0%E7%BB%84-typed-array/"/>
    <url>/2021/04/09/%E5%AE%9A%E5%9E%8B%E6%95%B0%E7%BB%84-typed-array/</url>
    
    <content type="html"><![CDATA[<h1 id="å®šå‹æ•°ç»„ï¼ˆtyped-array"><a href="#å®šå‹æ•°ç»„ï¼ˆtyped-array" class="headerlink" title="å®šå‹æ•°ç»„ï¼ˆtyped array)"></a>å®šå‹æ•°ç»„ï¼ˆtyped array)</h1><p>å®šå‹æ•°ç»„<code>ï¼ˆtyped arrayï¼‰</code>æ˜¯<code>ECMAScript</code>æ–°å¢çš„ç»“æ„ï¼Œç›®çš„æ˜¯æå‡å‘åŸç”Ÿåº“ä¼ è¾“æ•°æ®çš„æ•ˆç‡ã€‚å®é™…ä¸Šï¼Œ<code>JavaScript</code>å¹¶æ²¡æœ‰<code>&quot;TypedArray&quot;</code>ç±»å‹ï¼Œå®ƒæ‰€æŒ‡çš„å…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„åŒ…å«æ•°å€¼ç±»å‹çš„æ•°ç»„</p><h2 id="ArrayBuffer"><a href="#ArrayBuffer" class="headerlink" title="ArrayBuffer"></a>ArrayBuffer</h2><p><code>ArrayBuffer</code>æ˜¯æ‰€æœ‰å®šå‹æ•°ç»„åŠè§†å›¾å¼•ç”¨çš„<strong>åŸºæœ¬å•ä½</strong>ã€‚</p><blockquote><p><code>SharedArrayBuffer</code>æ˜¯<code>ArrayBuffer</code>çš„ä¸€ä¸ªå˜ä½“ï¼Œå¯ä»¥æ— é¡»å¤åˆ¶å°±åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡é—´ä¼ é€’å®ƒ</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>) <span class="hljs-comment">//åœ¨å†…å­˜ä¸­åˆ†é…2ä¸ªå­—èŠ‚</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buf)<span class="hljs-comment">//ArrayBuffer(2) &#123;&#125;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buf.<span class="hljs-property">byteLength</span>) <span class="hljs-comment">//2 //è¿”å›åˆ†é…çš„å­—èŠ‚é•¿åº¦</span><br></code></pre></td></tr></table></figure><p><code>ArrayBuffer</code>ä¸€ç»åˆ›å»ºå°±ä¸èƒ½å†è°ƒæ•´å¤§å°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">16</span>)<br><span class="hljs-keyword">const</span> buf2 = buf.<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span>, <span class="hljs-number">12</span>) <span class="hljs-comment">//ä½†å¯ä»¥ä½¿ç”¨slice()å¤åˆ¶éƒ¨åˆ†åˆ°æ–°çš„å®ä¾‹ä¸­</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buf2.<span class="hljs-property">byteLength</span>) <span class="hljs-comment">//8</span><br></code></pre></td></tr></table></figure><p><code>ArrayBuffer</code>åˆ†é…çš„å †å†…å­˜å¯ä»¥è¢«å½“æˆåƒåœ¾å›æ”¶ï¼Œä¸ç”¨æ‰‹åŠ¨é‡Šæ”¾ï¼ˆç›¸æ¯”äº<code>C/C++</code>çš„<code>malloc()</code>ï¼‰</p><h2 id="DataView"><a href="#DataView" class="headerlink" title="DataView"></a>DataView</h2><p><code>DataView</code>ç”¨äºè¯»å†™<code>ArrayBuffer</code>çš„è§†å›¾ã€‚ä¸“ä¸ºæ–‡ä»¶<code>I/O</code>å’Œç½‘ç»œ<code>I/O</code>è®¾è®¡ï¼Œå…¶<code>API</code>æ”¯æŒå¯¹ç¼“å†²æ•°æ®çš„é«˜åº¦æ§åˆ¶ï¼Œä½†è¾ƒå…¶ä»–ç±»å‹çš„è§†å›¾ï¼Œæ€§èƒ½å·®ä¸€äº›ã€‚</p><p>å¿…é¡»å¯¹å·²æœ‰çš„<code>ArrayBuffer</code>è¿›è¡Œè¯»&#x2F;å†™æ‰èƒ½åˆ›å»º<code>DataView</code>å®ä¾‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">16</span>)<br><span class="hljs-keyword">const</span> dv = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buf) <span class="hljs-comment">//é»˜è®¤ä½¿ç”¨æ•´ä¸ªArrayBuffer</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv) <span class="hljs-comment">//DataView(16) &#123;&#125; </span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv.<span class="hljs-property">byteLength</span>) <span class="hljs-comment">//16</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv.<span class="hljs-property">byteOffset</span>) <span class="hljs-comment">//0</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv.<span class="hljs-property">buffer</span> === buf) <span class="hljs-comment">//true</span><br><br><span class="hljs-comment">//ä½¿ç”¨éƒ¨åˆ†ArrayBuffer</span><br><span class="hljs-keyword">const</span> dv2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buf, <span class="hljs-comment">/*offset*/</span><span class="hljs-number">2</span>, <span class="hljs-comment">/*length*/</span><span class="hljs-number">4</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv2) <span class="hljs-comment">//DataView(4) &#123;&#125;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv2.<span class="hljs-property">byteLength</span>) <span class="hljs-comment">//4</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv2.<span class="hljs-property">byteOffset</span>) <span class="hljs-comment">//2</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv2.<span class="hljs-property">buffer</span> === buf) <span class="hljs-comment">//true</span><br></code></pre></td></tr></table></figure><p>è¯»å–ç¼“å†²ï¼Œéœ€è¦å‡ ä¸ª<code>ElementType</code>ç»„ä»¶ï¼Œç±»ä¼¼äº<code>C</code>ä¸­çš„ç±»å‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">16</span>)<br><span class="hljs-keyword">const</span> dv = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>)<br><br><span class="hljs-comment">//è¯´æ˜DataViewçš„å®ä¾‹é»˜è®¤å€¼åˆå§‹å€¼ä¸º0</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv.<span class="hljs-title function_">getInt8</span>(<span class="hljs-number">0</span>)) <span class="hljs-comment">//0 //ä»¥8ä½æœ‰ç¬¦å·æ•´æ•°è¿›è¡Œè¯»å–,è¯»å–ç¬¬ä¸€ä¸ªå­—èŠ‚</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv.<span class="hljs-title function_">getInt8</span>(<span class="hljs-number">1</span>)) <span class="hljs-comment">//0</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv.<span class="hljs-title function_">getInt16</span>(<span class="hljs-number">0</span>)) <span class="hljs-comment">//0 //ä»¥16ä½æœ‰ç¬¦å·æ•´æ•°è¿›è¡Œè¯»å–,è¯»å–ä¸¤ä¸ªå­—èŠ‚</span><br><span class="hljs-comment">//å†™å…¥</span><br>dv.<span class="hljs-title function_">setInt8</span>(<span class="hljs-number">1</span>, <span class="hljs-number">255</span>) <span class="hljs-comment">//ç»™ç¬¬äºŒä¸ªå­—èŠ‚å†™å…¥255ï¼ŒäºŒè¿›åˆ¶æ¯ä¸€ä½éƒ½æ˜¯1</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv.<span class="hljs-title function_">getInt8</span>(<span class="hljs-number">1</span>)) <span class="hljs-comment">//-1 //ç”±äºæ˜¯æœ‰ç¬¦å·çš„è¯»ï¼Œä¼šè¢«å½“åšäºŒè¡¥æ•°ï¼ˆå³åç ï¼‰å¤„ç†ï¼Œå­—èŠ‚å¼€å¤´çš„1è¢«å½“ä½œç¬¦å·ä½</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dv.<span class="hljs-title function_">getUint8</span>(<span class="hljs-number">1</span>)) <span class="hljs-comment">//255 //æ— ç¬¦å·è¯»å–</span><br></code></pre></td></tr></table></figure><p>é™¤äº†ä¸Šè¿°çš„ç±»å‹ï¼ˆ<code>Int8, Uint8, Int16</code>ï¼‰è¿˜æœ‰<code>Uint16,Int32, Uint32, Float32, Float64 </code>ã€‚é»˜è®¤çš„å­—èŠ‚åºä¸ºå¤§ç«¯å­—èŠ‚åºã€‚ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥å†³å®šå­—èŠ‚åºï¼Œä¸º<code>true</code>æ—¶ï¼Œåˆ™å¯ç”¨å°ç«¯å­—èŠ‚åº</p><blockquote><p><code>DataView</code> åªæ”¯æŒä¸¤ç§çº¦å®šï¼šå¤§ç«¯å­—èŠ‚åºå’Œå°ç«¯å­—èŠ‚åºã€‚å¤§ç«¯å­—èŠ‚åºä¹Ÿç§°ä¸ºâ€œç½‘ç»œå­—èŠ‚åºâ€ï¼Œæ„æ€æ˜¯æœ€é«˜æœ‰æ•ˆä½ä¿å­˜åœ¨ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œæœ€ä½æœ‰æ•ˆä½ä¿å­˜åœ¨æœ€åä¸€ä¸ªå­—èŠ‚ã€‚å°ç«¯å­—èŠ‚åºæ­£å¥½ç›¸åï¼Œå³æœ€ä½æœ‰æ•ˆä½ä¿å­˜åœ¨ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œæœ€é«˜æœ‰æ•ˆä½ä¿å­˜åœ¨æœ€åä¸€ä¸ªå­—èŠ‚ã€‚</p></blockquote><p><code>DataView</code>çš„è¯»ã€å†™æ“ä½œéƒ½å¿…é¡»æ»¡è¶³å……è¶³çš„ç¼“å†²åŒºï¼Œå¦‚æœè¶Šç•Œä¼šæŠ›å‡º<code>RangError</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">2</span>)<br><span class="hljs-keyword">const</span> dv = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buf) <span class="hljs-comment">//è¿™é‡Œä¸º2ä¸ªå­—èŠ‚</span><br><span class="hljs-comment">//å°è¯•è¶Šç•Œè¯»å–4ä¸ªå­—èŠ‚</span><br>dv.<span class="hljs-title function_">getInt32</span>(<span class="hljs-number">0</span>) <span class="hljs-comment">//é”™è¯¯ RangeError: Offset is outside the bounds of the DataView</span><br></code></pre></td></tr></table></figure><h2 id="å®šå‹æ•°ç»„"><a href="#å®šå‹æ•°ç»„" class="headerlink" title="å®šå‹æ•°ç»„"></a>å®šå‹æ•°ç»„</h2><p>å®šå‹æ•°ç»„æ˜¯å¦ä¸€ç§å½¢å¼çš„<code>ArrayBffer</code>è§†å›¾ã€‚è®¾è®¡å®šå‹æ•°ç»„çš„ç›®çš„å°±æ˜¯æé«˜ä¸ <code>WebGL</code> ç­‰åŸç”Ÿåº“äº¤æ¢äºŒè¿›åˆ¶æ•°æ®çš„æ•ˆç‡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª12å­—èŠ‚çš„ç¼“å†²</span><br><span class="hljs-keyword">const</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">12</span>)<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªå¼•ç”¨bufç¼“å†²çš„Int32Array</span><br><span class="hljs-keyword">const</span> ints = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>(buf)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints) <span class="hljs-comment">//Int32Array(3) [0, 0, 0]</span><br><span class="hljs-comment">//lengthå±æ€§ï¼Œæ‰“å°é•¿åº¦</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints.<span class="hljs-property">length</span>) <span class="hljs-comment">//3</span><br><span class="hljs-comment">//ä¸DataViewä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸€ä¸ªæŒ‡å‘å…³è”ç¼“å†²çš„å¼•ç”¨</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints.<span class="hljs-property">buffer</span>) <span class="hljs-comment">//ArrayBuffer(12) &#123;&#125;</span><br><br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæŒ‡å®šé•¿åº¦çš„Int32Array</span><br><span class="hljs-keyword">const</span> ints1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>(<span class="hljs-number">6</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints1.<span class="hljs-property">length</span>) <span class="hljs-comment">//6</span><br><br><span class="hljs-comment">//ä¼ å…¥æ•°ç»„åˆå§‹åŒ–Int32Array</span><br><span class="hljs-keyword">const</span> ints2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>])<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints2.<span class="hljs-property">length</span>) <span class="hljs-comment">//4</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints2[<span class="hljs-number">1</span>]) <span class="hljs-comment">//2</span><br><br><span class="hljs-comment">//é€šè¿‡&lt;ElementType&gt;.fromå’Œ&lt;ElementType&gt;.toåˆå§‹åŒ–Int32Array</span><br><span class="hljs-keyword">const</span> ints3 = <span class="hljs-title class_">Int32Array</span>.<span class="hljs-title function_">from</span>(ints2)<br><span class="hljs-keyword">const</span> ints4 = <span class="hljs-title class_">Int32Array</span>.<span class="hljs-title function_">of</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints3.<span class="hljs-property">length</span>) <span class="hljs-comment">//4</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints4.<span class="hljs-property">length</span>) <span class="hljs-comment">//4</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints3[<span class="hljs-number">1</span>]) <span class="hljs-comment">//20</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints4[<span class="hljs-number">1</span>]) <span class="hljs-comment">//20</span><br><br><span class="hljs-comment">//BYTES_PER_ELEMENTå±æ€§è¿”å›ç±»å‹æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å°</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Int32Array</span>.<span class="hljs-property">BYTES_PER_ELEMENT</span>) <span class="hljs-comment">//4</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Float64Array</span>.<span class="hljs-property">BYTES_PER_ELEMENT</span>) <span class="hljs-comment">//8</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ints4.<span class="hljs-property">BYTES_PER_ELEMENT</span>) <span class="hljs-comment">//4</span><br></code></pre></td></tr></table></figure><p>å®šå‹æ•°ç»„æ”¯æŒæ•°ç»„çš„æ–¹æ³•å’Œå±æ€§ï¼ŒåŒ…æ‹¬<code>Symbol.iterator</code>ç¬¦å·å±æ€§ï¼Œä½†æ˜¯æ²¡æœ‰<code>concat(), poop(), push(), shift(), unshift(), splice()</code>ã€‚å®šå‹æ•°ç»„æä¾›äº†ä¸¤ä¸ªæ–¹æ³•å¯ä»¥å®ç°å¤åˆ¶æ•°æ®ï¼š<code>set()</code>å’Œ<code>subarray()</code></p><p><code>set()</code>ä»æä¾›çš„æ•°ç»„æˆ–å®šå‹æ•°ç»„ä¸­æŠŠå€¼å¤åˆ¶åˆ°å½“å‰çš„å®šå‹æ•°ç»„ä¸­æŒ‡å®šç´¢å¼•ä½ç½®</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> container = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int8Array</span>(<span class="hljs-number">8</span>)<br><span class="hljs-comment">//å¤åˆ¶åˆ°ä»åç§»é‡ä¸º2çš„ä½ç½®å¼€å§‹çš„åœ°æ–¹ï¼Œé»˜è®¤åç§»é‡ä¸º0</span><br>container.<span class="hljs-title function_">set</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Int8Array</span>([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]), <span class="hljs-number">2</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(container) <span class="hljs-comment">//[0, 0, 2, 3, 4, 5, 0, 0]</span><br><br><span class="hljs-comment">//æº¢å‡ºä¼šæŠ›å‡ºé”™è¯¯</span><br>container.<span class="hljs-title function_">set</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Int8Array</span>([<span class="hljs-number">3</span>, <span class="hljs-number">4</span>,<span class="hljs-number">5</span>]), <span class="hljs-number">7</span>) <span class="hljs-comment">//é”™è¯¯ RangeError: offset is out of bounds</span><br></code></pre></td></tr></table></figure><p><code>subarray()</code>ä¼šåŸºäºåŸå§‹å®šå‹æ•°ç»„è¿”å›å¤åˆ¶çš„å€¼ç»„æˆæ–°çš„å®šå‹æ•°ç»„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>])<br><span class="hljs-comment">//å¤åˆ¶ç´¢å¼•2åˆ°4ï¼Œå·¦é—­å³å¼€</span><br><span class="hljs-keyword">const</span> newSource = source.<span class="hljs-title function_">subarray</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newSource) <span class="hljs-comment">// [3, 4]</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newSource) <span class="hljs-comment">//Int8Array(2) [3, 4]</span><br></code></pre></td></tr></table></figure><p>é™¤äº†<code>8</code>ç§å…ƒç´ ç±»å‹ï¼Œè¿˜æœ‰ä¸€ç§â€å¤¹æ¿â€œæ•°ç»„ç±»å‹ï¼š<code>Uint8ClampedArray</code>ï¼Œç”¨äºè§£å†³æº¢å‡ºé—®é¢˜ã€‚è¯¥ç±»å‹ä¸å…è®¸ä»»ä½•æ–¹å‘æº¢å‡ºï¼Œè¶…å‡ºæœ€å¤§å€¼<code>255</code>çš„å€¼ä¼šè¢«å‘ä¸‹èˆå…¥ä¸º<code>255</code>ï¼Œè€Œå°äºæœ€å°å€¼<code>0</code>çš„å€¼ä¼šè¢«å‘ä¸Šèˆå…¥ä¸º<code>0</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> clampedInts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8ClampedArray</span>([-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">256</span>])<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clampedInts) <span class="hljs-comment">//[0, 0, 255, 255]</span><br></code></pre></td></tr></table></figure><blockquote><p>é™¤éåšçš„å’Œ<code>canvas</code>ç›¸å…³å¼€å‘ï¼Œå¦åˆ™ä¸è¦ä½¿ç”¨å®ƒ</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä½œç”¨åŸŸå’Œåƒåœ¾æ¸…ç†</title>
    <link href="/2021/03/27/%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%8C%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%92%8C%E5%9E%83%E5%9C%BE%E6%B8%85%E7%90%86/"/>
    <url>/2021/03/27/%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%8C%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%92%8C%E5%9E%83%E5%9C%BE%E6%B8%85%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä½œç”¨åŸŸå’Œåƒåœ¾å›æ”¶"><a href="#æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä½œç”¨åŸŸå’Œåƒåœ¾å›æ”¶" class="headerlink" title="æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä½œç”¨åŸŸå’Œåƒåœ¾å›æ”¶"></a>æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä½œç”¨åŸŸå’Œåƒåœ¾å›æ”¶</h1><p>æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯å½“å‰<code>JavaScript</code>ä»£ç è¢«è§£æå’Œæ‰§è¡Œæ—¶æ‰€åœ¨ç¯å¢ƒçš„æŠ½è±¡æ¦‚å¿µã€‚å˜é‡æˆ–å‡½æ•°çš„ä¸Šä¸‹æ–‡å†³å®šäº†å®ƒä»¬å¯ä»¥è®¿é—®å“ªäº›æ•°æ®ã€‚</p><h2 id="æ‰§è¡Œä¸Šä¸‹æ–‡çš„ç±»å‹"><a href="#æ‰§è¡Œä¸Šä¸‹æ–‡çš„ç±»å‹" class="headerlink" title="æ‰§è¡Œä¸Šä¸‹æ–‡çš„ç±»å‹"></a>æ‰§è¡Œä¸Šä¸‹æ–‡çš„ç±»å‹</h2><p>æ‰§è¡Œä¸Šä¸‹æ–‡åŒ…å«å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ã€å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å’Œ<code>eval</code>æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰</p><p>å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼šæ˜¯æœ€å¤–å±‚çš„ä¸Šä¸‹æ–‡ï¼Œåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­å°±æ˜¯å…¨å±€å¯¹è±¡<code>window</code>ï¼Œ<code>this</code>æŒ‡å‘è¿™ä¸ªå…¨å±€å¯¹è±¡ã€‚å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ä»…æ­¤ä¸€ä¸ª</p><p>å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ï¼šå½“å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å¹¶æ¨åˆ°ä¸€ä¸ªä¸Šä¸‹æ–‡æ ˆï¼Œç­‰åˆ°å‡½æ•°æ‰§è¡Œå®Œï¼Œä¸Šä¸‹æ–‡æ ˆä¼šå¼¹å‡ºè¯¥å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚å¯ä»¥å­˜åœ¨æ— æ•°ä¸ªï¼Œä¸”æ¯æ¬¡è°ƒç”¨åˆ›å»ºçš„æ˜¯ä¸€ä¸ªæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡</p><p><code>eval</code>å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ï¼šæŒ‡çš„æ˜¯è¿è¡Œåœ¨<code>eval</code>å‡½æ•°ä¸­çš„ä»£ç </p><blockquote><ul><li><p>æ‰€æœ‰é€šè¿‡<code>var</code>å®šä¹‰çš„å…¨å±€å˜é‡å’Œå‡½æ•°éƒ½ä¼šæˆä¸º<code>window</code>å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ã€‚ä½¿ç”¨<code>let</code>å’Œ<code>const</code>çš„é¡¶çº§å£°æ˜ä¸ä¼šå®šä¹‰åœ¨å…¨å±€ä¸Šä¸‹æ–‡ä¸­</p></li><li><p>ä¸Šä¸‹æ–‡åœ¨å…¶æ‰€æœ‰ä»£ç éƒ½æ‰§è¡Œå®Œæ¯•åä¼šè¢«é”€æ¯</p></li></ul></blockquote><p>æ‰§è¡Œæ ˆä¹Ÿå«è°ƒç”¨æ ˆï¼Œå…·æœ‰<code>LIFO</code>ï¼ˆåè¿›å…ˆå‡ºï¼‰ç»“æ„ï¼Œç”¨äºå­˜å‚¨åœ¨ä»£ç æ‰§è¡ŒæœŸé—´åˆ›å»ºçš„æ‰§è¡Œä¸Šä¸‹æ–‡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> scope = <span class="hljs-string">&#x27;local scope&#x27;</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test1</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">let</span> scope = <span class="hljs-string">&#x27;local scope&#x27;</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"></span>)&#123;<br><span class="hljs-keyword">return</span> scope<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>()<br>&#125;<br><span class="hljs-title function_">test1</span>() <span class="hljs-comment">//å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å…¥æ ˆ =&gt; test1å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å…¥æ ˆ =&gt; fnå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å…¥æ ˆ =&gt; æ‰§è¡Œå®Œfnå‡½æ•°ï¼Œfnå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆ =&gt; test1å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆ =&gt; å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆ</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test2</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">let</span> scope = <span class="hljs-string">&#x27;local scope&#x27;</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">return</span> scope<br>&#125;<br><span class="hljs-keyword">return</span> fn<br>&#125;<br><span class="hljs-title function_">test2</span>()() <span class="hljs-comment">//å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å…¥æ ˆ =&gt; test2å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å…¥æ ˆ =&gt; test2å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆ =&gt; fnå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å…¥æ ˆ =&gt; fnå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆ  =&gt; å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆ</span><br><br><span class="hljs-comment">//æ‰§è¡Œç»“æœéƒ½ä¸€æ ·ï¼Œä½†æ˜¯æ‰§è¡Œä¸Šä¸‹æ–‡æ ˆå˜åŒ–ä¸ä¸€æ ·</span><br></code></pre></td></tr></table></figure><h2 id="ä½œç”¨åŸŸ"><a href="#ä½œç”¨åŸŸ" class="headerlink" title="ä½œç”¨åŸŸ"></a>ä½œç”¨åŸŸ</h2><p>å½“æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„ä»£ç åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šåˆ›å»ºå˜é‡å¯¹è±¡çš„ä¸€ä¸ªä½œç”¨åŸŸé“¾ã€‚è¿™ä¸ªä½œç”¨åŸŸé“¾å†³å®šäº†å„çº§ä¸Šä¸‹æ–‡æ‰€èƒ½è®¿é—®åˆ°çš„å˜é‡å’Œå‡½æ•°é¡ºåºã€‚å¤„åœ¨ä½œç”¨åŸŸé¡¶ç«¯çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå«åšæ´»åŠ¨å¯¹è±¡ã€‚æ´»åŠ¨å¯¹è±¡æœ€åˆåªç”¨<code>arguments</code>ã€‚ä½œç”¨åŸŸé“¾çš„ä¸­çš„ä¸‹ä¸€ä¸ªå˜é‡å¯¹è±¡æ¥è‡ªäºåŒ…å«ä¸Šä¸‹æ–‡ï¼Œå†ä¸‹ä¸€ä¸ªæ¥è‡ªäºåœ¨ä¸‹ä¸€ä¸ªåŒ…å«ä¸Šä¸‹æ–‡ã€‚å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡å§‹ç»ˆæ˜¯ä½œç”¨åŸŸé“¾çš„æœ€åä¸€ä¸ªå˜é‡å¯¹è±¡ã€‚</p><h2 id="åƒåœ¾å›æ”¶"><a href="#åƒåœ¾å›æ”¶" class="headerlink" title="åƒåœ¾å›æ”¶"></a>åƒåœ¾å›æ”¶</h2><p>åƒåœ¾å›æ”¶æœ‰ä¸¤ç§ç­–ç•¥ï¼Œæ ‡è®°æ¸…é™¤æ³•å’Œå¼•ç”¨è®¡æ•°æ³•ã€‚ç°é˜¶æ®µæµè§ˆå™¨ä½¿ç”¨çš„å¤šä¸ºæ ‡è®°æ¸…æ¥šæ³•ã€‚<br>å¼•ç”¨è®¡æ•°æ— æ³•æ¸…é™¤å¾ªç¯å¼•ç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">problem</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">let</span> objectA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>()<br><span class="hljs-keyword">let</span> objectB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>()<br><br>objectA.<span class="hljs-property">someOtherObject</span> = objectB<br>objectB.<span class="hljs-property">anotherObject</span> = objectA<br>&#125;<br><span class="hljs-comment">//objectAå’ŒobjectBé€šè¿‡å„è‡ªçš„å±æ€§ç›¸äº’å¼•ç”¨ï¼Œæ„å‘³ç€å¼•ç”¨æ•°å§‹ç»ˆéƒ½ä¸º2</span><br></code></pre></td></tr></table></figure><h2 id="å†…å­˜æ³„æ¼"><a href="#å†…å­˜æ³„æ¼" class="headerlink" title="å†…å­˜æ³„æ¼"></a>å†…å­˜æ³„æ¼</h2><ul><li>ç¼ºå°‘å£°æ˜å…³é”®å­—å¯¼è‡´çš„å†…å­˜æ³„æ¼</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br>  name = <span class="hljs-string">&#x27;yxlazy&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“è°ƒç”¨<code>test()</code>æ—¶ï¼Œä¼šåœ¨å…¨å±€å¯¹è±¡<code>window</code>ä¸Šæ·»åŠ <code>name</code>å±æ€§å¯¼è‡´å†…å­˜æ³„æ¼ï¼Œåªè¦<code>window</code>ä¸è¢«æ¸…ç†å°±ä¸ä¼šæ¶ˆå¤±</p><ul><li>å®šæ—¶å™¨å¯¼è‡´çš„å†…å­˜æ³„æ¼</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> name = <span class="hljs-string">&#x27;yxlazy&#x27;</span><br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name)<br>&#125;, <span class="hljs-number">1000</span>)<br></code></pre></td></tr></table></figure><p>å®šæ—¶å™¨çš„å›è°ƒé€šè¿‡é—­åŒ…å¼•ç”¨äº†å¤–éƒ¨å˜é‡ã€‚åªè¦å®šæ—¶å™¨ä¸€ç›´è¿è¡Œï¼Œå›è°ƒå‡½æ•°ä¸­å¼•ç”¨çš„<code>name</code>å°±ä¼šä¸€ç›´å ç”¨å†…å­˜</p><ul><li>ä½¿ç”¨<code>JavaScript</code>é—­åŒ…é€ æˆçš„å†…å­˜æ³„æ¼</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> outer = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> name = <span class="hljs-string">&#x27;yxlazy&#x27;</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> name<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>outer()</code>ä¼šå¯¼è‡´åˆ†é…ç»™<code>name</code>çš„å†…å­˜è¢«æ³„æ¼</p>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>var, let, constè¯¦è§£</title>
    <link href="/2021/03/21/var-let-const%E8%AF%A6%E8%A7%A3/"/>
    <url>/2021/03/21/var-let-const%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="var-let-const-å£°æ˜å˜é‡è¯¦è§£"><a href="#var-let-const-å£°æ˜å˜é‡è¯¦è§£" class="headerlink" title="var, let, const å£°æ˜å˜é‡è¯¦è§£"></a>var, let, const å£°æ˜å˜é‡è¯¦è§£</h1><p><code>var</code> æ˜¯<code>ES6</code>ä¹‹å‰ç”¨æ¥å£°æ˜å˜é‡çš„å…³é”®å­—ï¼Œè€Œ<code>let</code>å’Œ<code>const</code>æ˜¯<code>ES6</code>ä¹‹åçš„ç‰ˆæœ¬å‡ºç°çš„ã€‚<code>let</code>å’Œ<code>const</code>æ˜¯ä¸ºäº†è§£å†³<code>var</code>å¸¦æ¥çš„å¾—æ€ªå¼‚è¡Œä¸ºã€‚</p><h2 id="var-å£°æ˜"><a href="#var-å£°æ˜" class="headerlink" title="var å£°æ˜"></a>var å£°æ˜</h2><p><code>var</code>å£°æ˜çš„å˜é‡å­˜åœ¨å˜é‡<strong>æå‡ï¼ˆhoist</strong>ï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a)<br>    <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span><br>&#125;<br><span class="hljs-title function_">test</span>() <span class="hljs-comment">//undefined</span><br></code></pre></td></tr></table></figure><p><code>var</code>å£°æ˜çš„å˜é‡ä¼šå…ˆå°†å˜é‡<code>a</code>æå‡åˆ°ä½œç”¨åŸŸçš„é¡¶éƒ¨ï¼ˆåœ¨è¿™é‡Œæ˜¯<code>test</code>å‡½æ•°ä½œç”¨åŸŸ)ï¼Œå¹¶åˆå§‹åŒ–ä¸º<code>undefined</code>ï¼Œç„¶åç­‰åˆ°æ‰§è¡Œ<code>var a = 10</code> æ‰çœŸæ­£è¿›è¡Œå˜é‡çš„èµ‹å€¼ï¼Œå…¶å®ç°è¿‡ç¨‹ç›¸å½“äº</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> a = <span class="hljs-literal">undefined</span> <span class="hljs-comment">//å˜é‡æå‡åˆ°ä½œç”¨åŸŸé¡¶éƒ¨ï¼Œå¹¶åˆå§‹åŒ–ä¸ºundefined</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a)<br>    a = <span class="hljs-number">10</span><br>&#125;<br><span class="hljs-title function_">test</span>() <span class="hljs-comment">//undefined</span><br></code></pre></td></tr></table></figure><p>å¦‚æœåœ¨å‡½æ•°å†…éƒ¨å£°æ˜çš„å˜é‡æ²¡æœ‰åŠ å…³é”®å­—ï¼Œåˆ™å£°æ˜çš„å˜é‡ä¼šè¢«åˆ›å»ºåœ¨å…¨å±€ä½œç”¨åŸŸ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> a = <span class="hljs-number">10</span>;<br>    b = <span class="hljs-string">&#x27;no var&#x27;</span><br>&#125;<br><span class="hljs-title function_">test</span>() <span class="hljs-comment">//undefined</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">//æŠ¥é”™ ReferenceError: a is not defined</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b) <span class="hljs-comment">//æ­£å¸¸è¾“å‡º no var</span><br></code></pre></td></tr></table></figure><p>åå¤å¤šæ¬¡ä½¿ç”¨<code>var</code>å£°æ˜åŒä¸€ä¸ªå˜é‡ä¹Ÿæ²¡æœ‰é—®é¢˜</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) &#123;<br>     <span class="hljs-keyword">var</span> age = <span class="hljs-number">16</span>;<br>     <span class="hljs-keyword">var</span> age = <span class="hljs-number">26</span>;<br>     <span class="hljs-keyword">var</span> age = <span class="hljs-number">36</span>;<br>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <br>&#125;<br><span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 36  </span><br><span class="hljs-comment">//å¼•æ“ä¼šå°†æ‰€æœ‰å£°æ˜çš„å˜é‡æå‡ï¼Œåˆå¹¶ä¸ºä¸€ä¸ªå£°æ˜ï¼Œç›¸å½“äº</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">var</span> age = <span class="hljs-literal">undefined</span><br>     age = <span class="hljs-number">16</span>;<br>     age = <span class="hljs-number">26</span>;<br>     age = <span class="hljs-number">36</span>;<br>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="let-å’Œ-const-å£°æ˜"><a href="#let-å’Œ-const-å£°æ˜" class="headerlink" title="let å’Œ const å£°æ˜"></a>let å’Œ const å£°æ˜</h2><p><code>let</code> å’Œ <code>const</code> å£°æ˜çš„èŒƒå›´æ˜¯å—ä½œç”¨åŸŸï¼Œè€Œ<code>var</code> å£°æ˜çš„èŒƒå›´æ˜¯å‡½æ•°ä½œç”¨åŸŸã€‚ä¸<code>let</code>ä¸åŒï¼Œ<code>const</code>åœ¨å£°æ˜æ—¶å¿…é¡»åˆå§‹åŒ–ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//varå‡½æ•°ä½œç”¨åŸŸ</span><br><span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-keyword">var</span> a = <span class="hljs-string">&#x27;å‡½æ•°ä½œç”¨åŸŸ&#x27;</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">//å‡½æ•°ä½œç”¨åŸŸ</span><br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">//å‡½æ•°ä½œç”¨åŸŸ</span><br><br><span class="hljs-comment">//letå’Œconstå—ä½œç”¨åŸŸ</span><br><span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-keyword">let</span> a = <span class="hljs-string">&#x27;let å—ä½œç”¨åŸŸ&#x27;</span><br>    <span class="hljs-keyword">const</span> b = <span class="hljs-string">&#x27;const å—ä½œç”¨åŸŸ&#x27;</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">//let å—ä½œç”¨åŸŸ</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b) <span class="hljs-comment">//const å—ä½œç”¨åŸŸ</span><br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">//æŠ¥é”™ ReferenceError: a is not defined</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b) <span class="hljs-comment">//æŠ¥é”™ ReferenceError: b is not defined</span><br></code></pre></td></tr></table></figure><p>å—ä½œç”¨åŸŸæ˜¯å‡½æ•°ä½œç”¨åŸŸçš„å­é›†ï¼Œå› æ­¤é€‚ç”¨äº<code>var</code>çš„ä½œç”¨åŸŸé™åˆ¶åŒæ ·ä¹Ÿé€‚ç”¨äº<code>let</code></p><p>ä¸<code>var</code>å£°æ˜ä¸åŒï¼Œ<code>let</code>å’Œ<code>const</code>ä¸å…è®¸åŒä¸€ä¸ªå—ä½œç”¨åŸŸå‡ºç°å†—ä½™å£°æ˜</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> name;<br><span class="hljs-keyword">var</span> name;<br><br><span class="hljs-keyword">let</span> age;<br><span class="hljs-keyword">let</span> age; <span class="hljs-comment">//æŠ¥é”™ SyntaxError: Identifier &#x27;age&#x27; has already been declared</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å¯¹äºåœ¨ä¸åŒä½œç”¨åŸŸä¸­ä½¿ç”¨<code>let</code>å’Œ<code>const</code>å£°æ˜æ˜¯å…è®¸çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> name = <span class="hljs-string">&#x27;name&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-keyword">let</span> name = <span class="hljs-string">&#x27;another name&#x27;</span>; <span class="hljs-comment">//ä¸ä¼šæŠ¥é”™ï¼Œä¸”ä¸¤è€…æ˜¯ä¸åŒçš„</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸­ï¼Œæ··åˆä½¿ç”¨<code>let</code>å’Œ<code>var</code>å£°æ˜åŒä¸€ä¸ªå˜é‡ä¹Ÿæ˜¯ä¸å…è®¸çš„</p><p>letå’Œconstå£°æ˜çš„å˜é‡ä¸å­˜åœ¨å˜é‡æå‡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">//æŠ¥é”™ ReferenceError: a is not defined</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">//æŠ¥é”™ ReferenceError: Cannot access &#x27;b&#x27; before initialization</span><br><br><span class="hljs-keyword">let</span> a;<br><span class="hljs-keyword">const</span> b = <span class="hljs-string">&#x27;const å£°æ˜çš„åŒæ—¶å¿…é¡»åˆå§‹åŒ–&#x27;</span>;<br><br><span class="hljs-comment">//ä½¿ç”¨let å’Œ const å£°æ˜çš„å˜é‡ï¼Œåœ¨æ‰§è¡Œåˆ°å£°æ˜è¯­å¥ä¹‹å‰ï¼Œä¼šå‡ºç°â€œæš‚æ—¶æ€§æ­»åŒºâ€ï¼Œåœ¨æ­¤é˜¶æ®µå¼•ç”¨ä»»ä½•åé¢æ‰å£°æ˜çš„å˜é‡éƒ½ä¼šæŠ›å‡º ReferenceError</span><br></code></pre></td></tr></table></figure><p>åœ¨å…¨å±€ä½œç”¨åŸŸä¸‹ä½¿ç”¨<code>let</code>å£°æ˜çš„å˜é‡ä¸ä¼šæˆä¸º<code>window</code>å¯¹è±¡çš„å±æ€§ï¼Œä½†<code>var</code>å£°æ˜çš„å˜é‡åˆ™ä¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> name = <span class="hljs-string">&#x27;Matt&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// &#x27;Matt&#x27;</span><br><span class="hljs-keyword">let</span> age = <span class="hljs-number">26</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">age</span>); <span class="hljs-comment">// undefined </span><br></code></pre></td></tr></table></figure><p>constå£°æ˜çš„å˜é‡åªé€‚ç”¨äºå®ƒæŒ‡å‘çš„å˜é‡çš„å¼•ç”¨ï¼Œå³å¼•ç”¨ä¸å¯å˜ã€‚å¦‚æœå£°æ˜çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™å¯¹è±¡çš„å±æ€§æ˜¯å¯ä»¥æ›´æ”¹çš„ï¼Œä½†å¼•ç”¨ä¸èƒ½æ›´æ”¹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> name = <span class="hljs-string">&#x27;æˆ‘ä¸å¯æ›´æ”¹&#x27;</span>;<br><span class="hljs-keyword">const</span>  another = &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;æˆ‘æ˜¯å¯ä»¥å˜çš„&#x27;</span><br>&#125;<br><br>name = <span class="hljs-string">&#x27;æˆ‘è¯´äº†ï¼Œæˆ‘æ˜¯ä¸å¯å˜çš„&#x27;</span>; <span class="hljs-comment">//æŠ¥é”™ TypeError: Assignment to constant variable.</span><br><br>another = <span class="hljs-string">&#x27;æˆ‘å£°æ˜æ—¶ä¿å­˜çš„æ˜¯å¼•ç”¨ï¼Œå¼•ç”¨ä¹Ÿä¸èƒ½å˜çš„&#x27;</span>; <span class="hljs-comment">//æŠ¥é”™ TypeError: Assignment to constant variable.</span><br>another.<span class="hljs-property">name</span> = <span class="hljs-string">&#x27;æˆ‘æ‰æ˜¯è‡ªç”±çš„&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(another) <br><span class="hljs-comment">//è¾“å‡º</span><br><span class="hljs-comment">//&#123;</span><br><span class="hljs-comment">//    &quot;name&quot;: &quot;æˆ‘æ‰æ˜¯è‡ªç”±çš„&quot;</span><br><span class="hljs-comment">//&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å•è¡Œæ–‡æœ¬æº¢å‡ºå’Œå¤šè¡Œæ–‡æœ¬æº¢å‡ºå¤„ç†</title>
    <link href="/2021/03/10/%E5%8D%95%E8%A1%8C%E6%96%87%E6%9C%AC%E6%BA%A2%E5%87%BA%E5%92%8C%E5%A4%9A%E8%A1%8C%E6%96%87%E6%9C%AC%E6%BA%A2%E5%87%BA%E5%A4%84%E7%90%86/"/>
    <url>/2021/03/10/%E5%8D%95%E8%A1%8C%E6%96%87%E6%9C%AC%E6%BA%A2%E5%87%BA%E5%92%8C%E5%A4%9A%E8%A1%8C%E6%96%87%E6%9C%AC%E6%BA%A2%E5%87%BA%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="å•è¡Œæ–‡æœ¬æº¢å‡ºå’Œå¤šè¡Œæ–‡æœ¬æº¢å‡º"><a href="#å•è¡Œæ–‡æœ¬æº¢å‡ºå’Œå¤šè¡Œæ–‡æœ¬æº¢å‡º" class="headerlink" title="å•è¡Œæ–‡æœ¬æº¢å‡ºå’Œå¤šè¡Œæ–‡æœ¬æº¢å‡º"></a>å•è¡Œæ–‡æœ¬æº¢å‡ºå’Œå¤šè¡Œæ–‡æœ¬æº¢å‡º</h1><p>å½“æ–‡æœ¬å¤ªé•¿ï¼Œæ€»æ˜¯ä¼šæƒ³æ€ä¹ˆä¼˜é›…çš„çœç•¥å¤šä½™çš„éƒ¨åˆ†ï¼Œæ—¢ç¾è§‚åˆå¥½çœ‹ï¼Œå› æ­¤è¯•ç€å°è¯•æ–‡æœ¬æº¢å‡ºå¤„ç†æ¥è§£å†³ã€‚</p><p>æ³¨ï¼šä»¥ä¸‹ä¸º <code>...</code> æ ¼å¼çš„æº¢å‡ºä»£ç </p><h2 id="å•è¡Œæ–‡æœ¬æº¢å‡º"><a href="#å•è¡Œæ–‡æœ¬æº¢å‡º" class="headerlink" title="å•è¡Œæ–‡æœ¬æº¢å‡º"></a>å•è¡Œæ–‡æœ¬æº¢å‡º</h2><p>å•è¡Œæ–‡æœ¬æº¢å‡ºéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.overflow</span>&#123;<br>  <span class="hljs-attribute">overflow</span>: hidden;<br>  <span class="hljs-attribute">text-overflow</span>: ellipsis;<br>  <span class="hljs-attribute">white-space</span>: nowrap;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¤šè¡Œæ–‡æœ¬æº¢å‡º"><a href="#å¤šè¡Œæ–‡æœ¬æº¢å‡º" class="headerlink" title="å¤šè¡Œæ–‡æœ¬æº¢å‡º"></a>å¤šè¡Œæ–‡æœ¬æº¢å‡º</h2><p>å¤šè¡Œæ–‡æœ¬æº¢å‡ºå¹¶ä¸æ˜¯CSSè§„èŒƒè‰æ¡ˆï¼Œæ˜¯webkitçš„ç§æœ‰å±æ€§ï¼Œæ»¡è¶³æ¡ä»¶</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.overflow</span> &#123;<br>  <span class="hljs-attribute">display</span>: -webkit-box;<br>  -webkit-line-clamp: <span class="hljs-number">2</span>;<br>  -webkit-box-orient: vertical;<br>  <span class="hljs-attribute">overflow</span>: hidden;<br>  <span class="hljs-attribute">text-overflow</span>: ellipsis;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>-webkit-line-clamp</code>  ç”¨æ¥é™åˆ¶åœ¨ä¸€ä¸ªå—å…ƒç´ æ˜¾ç¤ºçš„æ–‡æœ¬çš„è¡Œæ•°</p><p><code>display: -webkit-box</code> å¿…é¡»ç»“åˆçš„å±æ€§ ï¼Œå°†å¯¹è±¡ä½œä¸ºå¼¹æ€§ä¼¸ç¼©ç›’å­æ¨¡å‹æ˜¾ç¤º</p><p><code>-webkit-box-orient</code> å¿…é¡»ç»“åˆçš„å±æ€§ ï¼Œè®¾ç½®æˆ–æ£€ç´¢ä¼¸ç¼©ç›’å¯¹è±¡çš„å­å…ƒç´ çš„æ’åˆ—æ–¹å¼</p>]]></content>
    
    
    <categories>
      
      <category>css</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡</title>
    <link href="/2021/03/05/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%BB%9A%E5%8A%A8%E6%9D%A1/"/>
    <url>/2021/03/05/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%BB%9A%E5%8A%A8%E6%9D%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡"><a href="#æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡" class="headerlink" title="æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡"></a>æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡</h1><p>å¾ˆå¤šæ—¶å€™ï¼Œç³»ç»Ÿè‡ªå¸¦çš„æ•ˆæœæ€»æ˜¯ä¸‘çš„ä¸è¡Œï¼Œä¾‹å¦‚æ»šåŠ¨æ¡ã€‚å½“å†…å®¹è¶…å‡ºå®¹å™¨æ—¶ï¼Œå°±ä¼šå‡ºç°æ»šåŠ¨æ¡ï¼ˆæ°´å¹³æˆ–å‚ç›´ï¼‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç”¨cssæ¥å¹²æ‰è¿™ä¸ªç³»ç»ŸåŸå§‹çš„æ»šåŠ¨æ¡ã€‚</p><p>æ»šåŠ¨æ¡æ ·å¼ä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>::-webkit-scrollbarå®šä¹‰æ»šåŠ¨æ¡æ•´ä½“çš„æ ·å¼</li><li>::-webkit-scrollbar-thumb æ»‘å—éƒ¨åˆ†</li><li>::-webkit-scrollbar-track  è½¨é“éƒ¨åˆ†</li></ul><p>è®¾ç½®æ»šåŠ¨æ¡å®½é«˜</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">::-webkit-scrollbar &#123;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¾ç½®æ»‘å—æ ·å¼</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">::-webkit-scrollbar-thumb &#123;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);<br>  -webkit-<span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);<br>  <span class="hljs-attribute">background</span>: <span class="hljs-number">#535353</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¾ç½®è½¨é“æ ·å¼</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">::-webkit-scrollbar-track &#123;<br>  <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);<br>  -webkit-<span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-number">#EDEDED</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¦‚æœéœ€è¦ç”¨åˆ°è‡ªå®šä¹‰çš„å®¹å™¨ä¸­"><a href="#å¦‚æœéœ€è¦ç”¨åˆ°è‡ªå®šä¹‰çš„å®¹å™¨ä¸­" class="headerlink" title="å¦‚æœéœ€è¦ç”¨åˆ°è‡ªå®šä¹‰çš„å®¹å™¨ä¸­"></a>å¦‚æœéœ€è¦ç”¨åˆ°è‡ªå®šä¹‰çš„å®¹å™¨ä¸­</h2><p>htmlç¤ºä¾‹ä»£ç </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>è‡ªå®šä¹‰å®¹å™¨<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>è‡ªå®šä¹‰å®¹å™¨<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure><p>cssç¤ºä¾‹ä»£ç </p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">ul</span> &#123;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;<br>    <span class="hljs-attribute">overflow-y</span>: auto; //auto å½“å®¹å™¨å†…å®¹æ²¡æœ‰è¶…è¿‡è®¾å®šçš„é«˜åº¦æ—¶ï¼Œä¸ä¼šå‡ºç°æ»šåŠ¨æ¡ scroll ä¸ç®¡æœ‰æ— å†…å®¹éƒ½ä¼šå‡ºç°æ»šåŠ¨æ¡ <br>    <span class="hljs-attribute">overflow-x</span>: hidden //è¿™é‡Œæˆ‘éšè—äº†æ°´å¹³ä¸Šçš„æ»šåŠ¨æ¡<br>&#125;<br>//è®¾ç½®æ»šåŠ¨æ¡å®½é«˜<br><span class="hljs-selector-tag">ul</span>::-webkit-scrollbar &#123;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">380px</span>;<br>&#125;<br>//è®¾ç½®æ»‘å—æ ·å¼<br><span class="hljs-selector-tag">ul</span>::-webkit-scrollbar-thumb &#123;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);<br>  -webkit-<span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);<br>  <span class="hljs-attribute">background</span>: <span class="hljs-number">#535353</span>;<br>&#125;<br>//è®¾ç½®è½¨é“æ ·å¼<br><span class="hljs-selector-tag">ul</span>::-webkit-scrollbar-track &#123;<br>  <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);<br>  -webkit-<span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-number">#EDEDED</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æ•ˆæœå±•ç¤º</p><p><img src="/2021/03/05/%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%BB%9A%E5%8A%A8%E6%9D%A1/self-define-scroller.png"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/lfhy/p/6796653.html">CSS3è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ -webkit-scrollbar</a></p>]]></content>
    
    
    <categories>
      
      <category>css</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
    </tags>
    
  </entry>
  
  
  
  
  
  
  <entry>
    <title>about</title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[]]></content>
    
  </entry>
  
  
  
</search>
